---
// ============================================
// PAYMENT SUCCESS PAGE
// ============================================

import BaseLayout from '@/layouts/BaseLayout.astro';
import { stripe } from '@/lib/stripe';
import { getCreditsForPack } from '@/lib/ai-credits-config';

// R√©cup√©rer les informations de la session si disponibles
const sessionId = Astro.url.searchParams.get('session_id');

// R√©cup√©rer les d√©tails de la session Stripe
let sessionData: {
  type?: 'subscription' | 'credit_pack';
  plan?: string;
  billing?: string;
  packType?: string;
  credits?: number;
  amount?: number;
} | null = null;

if (sessionId) {
  try {
    // R√©cup√©rer directement la session Stripe c√¥t√© serveur
    const session = await stripe.checkout.sessions.retrieve(sessionId);
    
    // D√©terminer le type d'achat depuis les metadata
    const purchaseType = session.metadata?.type || 'subscription';
    const packType = session.metadata?.pack_type;

    sessionData = {
      type: purchaseType as 'subscription' | 'credit_pack',
    };

    if (purchaseType === 'credit_pack' && packType) {
      // C'est un achat de pack de cr√©dits
      sessionData.packType = packType;
      sessionData.credits = getCreditsForPack(packType as 'starter' | 'standard' | 'pro');
      sessionData.amount = session.amount_total ? session.amount_total / 100 : undefined;
    } else {
      // C'est un abonnement
      sessionData.plan = session.metadata?.plan;
      sessionData.billing = session.metadata?.billing;
      sessionData.amount = session.amount_total ? session.amount_total / 100 : undefined;
    }
  } catch (error) {
    console.error('Error retrieving Stripe session:', error);
  }
}

const isCreditPack = sessionData?.type === 'credit_pack';
const packTypeNames: Record<string, string> = {
  starter: 'Pack Starter',
  standard: 'Pack Standard',
  pro: 'Pack Pro',
};
---

<BaseLayout title="Paiement r√©ussi" description="Votre paiement a √©t√© accept√©">
  <main class="payment-page">
    {isCreditPack ? (
      <!-- Page de succ√®s pour achat de cr√©dits IA -->
      <div class="payment-card payment-card--success">
        <div class="payment-card__icon">‚ú®</div>
        
        <h1 class="payment-card__title">Cr√©dits IA achet√©s !</h1>
        
        <p class="payment-card__message">
          Merci pour votre achat ! Vos cr√©dits bonus ont √©t√© ajout√©s √† votre compte.
        </p>

        <div class="payment-card__credits-info">
          <div class="payment-card__credits-amount">
            <span class="payment-card__credits-number">{sessionData?.credits || 0}</span>
            <span class="payment-card__credits-label">cr√©dits IA</span>
          </div>
          {sessionData?.packType && (
            <p class="payment-card__pack-name">
              {packTypeNames[sessionData.packType] || sessionData.packType}
            </p>
          )}
        </div>

        <div class="payment-card__details">
          <div class="payment-card__feature">
            <span class="payment-card__feature-icon">‚úì</span>
            Cr√©dits disponibles imm√©diatement
          </div>
          <div class="payment-card__feature">
            <span class="payment-card__feature-icon">‚úì</span>
            Ne se p√©riment jamais
          </div>
          <div class="payment-card__feature">
            <span class="payment-card__feature-icon">‚úì</span>
            Utilis√©s en priorit√© avant votre quota mensuel
          </div>
        </div>

        <div class="payment-card__actions">
          <a href="/quiz" class="btn btn--primary btn--lg">
            üéÆ G√©n√©rer un quiz
          </a>
          <a href="/profile" class="btn btn--outline">
            üë§ Voir mes cr√©dits
          </a>
        </div>

        <p class="payment-card__note">
          Un email de confirmation vous a √©t√© envoy√©.
          <br/>
          Vous pouvez voir vos cr√©dits restants dans votre profil.
        </p>
      </div>
    ) : (
      <!-- Page de succ√®s pour abonnement -->
      <div class="payment-card payment-card--success">
        <div class="payment-card__icon">üéâ</div>
        
        <h1 class="payment-card__title">Paiement r√©ussi !</h1>
        
        <p class="payment-card__message">
          Merci pour votre confiance ! Votre abonnement est maintenant actif.
        </p>

        <div class="payment-card__details">
          <div class="payment-card__feature">
            <span class="payment-card__feature-icon">‚úì</span>
            Acc√®s imm√©diat √† toutes les fonctionnalit√©s
          </div>
          <div class="payment-card__feature">
            <span class="payment-card__feature-icon">‚úì</span>
            Quiz IA d√©bloqu√©s
          </div>
          <div class="payment-card__feature">
            <span class="payment-card__feature-icon">‚úì</span>
            Acc√®s aux duels multijoueur
          </div>
        </div>

        <div class="payment-card__actions">
          <a href="/" class="btn btn--primary btn--lg">
            üéÆ Jouer maintenant
          </a>
          <a href="/profile" class="btn btn--outline">
            üë§ Voir mon profil
          </a>
        </div>

        <p class="payment-card__note">
          Un email de confirmation vous a √©t√© envoy√©.
          <br/>
          Vous pouvez g√©rer votre abonnement depuis votre profil.
        </p>
      </div>
    )}

    <!-- Confetti Animation -->
    <div class="confetti" id="confetti"></div>
  </main>
</BaseLayout>

<script>
  // Simple confetti effect
  function createConfetti() {
    const confettiContainer = document.getElementById('confetti');
    if (!confettiContainer) return;

    const colors = ['#7c3aed', '#4f46e5', '#0ea5e9', '#ec4899', '#facc15', '#22c55e'];
    
    for (let i = 0; i < 50; i++) {
      const confetti = document.createElement('div');
      confetti.className = 'confetti-piece';
      confetti.style.left = Math.random() * 100 + '%';
      confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
      confetti.style.animationDuration = (Math.random() * 3 + 2) + 's';
      confetti.style.animationDelay = Math.random() * 2 + 's';
      confettiContainer.appendChild(confetti);
    }

    // Clean up after animation
    setTimeout(() => {
      confettiContainer.innerHTML = '';
    }, 6000);
  }

  createConfetti();
</script>
