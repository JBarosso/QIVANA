---
// ============================================
// LEADERBOARD PAGE (Par Univers)
// ============================================

import BaseLayout from '../../layouts/BaseLayout.astro';
import { createServerClient } from '@supabase/ssr';
import type { Database } from '../../types/supabase';
import type { Universe } from '../../types';

const supabase = createServerClient(
  import.meta.env.PUBLIC_SUPABASE_URL,
  import.meta.env.PUBLIC_SUPABASE_ANON_KEY,
  {
    cookies: {
      get(key) {
        return Astro.cookies.get(key)?.value;
      },
      set(key, value, options) {
        Astro.cookies.set(key, value, options);
      },
      remove(key, options) {
        Astro.cookies.delete(key, options);
      },
    },
  }
);

const universes: { value: Universe; label: string; emoji: string }[] = [
  { value: 'anime', label: 'Anime', emoji: 'üéå' },
  { value: 'manga', label: 'Manga', emoji: 'üìö' },
  { value: 'comics', label: 'Comics', emoji: 'ü¶∏' },
  { value: 'games', label: 'Jeux Vid√©o', emoji: 'üéÆ' },
  { value: 'movies', label: 'Films', emoji: 'üé¨' },
  { value: 'series', label: 'S√©ries', emoji: 'üì∫' },
  { value: 'other', label: 'Autre', emoji: 'üåü' },
];

// R√©cup√©rer l'univers depuis l'URL (d√©faut: anime)
const selectedUniverse = (Astro.url.searchParams.get('universe') as Universe) || 'anime';

// R√©cup√©rer le classement bas√© uniquement sur les quiz solo
// Calculer le score des quiz solo depuis quiz_sessions
const { data: quizScores, error: quizScoresError } = await supabase
  .from('quiz_sessions')
  .select('user_id, score, universe')
  .not('completed_at', 'is', null)
  .eq('universe', selectedUniverse); // Filtrer par univers

// Agr√©ger les scores par utilisateur pour cet univers
const userScores = new Map<string, number>();
if (quizScores) {
  for (const session of quizScores) {
    const currentScore = userScores.get(session.user_id) || 0;
    userScores.set(session.user_id, currentScore + (session.score || 0));
  }
}

// R√©cup√©rer les profils et ajouter leur score de quiz solo pour cet univers
const { data: allProfiles, error } = await supabase
  .from('profiles')
  .select('id, pseudo, plan, slug, selected_avatar_id');

// R√©cup√©rer tous les avatars pour pouvoir les afficher
const { data: allAvatars } = await supabase
  .from('avatars')
  .select('id, image_url');

const avatarsMap = new Map(allAvatars?.map(a => [a.id, a.image_url]) || []);

// Mapper les profils avec leur score de quiz solo pour cet univers et trier
const leaderboard = (allProfiles || [])
  .map(profile => ({
    ...profile,
    solo_quiz_score: userScores.get(profile.id) || 0
  }))
  .filter(profile => profile.solo_quiz_score > 0) // Afficher uniquement ceux qui ont des points
  .sort((a, b) => b.solo_quiz_score - a.solo_quiz_score)
  .slice(0, 100); // Limiter √† 100

if (error) {
  console.error('Error fetching leaderboard:', error);
}

const leaderboardData = leaderboard || [];

// R√©cup√©rer l'utilisateur actuel
let currentUserId = null;
const { data: { user } } = await supabase.auth.getUser();
if (user) {
  currentUserId = user.id;
}
---

<BaseLayout title="Classement par Univers - Qivana" description="Classement des meilleurs joueurs par univers">
  <main class="leaderboard-page leaderboard-page--universe">
    <div class="container">
      <header class="leaderboard-header">
        <h1 class="leaderboard-header__title">üèÜ Classement par Univers</h1>
        <p class="leaderboard-header__subtitle">Choisis un univers pour voir le classement</p>
      </header>

      <div class="leaderboard-universe-selector">
        {universes.map((universe) => (
          <a
            href={`/leaderboard/universe?universe=${universe.value}`}
            class={`leaderboard-universe-btn ${selectedUniverse === universe.value ? 'leaderboard-universe-btn--active' : ''}`}
          >
            <span class="leaderboard-universe-btn__emoji">{universe.emoji}</span>
            <span class="leaderboard-universe-btn__label">{universe.label}</span>
          </a>
        ))}
      </div>

      <div class="leaderboard-universe-header">
        <h2 class="leaderboard-universe-header__title">
          {universes.find(u => u.value === selectedUniverse)?.emoji} {universes.find(u => u.value === selectedUniverse)?.label}
        </h2>
      </div>

      <div class="leaderboard-list">
        {leaderboardData.length === 0 ? (
          <div class="leaderboard-empty">
            <p>Aucun joueur dans le classement pour cet univers.</p>
          </div>
        ) : (
          <ol class="leaderboard-list__items">
            {leaderboardData.map((player, index) => {
              const rank = index + 1;
              const isCurrentUser = currentUserId === player.id;
              // Calculer isTopThree de mani√®re explicite pour √©viter les erreurs Astro
              const isTopThree = rank === 1 || rank === 2 || rank === 3;
              let itemClasses = 'leaderboard-item';
              if (isCurrentUser) itemClasses += ' leaderboard-item--current';
              if (rank === 1) itemClasses += ' leaderboard-item--rank-1';
              if (rank === 2) itemClasses += ' leaderboard-item--rank-2';
              if (rank === 3) itemClasses += ' leaderboard-item--rank-3';
              
              return (
                <li class={itemClasses}>
                  <a href={`/profile/${player.slug}`} class="leaderboard-item__link">
                    <div class="leaderboard-item__rank">
                      {rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : `#${rank}`}
                    </div>
                    
                    <div class="leaderboard-item__avatar">
                      {player.selected_avatar_id && avatarsMap.get(player.selected_avatar_id) ? (
                        <img src={avatarsMap.get(player.selected_avatar_id)} alt={player.pseudo} />
                      ) : (
                        <div class="leaderboard-item__avatar-placeholder">
                          {player.pseudo.charAt(0).toUpperCase()}
                        </div>
                      )}
                    </div>
                    
                    <div class="leaderboard-item__info">
                      <div class="leaderboard-item__name">
                        {player.pseudo}
                        {isCurrentUser ? <span class="leaderboard-item__you">(Vous)</span> : ''}
                      </div>
                      <div class="leaderboard-item__stats">
                        <span class="leaderboard-item__stat">
                          {Math.round(Number(player.solo_quiz_score) || 0)} pts
                        </span>
                      </div>
                    </div>
                    
                    <div class="leaderboard-item__plan">
                      {player.plan === 'premium+' ? 'üíé' : player.plan === 'premium' ? '‚≠ê' : 'üÜì'}
                    </div>
                  </a>
                </li>
              );
            })}
          </ol>
        )}
      </div>

      <div class="leaderboard-actions">
        <a href="/leaderboard" class="btn btn--secondary">
          Classement global
        </a>
        <a href="/profile" class="btn btn--outline">
          Mon profil
        </a>
      </div>
    </div>
  </main>
</BaseLayout>

<style lang="scss">
  @use '../../styles/pages/_quiz.scss';

  .leaderboard-page--universe {
    min-height: 100vh;
    padding: var(--space-8) 0;
    background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-indigo) 100%);

    .leaderboard-universe-selector {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-3);
      justify-content: center;
      margin-bottom: var(--space-6);
    }

    .leaderboard-universe-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-4);
      background: var(--color-surface);
      border: 2px solid var(--color-border);
      border-radius: var(--radius-3);
      text-decoration: none;
      color: var(--color-text);
      transition: all var(--transition-base);
      min-width: 100px;

      &:hover {
        background: var(--color-neutral-800);
        border-color: var(--color-primary);
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
      }

      &--active {
        background: linear-gradient(135deg, var(--color-primary), var(--color-indigo));
        border-color: var(--color-primary);
        color: var(--color-text-on-primary);
        box-shadow: var(--shadow-lg);
      }
    }

    .leaderboard-universe-btn__emoji {
      font-size: var(--fs-7);
    }

    .leaderboard-universe-btn__label {
      font-size: var(--fs-3);
      font-weight: var(--font-weight-medium);
    }

    .leaderboard-universe-header {
      text-align: center;
      margin-bottom: var(--space-6);
    }

    .leaderboard-universe-header__title {
      font-family: var(--font-secondary);
      font-size: var(--fs-6);
      color: var(--color-text);
    }

    // Styles r√©utilis√©s du leaderboard global
    .leaderboard-header {
      text-align: center;
      margin-bottom: var(--space-8);
      color: var(--color-text);
    }

    .leaderboard-header__title {
      font-family: var(--font-secondary);
      font-size: var(--fs-8);
      font-weight: var(--font-weight-bold);
      margin-bottom: var(--space-2);
    }

    .leaderboard-header__subtitle {
      font-size: var(--fs-4);
      color: var(--color-text-muted);
      opacity: 0.9;
    }

    .leaderboard-list {
      background: var(--color-surface);
      border-radius: var(--radius-4);
      padding: var(--space-6);
      box-shadow: var(--shadow-lg);
      margin-bottom: var(--space-6);
    }

    .leaderboard-empty {
      text-align: center;
      padding: var(--space-8);
      color: var(--color-text-muted);
    }

    .leaderboard-list__items {
      list-style: none;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: column;
      gap: var(--space-2);
    }

    .leaderboard-item {
      background: var(--color-background);
      border-radius: var(--radius-3);
      border: 2px solid transparent;
      transition: all var(--transition-base);

      &:hover {
        background: var(--color-neutral-800);
        transform: translateX(4px);
      }

      &--current {
        background: linear-gradient(135deg, rgba(250, 204, 21, 0.1), rgba(236, 72, 153, 0.1));
        border-color: var(--color-warning);
        box-shadow: 0 0 12px rgba(250, 204, 21, 0.3);
      }

      &--rank-1 {
        background: linear-gradient(135deg, rgba(250, 204, 21, 0.15), rgba(250, 204, 21, 0.05));
        border-color: var(--color-warning);
        box-shadow: 0 0 16px rgba(250, 204, 21, 0.4);
      }

      &--rank-2 {
        background: linear-gradient(135deg, rgba(156, 163, 175, 0.15), rgba(156, 163, 175, 0.05));
        border-color: #9CA3AF;
        box-shadow: 0 0 12px rgba(156, 163, 175, 0.3);
      }

      &--rank-3 {
        background: linear-gradient(135deg, rgba(180, 83, 9, 0.15), rgba(180, 83, 9, 0.05));
        border-color: #B45309;
        box-shadow: 0 0 12px rgba(180, 83, 9, 0.3);
      }
    }

    .leaderboard-item__link {
      display: flex;
      align-items: center;
      gap: var(--space-4);
      padding: var(--space-4);
      text-decoration: none;
      color: inherit;
      width: 100%;
    }

    .leaderboard-item__rank {
      font-size: var(--fs-6);
      font-weight: var(--font-weight-bold);
      min-width: 60px;
      text-align: center;
      color: var(--color-primary);
    }

    .leaderboard-item__avatar {
      flex-shrink: 0;
      width: 48px;
      height: 48px;
      border-radius: 50%;
      overflow: hidden;
      background: var(--color-neutral-800);
      display: flex;
      align-items: center;
      justify-content: center;

      img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
    }

    .leaderboard-item__avatar-placeholder {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
      color: var(--color-text-on-primary);
      font-size: var(--fs-5);
      font-weight: var(--font-weight-bold);
    }

    .leaderboard-item__info {
      flex: 1;
      min-width: 0;
    }

    .leaderboard-item__name {
      font-family: var(--font-secondary);
      font-size: var(--fs-4);
      font-weight: var(--font-weight-semibold);
      color: var(--color-text);
      margin-bottom: var(--space-1);
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }

    .leaderboard-item__you {
      font-size: var(--fs-2);
      color: var(--color-warning);
      font-weight: var(--font-weight-normal);
    }

    .leaderboard-item__stats {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      font-size: var(--fs-2);
      color: var(--color-text-muted);
    }

    .leaderboard-item__plan {
      font-size: var(--fs-5);
      flex-shrink: 0;
    }

    .leaderboard-actions {
      display: flex;
      justify-content: center;
      gap: var(--space-4);
      flex-wrap: wrap;
    }
  }
</style>
