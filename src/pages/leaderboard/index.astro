---
// ============================================
// LEADERBOARD PAGE (Global)
// ============================================

import BaseLayout from '../../layouts/BaseLayout.astro';
import { createServerClient } from '@supabase/ssr';
import type { Database } from '../../types/supabase';

const supabase = createServerClient(
  import.meta.env.PUBLIC_SUPABASE_URL,
  import.meta.env.PUBLIC_SUPABASE_ANON_KEY,
  {
    cookies: {
      get(key) {
        return Astro.cookies.get(key)?.value;
      },
      set(key, value, options) {
        Astro.cookies.set(key, value, options);
      },
      remove(key, options) {
        Astro.cookies.delete(key, options);
      },
    },
  }
);

// R√©cup√©rer le classement global bas√© uniquement sur les quiz solo
// Calculer le score des quiz solo depuis quiz_sessions
const limit = 50; // Afficher 50 par page
const page = parseInt(Astro.url.searchParams.get('page') || '1');
const offset = (page - 1) * limit;

// Calculer les scores des quiz solo pour chaque utilisateur
const { data: quizScores, error: quizScoresError } = await supabase
  .from('quiz_sessions')
  .select('user_id, score')
  .not('completed_at', 'is', null);

// Agr√©ger les scores par utilisateur
const userScores = new Map<string, number>();
if (quizScores) {
  for (const session of quizScores) {
    const currentScore = userScores.get(session.user_id) || 0;
    userScores.set(session.user_id, currentScore + (session.score || 0));
  }
}

// R√©cup√©rer les profils et ajouter leur score de quiz solo
const { data: allProfiles, error } = await supabase
  .from('profiles')
  .select('id, pseudo, plan, slug, selected_avatar_id');

// R√©cup√©rer tous les avatars pour pouvoir les afficher
const { data: allAvatars } = await supabase
  .from('avatars')
  .select('id, image_url');

const avatarsMap = new Map(allAvatars?.map(a => [a.id, a.image_url]) || []);

if (error) {
  console.error('Error fetching profiles:', error);
}

// Mapper les profils avec leur score de quiz solo et trier
const leaderboardWithScores = (allProfiles || [])
  .map(profile => ({
    ...profile,
    solo_quiz_score: userScores.get(profile.id) || 0
  }))
  .filter(profile => profile.solo_quiz_score > 0) // Afficher uniquement ceux qui ont des points
  .sort((a, b) => b.solo_quiz_score - a.solo_quiz_score)
  .slice(offset, offset + limit);

const totalCount = Array.from(userScores.values()).filter(score => score > 0).length;
const hasMore = offset + limit < totalCount;

const leaderboardData = leaderboardWithScores || [];

// R√©cup√©rer l'utilisateur actuel pour afficher son rang
let currentUserRank = null;
let currentUserId = null;
const { data: { user } } = await supabase.auth.getUser();
if (user) {
  currentUserId = user.id;
  // Trouver le rang de l'utilisateur
  const userIndex = leaderboardData.findIndex(p => p.id === user.id);
  if (userIndex !== -1) {
    currentUserRank = offset + userIndex + 1; // Rang global avec offset
  } else {
    // Si l'utilisateur n'est pas dans la page actuelle, calculer son rang exact
    const userSoloScore = userScores.get(user.id) || 0;
    
    if (userSoloScore > 0) {
      // Compter combien d'utilisateurs ont un score sup√©rieur
      const usersWithHigherScore = Array.from(userScores.values())
        .filter(score => score > userSoloScore).length;
      
      currentUserRank = usersWithHigherScore + 1;
    }
  }
}
---

<BaseLayout title="Classement Global - Qivana" description="Classement des meilleurs joueurs Qivana">
  <main class="leaderboard-page">
    <div class="container">
      <header class="leaderboard-header">
        <h1 class="leaderboard-header__title">üèÜ Classement Global</h1>
        <p class="leaderboard-header__subtitle">Les meilleurs joueurs de Qivana</p>
      </header>

      {currentUserRank && (
        <div class="leaderboard-user-rank">
          <div class="leaderboard-user-rank__badge">
            <span class="leaderboard-user-rank__label">Ton rang</span>
            <span class="leaderboard-user-rank__value">#{currentUserRank}</span>
          </div>
        </div>
      )}

      <div class="leaderboard-list">
        {leaderboardData.length === 0 ? (
          <div class="leaderboard-empty">
            <p>Aucun joueur dans le classement pour le moment.</p>
          </div>
        ) : (
          <ol class="leaderboard-list__items">
            {leaderboardData.map((player, index) => {
              const rank = offset + index + 1; // Rang global (avec offset)
              const isCurrentUser = currentUserId === player.id;
              // Calculer isTopThree de mani√®re explicite pour √©viter les erreurs Astro
              const isTopThree = rank === 1 || rank === 2 || rank === 3;
              let itemClasses = 'leaderboard-item';
              if (isCurrentUser) itemClasses += ' leaderboard-item--current';
              if (rank === 1) itemClasses += ' leaderboard-item--rank-1';
              if (rank === 2) itemClasses += ' leaderboard-item--rank-2';
              if (rank === 3) itemClasses += ' leaderboard-item--rank-3';
              
              return (
                <li class={itemClasses}>
                  <a href={`/profile/${player.slug}`} class="leaderboard-item__link">
                    <div class="leaderboard-item__rank">
                      {rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : `#${rank}`}
                    </div>
                    
                    <div class="leaderboard-item__avatar">
                      {player.selected_avatar_id && avatarsMap.get(player.selected_avatar_id) ? (
                        <img src={avatarsMap.get(player.selected_avatar_id)} alt={player.pseudo} />
                      ) : (
                        <div class="leaderboard-item__avatar-placeholder">
                          {player.pseudo.charAt(0).toUpperCase()}
                        </div>
                      )}
                    </div>
                    
                    <div class="leaderboard-item__info">
                      <div class="leaderboard-item__name">
                        {player.pseudo}
                        {isCurrentUser ? <span class="leaderboard-item__you">(Vous)</span> : ''}
                      </div>
                      <div class="leaderboard-item__stats">
                        <span class="leaderboard-item__stat">
                          {Math.round(Number(player.solo_quiz_score) || 0)} pts
                        </span>
                      </div>
                    </div>
                    
                    <div class="leaderboard-item__plan">
                      {player.plan === 'premium+' ? 'üíé' : player.plan === 'premium' ? '‚≠ê' : 'üÜì'}
                    </div>
                  </a>
                </li>
              );
            })}
          </ol>
        )}
      </div>

      {hasMore && (
        <div class="leaderboard-pagination">
          <a href={`/leaderboard?page=${page + 1}`} class="btn btn--primary">
            Voir plus ({Math.min(limit, (totalCount || 0) - offset - limit)} suivants)
          </a>
        </div>
      )}

      {page > 1 && (
        <div class="leaderboard-pagination">
          <a href={`/leaderboard?page=${page - 1}`} class="btn btn--outline">
            ‚Üê Pr√©c√©dent
          </a>
        </div>
      )}

      <div class="leaderboard-actions">
        <a href="/leaderboard/universe" class="btn btn--secondary">
          Classement par univers
        </a>
        <a href="/profile" class="btn btn--outline">
          Mon profil
        </a>
      </div>
    </div>
  </main>
</BaseLayout>

<style lang="scss">
  @use '../../styles/pages/leaderboard' as *;
</style>
