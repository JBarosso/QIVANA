---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { requirePremiumPlus } from '../../lib/auth';
import '../../styles/pages/_duel.scss';

// Protection de la route - Premium+ uniquement
const authResult = await requirePremiumPlus(Astro);

// Si c'est une redirection, elle a d√©j√† √©t√© effectu√©e
if (authResult instanceof Response) {
  return authResult;
}

const { user, profile } = authResult;

// D√©finir les univers et difficult√©s disponibles
const universes = [
  { id: 'anime', label: 'üéå Anime', icon: 'üéå' },
  { id: 'manga', label: 'üìö Manga', icon: 'üìö' },
  { id: 'comics', label: 'ü¶∏ Comics', icon: 'ü¶∏' },
  { id: 'games', label: 'üéÆ Jeux Vid√©o', icon: 'üéÆ' },
  { id: 'movies', label: 'üé¨ Films', icon: 'üé¨' },
  { id: 'series', label: 'üì∫ S√©ries', icon: 'üì∫' },
  { id: 'other', label: 'üåü Autre', icon: 'üåü' },
];

const difficulties = [
  { id: 'easy', label: 'Facile', description: 'Pour d√©buter', color: 'success' },
  { id: 'medium', label: 'Moyen', description: 'Un peu de challenge', color: 'warning' },
  { id: 'hard', label: 'Difficile', description: 'Pour les experts', color: 'danger' },
];

const gameModes = [
  { id: 'classic', label: 'Classic', description: 'Mode classique avec questions synchronis√©es', available: true },
  { id: 'battle_royal', label: '‚öîÔ∏è Battle Royal', description: 'Combat avec vies et d√©g√¢ts', available: true },
];

const questionCounts = [5, 10, 15, 20, 25, 30];
---

<BaseLayout title="Cr√©er un Salon - Qivana">
  <div class="duel-create">
    <div class="duel-create__container">
      <header class="duel-create__header">
        <h1 class="duel-create__title">Cr√©er un Salon</h1>
        <p class="duel-create__subtitle">Organise un duel multijoueur avec tes amis</p>
      </header>

      <form method="POST" action="/api/duel/create" class="duel-create__form" id="duelCreateForm">
        <!-- Nom du salon -->
        <section class="duel-create__section">
          <label for="salon_name" class="duel-create__label">
            <span class="duel-create__label-icon">üè∑Ô∏è</span>
            Nom du salon
          </label>
          <input
            type="text"
            id="salon_name"
            name="salon_name"
            required
            minlength="3"
            maxlength="50"
            placeholder="Ex: Duel Anime du Samedi"
            class="duel-create__input"
          />
          <p class="duel-create__hint">Entre 3 et 50 caract√®res</p>
        </section>

        <!-- Mode de jeu -->
        <section class="duel-create__section">
          <h2 class="duel-create__section-title">
            <span class="duel-create__section-icon">üéÆ</span>
            Mode de jeu
          </h2>
          <div class="duel-create__grid">
            {gameModes.map((mode) => (
              <label class={`duel-create__mode-card ${!mode.available ? 'duel-create__mode-card--disabled' : ''}`}>
                <input
                  type="radio"
                  name="game_mode"
                  value={mode.id}
                  required
                  disabled={!mode.available}
                  checked={mode.id === 'classic'}
                  class="duel-create__mode-card__input"
                />
                <div class="duel-create__mode-card__content">
                  <span class="duel-create__mode-card__label">{mode.label}</span>
                  <span class="duel-create__mode-card__description">{mode.description}</span>
                  {!mode.available && (
                    <span class="duel-create__mode-card__badge">Bient√¥t</span>
                  )}
                </div>
              </label>
            ))}
          </div>
        </section>

        <!-- Source des questions (DB avec g√©n√©ration IA automatique, ou Custom Quiz) -->
        <section class="duel-create__section">
          <h2 class="duel-create__section-title">
            <span class="duel-create__section-icon">üìö</span>
            Source des questions
          </h2>
          <div class="duel-create__radio-group">
            <label class="duel-create__radio">
              <input
                type="radio"
                name="mode"
                value="db"
                required
                checked
                class="duel-create__radio__input"
                id="mode-db"
              />
              <span class="duel-create__radio__label">Base de donn√©es</span>
              <span class="duel-create__radio__hint">Questions valid√©es. G√©n√©ration IA automatique si stock insuffisant</span>
            </label>
            <label class="duel-create__radio">
              <input
                type="radio"
                name="mode"
                value="ai-custom-quiz"
                class="duel-create__radio__input"
                id="mode-custom-quiz"
              />
              <span class="duel-create__radio__label">‚ú® Quiz Custom</span>
              <span class="duel-create__radio__hint">Cr√©e un quiz personnalis√© avec ton propre prompt</span>
            </label>
          </div>
          
          <!-- Section Custom Quiz (affich√©e uniquement si mode custom s√©lectionn√©) -->
          <div id="custom-quiz-section" class="duel-create__custom-section" hidden>
            <h3 class="duel-create__custom-title">üìù Ton prompt cr√©atif</h3>
            <p class="duel-create__custom-hint">
              D√©cris le quiz que tu veux. Sois pr√©cis et cr√©atif !
            </p>
            <textarea
              name="custom_prompt"
              id="customPromptInput"
              placeholder="Ex: Cr√©e un quiz sur les r√©pliques cultes de Breaking Bad"
              rows="4"
              maxlength="500"
              class="custom-quiz-textarea"
            ></textarea>
            <div class="duel-create__custom-counter">
              <span id="customCharCount">0</span> / 500 caract√®res
            </div>
          </div>
        </section>

        <!-- S√©lection Univers (cach√©e si mode custom) -->
        <section class="duel-create__section" id="universe-section">
          <h2 class="duel-create__section-title">
            <span class="duel-create__section-icon">üåç</span>
            Univers
          </h2>
          <div class="duel-create__grid">
            {universes.map((universe) => (
              <label class="duel-create__card">
                <input
                  type="radio"
                  name="universe"
                  value={universe.id}
                  required
                  class="duel-create__card__input"
                  id={`universe-${universe.id}`}
                />
                <div class="duel-create__card__content">
                  <span class="duel-create__card__icon">{universe.icon}</span>
                  <span class="duel-create__card__label">{universe.label}</span>
                </div>
              </label>
            ))}
          </div>
        </section>

        <!-- S√©lection Difficult√© -->
        <section class="duel-create__section">
          <h2 class="duel-create__section-title">
            <span class="duel-create__section-icon">‚ö°</span>
            Difficult√©
          </h2>
          <div class="duel-create__difficulty-grid">
            {difficulties.map((difficulty) => (
              <label class={`duel-create__difficulty-card duel-create__difficulty-card--${difficulty.color}`}>
                <input
                  type="radio"
                  name="difficulty"
                  value={difficulty.id}
                  required
                  class="duel-create__difficulty-card__input"
                />
                <div class="duel-create__difficulty-card__content">
                  <span class="duel-create__difficulty-card__label">{difficulty.label}</span>
                  <span class="duel-create__difficulty-card__description">{difficulty.description}</span>
                </div>
              </label>
            ))}
          </div>
        </section>

        <!-- Nombre de questions -->
        <section class="duel-create__section">
          <label for="questions_count" class="duel-create__label">
            <span class="duel-create__label-icon">‚ùì</span>
            Nombre de questions
          </label>
          <select
            id="questions_count"
            name="questions_count"
            required
            class="duel-create__select"
          >
            {questionCounts.map((count) => (
              <option value={count}>{count} questions</option>
            ))}
          </select>
        </section>

        <!-- Timer -->
        <section class="duel-create__section">
          <label for="timer_seconds" class="duel-create__label">
            <span class="duel-create__label-icon">‚è±Ô∏è</span>
            Timer (secondes par question)
          </label>
          <input
            type="number"
            id="timer_seconds"
            name="timer_seconds"
            min="3"
            max="20"
            value="10"
            required
            class="duel-create__input"
          />
          <p class="duel-create__hint">Entre 3 et 20 secondes (ou d√©sactiver dans le lobby)</p>
        </section>

        <!-- Note: Visibilit√© publique d√©sactiv√©e pour la MVP -->
        <!-- Tous les salons sont priv√©s (accessibles uniquement via code/link) -->

        <!-- Bouton de soumission -->
        <div class="duel-create__actions">
          <button type="submit" class="btn btn--primary btn--block">
            Cr√©er le salon
          </button>
        </div>
      </form>
    </div>
  </div>
</BaseLayout>

<style>
  /* Style pour le textarea du quiz custom - am√©lioration de la lisibilit√© */
  .custom-quiz-textarea {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #d1d5db;
    border-radius: 4px;
    font-family: inherit;
    resize: vertical;
    color: #1f2937 !important;
    background-color: #ffffff !important;
    font-size: 1rem;
    line-height: 1.5;
  }
  
  .custom-quiz-textarea::placeholder {
    color: #9CA3AF !important;
    opacity: 1;
  }
  
  .custom-quiz-textarea:focus {
    outline: none;
    border-color: #6366f1;
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
  }
</style>

<script>
  import { showAlert } from '../../lib/showAlert';

  const form = document.getElementById('duelCreateForm') as HTMLFormElement;
  const customQuizSection = document.getElementById('custom-quiz-section');
  const universeSection = document.getElementById('universe-section');
  const customPromptInput = document.getElementById('customPromptInput') as HTMLTextAreaElement;
  const customCharCount = document.getElementById('customCharCount');
  const modeInputs = document.querySelectorAll('input[name="mode"]') as NodeListOf<HTMLInputElement>;
  const universeInputs = document.querySelectorAll('input[name="universe"]') as NodeListOf<HTMLInputElement>;
  
  // Afficher/masquer la section custom quiz et univers selon le mode s√©lectionn√©
  if (modeInputs && customQuizSection && universeSection) {
    const updateUI = (isCustomMode: boolean) => {
      if (isCustomMode) {
        // Mode custom : afficher le prompt, cacher l'univers
        customQuizSection.style.display = 'block';
        universeSection.style.display = 'none';
        if (customPromptInput) {
          customPromptInput.required = true;
        }
        // D√©sactiver l'obligation de choisir un univers
        universeInputs.forEach((input) => {
          input.removeAttribute('required');
        });
      } else {
        // Mode DB : cacher le prompt, afficher l'univers
        customQuizSection.style.display = 'none';
        universeSection.style.display = 'block';
        if (customPromptInput) {
          customPromptInput.required = false;
        }
        // R√©activer l'obligation de choisir un univers
        universeInputs.forEach((input) => {
          input.setAttribute('required', 'required');
        });
      }
    };

    modeInputs.forEach((input) => {
      input.addEventListener('change', () => {
        updateUI(input.value === 'ai-custom-quiz');
      });
    });

    // Initialiser l'UI selon le mode s√©lectionn√© par d√©faut
    const defaultMode = document.querySelector('input[name="mode"]:checked') as HTMLInputElement;
    if (defaultMode) {
      updateUI(defaultMode.value === 'ai-custom-quiz');
    }
  }

  // Compteur de caract√®res pour le prompt custom
  if (customPromptInput && customCharCount) {
    customPromptInput.addEventListener('input', () => {
      customCharCount.textContent = customPromptInput.value.length.toString();
    });
  }
  
  if (form) {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const formData = new FormData(form);
      const submitButton = form.querySelector('button[type="submit"]') as HTMLButtonElement;
      
      // V√©rifier si mode custom quiz et prompt requis
      const selectedMode = formData.get('mode');
      if (selectedMode === 'ai-custom-quiz') {
        const customPrompt = formData.get('custom_prompt')?.toString().trim();
        if (!customPrompt || customPrompt.length < 10) {
          showAlert({ 
            message: 'Le prompt custom doit contenir au moins 10 caract√®res', 
            type: 'error' 
          });
          return;
        }
      } else {
        // Mode DB : v√©rifier que l'univers est s√©lectionn√©
        const selectedUniverse = formData.get('universe');
        if (!selectedUniverse) {
          showAlert({ 
            message: 'Veuillez s√©lectionner un univers', 
            type: 'error' 
          });
          return;
        }
      }
      
      if (submitButton) {
        submitButton.disabled = true;
        submitButton.textContent = 'Cr√©ation...';
      }

      try {
        const response = await fetch('/api/duel/create', {
          method: 'POST',
          body: formData,
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Erreur lors de la cr√©ation du salon');
        }

        // Rediriger vers le lobby
        if (data.redirectTo) {
          window.location.href = data.redirectTo;
        } else {
          showAlert({ message: 'Salon cr√©√© avec succ√®s !', type: 'success' });
          // Fallback: rediriger vers le profile
          setTimeout(() => {
            window.location.href = '/profile';
          }, 1500);
        }
      } catch (error) {
        console.error('Error creating salon:', error);
        showAlert({ 
          message: error instanceof Error ? error.message : 'Erreur lors de la cr√©ation du salon', 
          type: 'error' 
        });
        
        if (submitButton) {
          submitButton.disabled = false;
          submitButton.textContent = 'Cr√©er le salon';
        }
      }
    });
  }
</script>
