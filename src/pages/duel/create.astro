---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { requirePremiumPlus } from '../../lib/auth';
import '../../styles/pages/_duel.scss';

// Protection de la route - Premium+ uniquement
const authResult = await requirePremiumPlus(Astro);

// Si c'est une redirection, elle a dÃ©jÃ  Ã©tÃ© effectuÃ©e
if (authResult instanceof Response) {
  return authResult;
}

const { user, profile } = authResult;

// DÃ©finir les univers et difficultÃ©s disponibles
const universes = [
  { id: 'anime', label: 'ğŸŒ Anime', icon: 'ğŸŒ' },
  { id: 'manga', label: 'ğŸ“š Manga', icon: 'ğŸ“š' },
  { id: 'comics', label: 'ğŸ¦¸ Comics', icon: 'ğŸ¦¸' },
  { id: 'games', label: 'ğŸ® Jeux VidÃ©o', icon: 'ğŸ®' },
  { id: 'movies', label: 'ğŸ¬ Films', icon: 'ğŸ¬' },
  { id: 'series', label: 'ğŸ“º SÃ©ries', icon: 'ğŸ“º' },
  { id: 'other', label: 'ğŸŒŸ Autre', icon: 'ğŸŒŸ' },
];

const difficulties = [
  { id: 'easy', label: 'Facile', description: 'Pour dÃ©buter', color: 'success' },
  { id: 'medium', label: 'Moyen', description: 'Un peu de challenge', color: 'warning' },
  { id: 'hard', label: 'Difficile', description: 'Pour les experts', color: 'danger' },
];

const gameModes = [
  { id: 'classic', label: 'Classic', description: 'Mode classique avec questions synchronisÃ©es', available: true },
  { id: 'deathmatch', label: 'Deathmatch', description: 'Mode compÃ©titif (bientÃ´t disponible)', available: false },
];

const questionCounts = [5, 10, 15, 20, 25, 30];
---

<BaseLayout title="CrÃ©er un Salon - Qivana">
  <div class="duel-create">
    <div class="duel-create__container">
      <header class="duel-create__header">
        <h1 class="duel-create__title">CrÃ©er un Salon</h1>
        <p class="duel-create__subtitle">Organise un duel multijoueur avec tes amis</p>
      </header>

      <form method="POST" action="/api/duel/create" class="duel-create__form" id="duelCreateForm">
        <!-- Nom du salon -->
        <section class="duel-create__section">
          <label for="salon_name" class="duel-create__label">
            <span class="duel-create__label-icon">ğŸ·ï¸</span>
            Nom du salon
          </label>
          <input
            type="text"
            id="salon_name"
            name="salon_name"
            required
            minlength="3"
            maxlength="50"
            placeholder="Ex: Duel Anime du Samedi"
            class="duel-create__input"
          />
          <p class="duel-create__hint">Entre 3 et 50 caractÃ¨res</p>
        </section>

        <!-- Mode de jeu -->
        <section class="duel-create__section">
          <h2 class="duel-create__section-title">
            <span class="duel-create__section-icon">ğŸ®</span>
            Mode de jeu
          </h2>
          <div class="duel-create__grid">
            {gameModes.map((mode) => (
              <label class={`duel-create__mode-card ${!mode.available ? 'duel-create__mode-card--disabled' : ''}`}>
                <input
                  type="radio"
                  name="game_mode"
                  value={mode.id}
                  required
                  disabled={!mode.available}
                  checked={mode.id === 'classic'}
                  class="duel-create__mode-card__input"
                />
                <div class="duel-create__mode-card__content">
                  <span class="duel-create__mode-card__label">{mode.label}</span>
                  <span class="duel-create__mode-card__description">{mode.description}</span>
                  {!mode.available && (
                    <span class="duel-create__mode-card__badge">BientÃ´t</span>
                  )}
                </div>
              </label>
            ))}
          </div>
        </section>

        <!-- Source des questions (DB ou IA) -->
        <section class="duel-create__section">
          <h2 class="duel-create__section-title">
            <span class="duel-create__section-icon">ğŸ“š</span>
            Source des questions
          </h2>
          <div class="duel-create__radio-group">
            <label class="duel-create__radio">
              <input
                type="radio"
                name="mode"
                value="db"
                required
                checked
                class="duel-create__radio__input"
              />
              <span class="duel-create__radio__label">Base de donnÃ©es</span>
              <span class="duel-create__radio__hint">Questions validÃ©es et approuvÃ©es</span>
            </label>
            <label class="duel-create__radio">
              <input
                type="radio"
                name="mode"
                value="ai-predefined"
                class="duel-create__radio__input"
              />
              <span class="duel-create__radio__label">IA (prÃ©dÃ©fini)</span>
              <span class="duel-create__radio__hint">GÃ©nÃ©ration IA si stock insuffisant</span>
            </label>
          </div>
        </section>

        <!-- SÃ©lection Univers -->
        <section class="duel-create__section">
          <h2 class="duel-create__section-title">
            <span class="duel-create__section-icon">ğŸŒ</span>
            Univers
          </h2>
          <div class="duel-create__grid">
            {universes.map((universe) => (
              <label class="duel-create__card">
                <input
                  type="radio"
                  name="universe"
                  value={universe.id}
                  required
                  class="duel-create__card__input"
                />
                <div class="duel-create__card__content">
                  <span class="duel-create__card__icon">{universe.icon}</span>
                  <span class="duel-create__card__label">{universe.label}</span>
                </div>
              </label>
            ))}
          </div>
        </section>

        <!-- SÃ©lection DifficultÃ© -->
        <section class="duel-create__section">
          <h2 class="duel-create__section-title">
            <span class="duel-create__section-icon">âš¡</span>
            DifficultÃ©
          </h2>
          <div class="duel-create__difficulty-grid">
            {difficulties.map((difficulty) => (
              <label class={`duel-create__difficulty-card duel-create__difficulty-card--${difficulty.color}`}>
                <input
                  type="radio"
                  name="difficulty"
                  value={difficulty.id}
                  required
                  class="duel-create__difficulty-card__input"
                />
                <div class="duel-create__difficulty-card__content">
                  <span class="duel-create__difficulty-card__label">{difficulty.label}</span>
                  <span class="duel-create__difficulty-card__description">{difficulty.description}</span>
                </div>
              </label>
            ))}
          </div>
        </section>

        <!-- Nombre de questions -->
        <section class="duel-create__section">
          <label for="questions_count" class="duel-create__label">
            <span class="duel-create__label-icon">â“</span>
            Nombre de questions
          </label>
          <select
            id="questions_count"
            name="questions_count"
            required
            class="duel-create__select"
          >
            {questionCounts.map((count) => (
              <option value={count}>{count} questions</option>
            ))}
          </select>
        </section>

        <!-- Timer -->
        <section class="duel-create__section">
          <label for="timer_seconds" class="duel-create__label">
            <span class="duel-create__label-icon">â±ï¸</span>
            Timer (secondes par question)
          </label>
          <input
            type="number"
            id="timer_seconds"
            name="timer_seconds"
            min="3"
            max="20"
            value="10"
            required
            class="duel-create__input"
          />
          <p class="duel-create__hint">Entre 3 et 20 secondes (ou dÃ©sactiver dans le lobby)</p>
        </section>

        <!-- Note: VisibilitÃ© publique dÃ©sactivÃ©e pour la MVP -->
        <!-- Tous les salons sont privÃ©s (accessibles uniquement via code/link) -->

        <!-- Bouton de soumission -->
        <div class="duel-create__actions">
          <button type="submit" class="btn btn--primary btn--block">
            CrÃ©er le salon
          </button>
        </div>
      </form>
    </div>
  </div>
</BaseLayout>

<script>
  import { showAlert } from '../../lib/showAlert';

  const form = document.getElementById('duelCreateForm') as HTMLFormElement;
  
  if (form) {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const formData = new FormData(form);
      const submitButton = form.querySelector('button[type="submit"]') as HTMLButtonElement;
      
      if (submitButton) {
        submitButton.disabled = true;
        submitButton.textContent = 'CrÃ©ation...';
      }

      try {
        const response = await fetch('/api/duel/create', {
          method: 'POST',
          body: formData,
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Erreur lors de la crÃ©ation du salon');
        }

        // Rediriger vers le lobby
        if (data.redirectTo) {
          window.location.href = data.redirectTo;
        } else {
          showAlert({ message: 'Salon crÃ©Ã© avec succÃ¨s !', type: 'success' });
          // Fallback: rediriger vers le profile
          setTimeout(() => {
            window.location.href = '/profile';
          }, 1500);
        }
      } catch (error) {
        console.error('Error creating salon:', error);
        showAlert({ 
          message: error instanceof Error ? error.message : 'Erreur lors de la crÃ©ation du salon', 
          type: 'error' 
        });
        
        if (submitButton) {
          submitButton.disabled = false;
          submitButton.textContent = 'CrÃ©er le salon';
        }
      }
    });
  }
</script>
