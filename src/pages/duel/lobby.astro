---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { requirePremiumPlus } from '../../lib/auth';
import { getSalonByCode } from '../../lib/duel';
import LobbyRealtime from '../../components/duel/LobbyRealtime';
import StartGameButton from '../../components/duel/StartGameButton';

// Protection de la route - Premium+ uniquement
const authResult = await requirePremiumPlus(Astro);

// Si c'est une redirection, elle a d√©j√† √©t√© effectu√©e
if (authResult instanceof Response) {
  return authResult;
}

const { user, profile } = authResult;

// R√©cup√©rer le salon depuis l'URL
const salonId = Astro.url.searchParams.get('salon');
let salon = null;
let salonCode = null;

// R√©cup√©rer supabase
const supabase = (Astro.locals as { supabase?: any }).supabase;

if (salonId) {
  // R√©cup√©rer le salon par ID (via code si n√©cessaire)
  // Pour l'instant, on r√©cup√®re directement depuis la DB
  if (supabase) {
    const { data, error } = await supabase
      .from('duel_sessions')
      .select('*')
      .eq('id', salonId)
      .single();

    if (!error && data) {
      salon = data;
      salonCode = data.salon_code;
    }
  }
}

// Si le salon n'existe pas ou n'est plus en lobby, rediriger
if (!salon) {
  return Astro.redirect('/duel/create?error=salon-not-found');
}

// Si le duel est en cours, rediriger vers la page de jeu
if (salon.status === 'in-progress') {
  return Astro.redirect(`/duel/play?salon=${salonId}`);
}

// Si le duel est termin√©, rediriger vers les r√©sultats
if (salon.status === 'completed') {
  return Astro.redirect(`/duel/results?salon=${salonId}`);
}

// Si le salon n'est plus en lobby (cancelled), rediriger
if (salon.status !== 'lobby') {
  return Astro.redirect('/duel/join?code=' + salonCode + '&error=salon-not-available');
}

// V√©rifier si l'utilisateur est le chef
const isChef = salon.chef_id === user.id;

// R√©cup√©rer le pseudo du chef
let chefPseudo = profile.pseudo; // Par d√©faut, si c'est le chef actuel
if (!isChef && supabase) {
  const { data: chefProfile } = await supabase
    .from('profiles')
    .select('pseudo')
    .eq('id', salon.chef_id)
    .single();
  if (chefProfile) {
    chefPseudo = chefProfile.pseudo;
  }
}

// Cr√©er un client Supabase c√¥t√© client pour le Realtime
const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;
const supabaseAnonKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;

// R√©cup√©rer le token d'acc√®s depuis la session serveur pour l'initialiser c√¥t√© client
let accessToken = null;
if (supabase) {
  const { data: { session } } = await supabase.auth.getSession();
  if (session) {
    accessToken = session.access_token;
  }
}

// URL du site : utilise PUBLIC_SITE_URL si d√©fini, sinon l'origine de la requ√™te
const siteUrl = import.meta.env.PUBLIC_SITE_URL || Astro.url.origin;
const shareUrl = `${siteUrl}/duel/join?code=${salonCode}`;
---

<BaseLayout title="Lobby - Qivana">
  <div class="duel-lobby">
    <div class="duel-lobby__container">
      <header class="duel-lobby__header">
        <h1 class="duel-lobby__title">{salon?.salon_name || 'Salon'}</h1>
        <p class="duel-lobby__subtitle">En attente de joueurs...</p>
      </header>

      {salon && (
        <div class="duel-lobby__content">
          <!-- Code du salon -->
          <section class="duel-lobby__section duel-lobby__code-section">
            <h2 class="duel-lobby__section-title">Code du salon</h2>
            <div class="duel-lobby__code">
              <span class="duel-lobby__code-text">{salonCode}</span>
              <button
                class="btn btn--secondary"
                id="copyLinkBtn"
              >
                üìã Copier le lien
              </button>
            </div>
            
            <!-- QR Code -->
            <div class="duel-lobby__qr-container">
              <img id="qrCode" class="duel-lobby__qr-code" alt="QR Code" />
              <p class="duel-lobby__qr-hint">Scanne pour rejoindre rapidement</p>
            </div>
            
            <p class="duel-lobby__hint">
              Partage ce code ou ce lien avec tes amis pour qu'ils rejoignent le salon
            </p>
          </section>

          <!-- Informations du salon -->
          <section class="duel-lobby__section">
            <h2 class="duel-lobby__section-title">Param√®tres</h2>
            <div class="duel-lobby__info-grid">
              <div class="duel-lobby__info-item">
                <span class="duel-lobby__info-label">Univers</span>
                <span class="duel-lobby__info-value">{salon.universe}</span>
              </div>
              <div class="duel-lobby__info-item">
                <span class="duel-lobby__info-label">Difficult√©</span>
                <span class="duel-lobby__info-value">{salon.difficulty}</span>
              </div>
              <div class="duel-lobby__info-item">
                <span class="duel-lobby__info-label">Questions</span>
                <span class="duel-lobby__info-value">{salon.questions_count}</span>
              </div>
              <div class="duel-lobby__info-item">
                <span class="duel-lobby__info-label">Timer</span>
                <span class="duel-lobby__info-value">
                  {salon.timer_seconds ? `${salon.timer_seconds}s` : 'D√©sactiv√©'}
                </span>
              </div>
            </div>
          </section>

          <!-- Liste des joueurs (Socket.IO) -->
          <section class="duel-lobby__section">
            <h2 class="duel-lobby__section-title">Joueurs</h2>
            {salonCode && (
              <LobbyRealtime
                client:load
                roomId={salonCode}
                currentUserId={user.id}
                currentUserPseudo={profile.pseudo}
                isChef={isChef}
                chefId={salon.chef_id}
                chefPseudo={chefPseudo}
              />
            )}
          </section>

          <!-- Actions -->
          <section class="duel-lobby__actions">
            {isChef && salonCode && (
              <StartGameButton
                client:load
                roomId={salonCode}
                salonId={salonId || ''}
                questionsCount={salon.questions_count}
                universe={salon.universe}
                difficulty={salon.difficulty}
                minPlayers={2}
                currentPlayersCount={1}
              />
            )}
            <a href="/profile" class="btn btn--secondary btn--block">
              Retour au profil
            </a>
          </section>
        </div>
      )}
    </div>
  </div>
</BaseLayout>

<style>
  @import '../../styles/pages/_duel.scss';

  .duel-lobby {
    min-height: 100vh;
    padding: var(--space-6) var(--space-4);
    background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-indigo) 100%);
  }

  .duel-lobby__container {
    max-width: var(--container-lg);
    margin: 0 auto;
  }

  .duel-lobby__header {
    text-align: center;
    margin-bottom: var(--space-8);
  }

  .duel-lobby__title {
    font-family: var(--font-secondary);
    font-size: var(--fs-8);
    font-weight: var(--font-weight-bold);
    color: var(--color-text);
    margin-bottom: var(--space-2);
  }

  .duel-lobby__subtitle {
    font-size: var(--fs-4);
    color: var(--color-text-muted);
  }

  .duel-lobby__content {
    display: flex;
    flex-direction: column;
    gap: var(--space-6);
  }

  .duel-lobby__section {
    background: var(--color-surface);
    border-radius: var(--radius-4);
    padding: var(--space-6);
    box-shadow: var(--shadow-md);
  }

  .duel-lobby__section-title {
    font-family: var(--font-secondary);
    font-size: var(--fs-5);
    font-weight: var(--font-weight-bold);
    color: var(--color-text);
    margin-bottom: var(--space-4);
  }

  .duel-lobby__code-section {
    text-align: center;
  }

  .duel-lobby__code {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-3);
    margin-bottom: var(--space-3);
  }

  .duel-lobby__code-text {
    font-family: var(--font-mono, monospace);
    font-size: var(--fs-7);
    font-weight: var(--font-weight-bold);
    color: var(--color-primary);
    background: var(--color-neutral-800);
    padding: var(--space-3) var(--space-5);
    border-radius: var(--radius-2);
    letter-spacing: 0.1em;
  }

  .duel-lobby__hint {
    font-size: var(--fs-2);
    color: var(--color-text-muted);
  }

  .duel-lobby__info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: var(--space-4);
  }

  .duel-lobby__info-item {
    display: flex;
    flex-direction: column;
    gap: var(--space-1);
  }

  .duel-lobby__info-label {
    font-size: var(--fs-2);
    color: var(--color-text-muted);
  }

  .duel-lobby__info-value {
    font-size: var(--fs-4);
    font-weight: var(--font-weight-semibold);
    color: var(--color-text);
    text-transform: capitalize;
  }

  .duel-lobby__players-list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
  }

  .duel-lobby__player {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--space-3);
    background: var(--color-neutral-800);
    border-radius: var(--radius-2);
  }

  .duel-lobby__player-name {
    font-size: var(--fs-3);
    color: var(--color-text);
  }

  .duel-lobby__player-badge {
    font-size: var(--fs-2);
    color: var(--color-warning);
  }

  .duel-lobby__empty {
    text-align: center;
    color: var(--color-text-muted);
    padding: var(--space-4);
  }

  .duel-lobby__actions {
    text-align: center;
  }

  .duel-lobby__note {
    font-size: var(--fs-2);
    color: var(--color-text-muted);
    margin-bottom: var(--space-4);
    font-style: italic;
  }

  .duel-lobby__qr-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--space-3);
    margin-top: var(--space-4);
    padding: var(--space-4);
    background: var(--color-neutral-800);
    border-radius: var(--radius-3);
  }

  .duel-lobby__qr-code {
    width: 180px;
    height: 180px;
    background: white;
    padding: var(--space-2);
    border-radius: var(--radius-2);
    display: block;
    object-fit: contain;
  }

  .duel-lobby__qr-hint {
    font-size: var(--fs-2);
    color: var(--color-text-muted);
    text-align: center;
  }
</style>

<script is:inline define:vars={{ shareUrl }}>
  // QR Code generation - Utiliser une API externe simple
  (function() {
    const qrElement = document.getElementById('qrCode');
    if (!qrElement || qrElement.tagName !== 'IMG') {
      return;
    }

    // Utiliser l'API QR Server (plus fiable que CDN)
    const qrApiUrl = `https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=${encodeURIComponent(shareUrl)}`;
    qrElement.src = qrApiUrl;
    
    qrElement.onerror = function() {
      if (qrElement.parentElement) {
        qrElement.parentElement.innerHTML = '<p style="color: var(--color-text-muted);">Erreur chargement QR code</p>';
      }
    };
  })();

  // Copy link button
  (function() {
    const copyLinkBtn = document.getElementById('copyLinkBtn');
    if (copyLinkBtn) {
      copyLinkBtn.addEventListener('click', function() {
        navigator.clipboard.writeText(shareUrl).then(function() {
          copyLinkBtn.textContent = '‚úÖ Copi√© !';
          setTimeout(function() {
            copyLinkBtn.textContent = 'üìã Copier le lien';
          }, 2000);
        }).catch(function(error) {
          console.error('Error copying to clipboard:', error);
          copyLinkBtn.textContent = '‚ùå Erreur';
          setTimeout(function() {
            copyLinkBtn.textContent = 'üìã Copier le lien';
          }, 2000);
        });
      });
    }
  })();

  // Activer le bouton "D√©marrer" quand il y a au moins 2 joueurs
  (function() {
    const startDuelBtn = document.getElementById('startDuelBtn');
    if (!startDuelBtn) return;

    const salonId = startDuelBtn.getAttribute('data-salon-id');
    if (!salonId) return;

    // Fonction pour mettre √† jour l'√©tat du bouton
    function updateStartButton(participantsCount) {
      const totalPlayers = 1 + participantsCount; // Chef + participants
      if (totalPlayers >= 2) {
        startDuelBtn.removeAttribute('disabled');
        startDuelBtn.textContent = `D√©marrer le duel (${totalPlayers} joueurs)`;
      } else {
        startDuelBtn.setAttribute('disabled', '');
        startDuelBtn.textContent = 'D√©marrer le duel (min. 2 joueurs)';
      }
    }

    // √âcouter les changements de participants via un √©v√©nement personnalis√©
    // Le composant LobbyRealtime √©mettra cet √©v√©nement
    window.addEventListener('participants-updated', function(event) {
      const customEvent = event;
      const count = (customEvent.detail && customEvent.detail.count) ? customEvent.detail.count : 0;
      updateStartButton(count);
    });

    // Initialiser avec 0 (sera mis √† jour par le composant)
    updateStartButton(0);

    // G√©rer le clic sur le bouton
    startDuelBtn.addEventListener('click', async function() {
      if (startDuelBtn.hasAttribute('disabled')) {
        return;
      }

      startDuelBtn.setAttribute('disabled', '');
      startDuelBtn.textContent = 'D√©marrage...';

      try {
        const formData = new FormData();
        formData.append('salon_id', salonId);

        const response = await fetch('/api/duel/start', {
          method: 'POST',
          body: formData,
        });

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          alert(`Erreur: ${errorData.error || 'Impossible de d√©marrer le duel'}`);
          startDuelBtn.removeAttribute('disabled');
          updateStartButton(0); // R√©initialiser
          return;
        }

        const data = await response.json();
        if (data.redirectTo) {
          window.location.href = data.redirectTo;
        }
      } catch (error) {
        console.error('Error starting duel:', error);
        alert('Erreur lors du d√©marrage du duel');
        startDuelBtn.removeAttribute('disabled');
        updateStartButton(0);
      }
    });
  })();
</script>
