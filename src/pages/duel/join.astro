---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { requireAuth } from '../../lib/auth';
import { getSalonByCode } from '../../lib/duel';

// Protection de la route - Authentification requise (tous les plans peuvent rejoindre)
const authResult = await requireAuth(Astro);

// Si c'est une redirection, elle a d√©j√† √©t√© effectu√©e
if (authResult instanceof Response) {
  return authResult;
}

const { user, profile } = authResult;

// Limites journali√®res par plan
const DAILY_LIMITS: Record<string, number> = {
  'freemium': 5,
  'premium': 20,
  'premium+': -1,
};
const userDailyLimit = DAILY_LIMITS[profile.plan] || 5;

// R√©cup√©rer le code du salon depuis l'URL
const salonCode = Astro.url.searchParams.get('code');
let salon = null;
let error = null;
let canJoinSalon = false;
let limitInfo: { currentCount?: number; dailyLimit?: number; message?: string } | null = null;

if (salonCode) {
  const supabase = (Astro.locals as { supabase?: any }).supabase;
  if (supabase) {
    salon = await getSalonByCode(supabase, salonCode);
    
    if (!salon) {
      error = 'Salon introuvable. V√©rifie le code.';
    } else if (salon.status === 'completed') {
      // Si le duel est termin√©, rediriger vers les r√©sultats
      return Astro.redirect(`/duel/results?salon=${salon.id}`);
    } else if (salon.status === 'in-progress') {
      // Si le duel est en cours, v√©rifier si l'utilisateur fait partie du duel
      const participants = Array.isArray(salon.participants) ? salon.participants : [];
      const isChef = salon.chef_id === user.id;
      const isParticipant = participants.some((p: any) => p.id === user.id);
      
      if (isChef || isParticipant) {
        // L'utilisateur fait partie du duel, rediriger vers la page de jeu
        return Astro.redirect(`/duel/play?salon=${salon.id}`);
      } else {
        // L'utilisateur n'est pas dans le duel, afficher une erreur
        error = 'Ce duel est d√©j√† en cours. Tu ne peux pas rejoindre un duel d√©j√† commenc√©.';
      }
    } else if (salon.status === 'lobby') {
      // Le salon est en lobby, v√©rifier si c'est le chef
      if (salon.chef_id === user.id) {
        // Le chef est d√©j√† dans le salon, rediriger vers le lobby
        return Astro.redirect(`/duel/lobby?salon=${salon.id}`);
      }
      
      // V√©rifier si l'utilisateur peut rejoindre (limite journali√®re)
      const dailyLimit = DAILY_LIMITS[profile.plan] || DAILY_LIMITS['freemium'];
      
      if (dailyLimit === -1) {
        // Premium+ : acc√®s illimit√©
        canJoinSalon = true;
      } else {
        // V√©rifier la limite via la fonction DB
        const { data: limitCheck } = await supabase
          .rpc('can_join_multiplayer', { p_user_id: user.id });
        
        if (limitCheck && limitCheck.length > 0) {
          const { can_join, current_count, daily_limit } = limitCheck[0];
          canJoinSalon = can_join;
          
          if (!can_join) {
            limitInfo = {
              currentCount: current_count,
              dailyLimit: daily_limit,
              message: `Tu as atteint ta limite de ${daily_limit} parties multijoueur par jour. Passe √† Premium+ pour un acc√®s illimit√© !`
            };
          }
        } else {
          // En cas d'erreur, autoriser par d√©faut
          canJoinSalon = true;
        }
      }
    } else {
      // Autre statut (cancelled, etc.)
      error = 'Ce salon n\'est plus disponible.';
    }
  }
} else {
  error = 'Code de salon manquant.';
}
---

<BaseLayout title="Rejoindre un Salon - Qivana">
  <div class="duel-join">
    <div class="duel-join__container">
      <header class="duel-join__header">
        <h1 class="duel-join__title">Rejoindre un Salon</h1>
        <p class="duel-join__subtitle">Entre le code du salon ou utilise le lien partag√©</p>
      </header>

      {error ? (
        <div class="duel-join__error">
          <p>{error}</p>
          <a href="/duel/create" class="btn btn--primary">
            Cr√©er un salon
          </a>
        </div>
      ) : salon && !canJoinSalon ? (
        <!-- Limite atteinte : afficher les infos du salon mais pas le bouton -->
        <div class="duel-join__success">
          <div class="duel-join__salon-info">
            <h2 class="duel-join__salon-name">{salon.salon_name}</h2>
            <div class="duel-join__salon-details">
              <span>üåç {salon.universe}</span>
              <span>‚ö° {salon.difficulty}</span>
              <span>‚ùì {salon.questions_count} questions</span>
              <span>‚è±Ô∏è {salon.timer_seconds ? `${salon.timer_seconds}s` : 'D√©sactiv√©'}</span>
            </div>
          </div>
          
          <div class="duel-join__limit-reached">
            <p class="duel-join__limit-message">
              üö´ {limitInfo?.message || 'Tu as atteint ta limite journali√®re de parties multijoueur.'}
            </p>
            <a href="/pricing?upgrade=multiplayer" class="btn btn--primary btn--block">
              ‚ú® Passer √† Premium+
            </a>
            <a href="/" class="btn btn--secondary btn--block">
              Retour √† l'accueil
            </a>
          </div>
        </div>
      ) : salon ? (
        <div class="duel-join__success">
          <div class="duel-join__salon-info">
            <h2 class="duel-join__salon-name">{salon.salon_name}</h2>
            <div class="duel-join__salon-details">
              <span>üåç {salon.universe}</span>
              <span>‚ö° {salon.difficulty}</span>
              <span>‚ùì {salon.questions_count} questions</span>
              <span>‚è±Ô∏è {salon.timer_seconds ? `${salon.timer_seconds}s` : 'D√©sactiv√©'}</span>
            </div>
          </div>
          
          <form method="POST" action="/api/duel/join" class="duel-join__form" id="joinForm">
            <input type="hidden" name="salon_id" value={salon.id} />
            <button type="submit" class="btn btn--primary btn--block">
              Rejoindre le salon
            </button>
          </form>
        </div>
      ) : (
        <form method="GET" action="/duel/join" class="duel-join__form" id="codeForm">
          <label for="code" class="duel-join__label">
            Code du salon (6 caract√®res)
          </label>
          <input
            type="text"
            id="code"
            name="code"
            required
            minlength="6"
            maxlength="6"
            pattern="[A-Z0-9]{6}"
            placeholder="Ex: A3B9K2"
            class="duel-join__input"
            style="text-transform: uppercase;"
          />
          <button type="submit" class="btn btn--primary btn--block">
            Rejoindre
          </button>
        </form>
      )}

      <!-- Info limite journali√®re pour les utilisateurs non-Premium+ -->
      {profile.plan !== 'premium+' && !salon && (
        <div class="duel-join__limit-info">
          <p>
            <span class="duel-join__limit-icon">‚ÑπÔ∏è</span>
            Tu peux rejoindre jusqu'√† <strong>{userDailyLimit} parties</strong> par jour avec ton abonnement {profile.plan}.
          </p>
        </div>
      )}
    </div>
  </div>
</BaseLayout>

<script>
  import { showAlert } from '../../lib/showAlert';

  // Convertir automatiquement en majuscules
  const codeInput = document.getElementById('code') as HTMLInputElement;
  if (codeInput) {
    codeInput.addEventListener('input', (e) => {
      const target = e.target as HTMLInputElement;
      target.value = target.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
    });
  }

  // G√©rer le formulaire de join
  const joinForm = document.getElementById('joinForm') as HTMLFormElement;
  if (joinForm) {
    joinForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const formData = new FormData(joinForm);
      const submitButton = joinForm.querySelector('button[type="submit"]') as HTMLButtonElement;
      
      if (submitButton) {
        submitButton.disabled = true;
        submitButton.textContent = 'Rejoindre...';
      }

      try {
        const response = await fetch('/api/duel/join', {
          method: 'POST',
          body: formData,
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Erreur lors de la jonction du salon');
        }

        // Rediriger vers le lobby
        if (data.redirectTo) {
          window.location.href = data.redirectTo;
        } else {
          showAlert({ message: 'Salon rejoint avec succ√®s !', type: 'success' });
          setTimeout(() => {
            window.location.href = '/profile';
          }, 1500);
        }
      } catch (error) {
        console.error('Error joining salon:', error);
        showAlert({ 
          message: error instanceof Error ? error.message : 'Erreur lors de la jonction du salon', 
          type: 'error' 
        });
        
        if (submitButton) {
          submitButton.disabled = false;
          submitButton.textContent = 'Rejoindre le salon';
        }
      }
    });
  }
</script>

<style>
  @import '../../styles/pages/_duel.scss';

  .duel-join {
    min-height: 100vh;
    padding: var(--space-6) var(--space-4);
    background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-indigo) 100%);
  }

  .duel-join__container {
    max-width: var(--container-md);
    margin: 0 auto;
  }

  .duel-join__header {
    text-align: center;
    margin-bottom: var(--space-8);
  }

  .duel-join__title {
    font-family: var(--font-secondary);
    font-size: var(--fs-8);
    font-weight: var(--font-weight-bold);
    color: var(--color-text);
    margin-bottom: var(--space-2);
  }

  .duel-join__subtitle {
    font-size: var(--fs-4);
    color: var(--color-text-muted);
  }

  .duel-join__form {
    background: var(--color-surface);
    border-radius: var(--radius-4);
    padding: var(--space-6);
    box-shadow: var(--shadow-md);
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
  }

  .duel-join__label {
    font-family: var(--font-secondary);
    font-size: var(--fs-4);
    font-weight: var(--font-weight-semibold);
    color: var(--color-text);
  }

  .duel-join__input {
    width: 100%;
    padding: var(--space-3) var(--space-4);
    font-size: var(--fs-5);
    font-weight: var(--font-weight-bold);
    text-align: center;
    letter-spacing: 0.2em;
    color: var(--color-text);
    background: var(--color-neutral-800);
    border: 2px solid var(--color-neutral-700);
    border-radius: var(--radius-2);
    transition: all var(--transition-base);
  }

  .duel-join__input:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
  }

  .duel-join__error {
    background: var(--color-surface);
    border-radius: var(--radius-4);
    padding: var(--space-6);
    box-shadow: var(--shadow-md);
    text-align: center;
    color: var(--color-danger);
  }

  .duel-join__success {
    background: var(--color-surface);
    border-radius: var(--radius-4);
    padding: var(--space-6);
    box-shadow: var(--shadow-md);
  }

  .duel-join__salon-info {
    margin-bottom: var(--space-6);
  }

  .duel-join__salon-name {
    font-family: var(--font-secondary);
    font-size: var(--fs-6);
    font-weight: var(--font-weight-bold);
    color: var(--color-text);
    margin-bottom: var(--space-4);
    text-align: center;
  }

  .duel-join__salon-details {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-3);
    justify-content: center;
  }

  .duel-join__salon-details span {
    padding: var(--space-2) var(--space-3);
    background: var(--color-neutral-800);
    border-radius: var(--radius-2);
    font-size: var(--fs-3);
    color: var(--color-text);
  }

  /* Info limite journali√®re */
  .duel-join__limit-info {
    margin-top: var(--space-4);
    padding: var(--space-4);
    background: var(--color-neutral-800);
    border-radius: var(--radius-3);
    border-left: 4px solid var(--color-warning);
  }

  .duel-join__limit-info p {
    margin: 0;
    font-size: var(--fs-2);
    color: var(--color-text-muted);
    display: flex;
    align-items: center;
    gap: var(--space-2);
    flex-wrap: wrap;
  }

  .duel-join__limit-info strong {
    color: var(--color-warning);
  }

  .duel-join__limit-icon {
    font-size: var(--fs-3);
  }

  /* Message de limite atteinte */
  .duel-join__limit-reached {
    margin-top: var(--space-4);
    padding: var(--space-5);
    background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(220, 38, 38, 0.1) 100%);
    border: 2px solid var(--color-danger);
    border-radius: var(--radius-3);
    text-align: center;
  }

  .duel-join__limit-message {
    font-size: var(--fs-3);
    color: var(--color-text);
    margin-bottom: var(--space-4);
    font-weight: var(--font-weight-semibold);
  }
</style>
