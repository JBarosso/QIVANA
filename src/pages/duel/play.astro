---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { requirePremiumPlus } from '../../lib/auth';
import DuelPlayerSocketIO from '../../components/duel/DuelPlayerSocketIO';
import DuelPlayerBattleRoyal from '../../components/duel/DuelPlayerBattleRoyal';

// Protection de la route - Premium+ uniquement
const authResult = await requirePremiumPlus(Astro);

// Si c'est une redirection, elle a déjà été effectuée
if (authResult instanceof Response) {
  return authResult;
}

const { user, profile } = authResult;

// Récupérer le salon depuis l'URL
const salonId = Astro.url.searchParams.get('salon');
const roomId = Astro.url.searchParams.get('room'); // Code à 6 caractères pour Socket.IO
let salon = null;
let salonCode = null;

// Récupérer supabase
const supabase = (Astro.locals as { supabase?: any }).supabase;

if (salonId && supabase) {
  // Récupérer le salon par ID
  const { data, error } = await supabase
    .from('duel_sessions')
    .select('*')
    .eq('id', salonId)
    .single();

  if (!error && data) {
    salon = data;
    salonCode = data.salon_code;
  }
}

// Si le salon n'existe pas, rediriger
if (!salon) {
  return Astro.redirect('/duel/create?error=salon-not-found');
}

// Utiliser roomId depuis l'URL ou salon_code
const finalRoomId = roomId || salonCode;

if (!finalRoomId) {
  return Astro.redirect('/duel/create?error=room-id-missing');
}

// Vérifier que l'utilisateur fait partie du duel (chef ou participant)
const participants = Array.isArray(salon.participants) ? salon.participants : [];
const isChef = salon.chef_id === user.id;
const isParticipant = participants.some((p: any) => p.id === user.id);

if (!isChef && !isParticipant) {
  return Astro.redirect('/duel/join?error=not-a-participant');
}
---

<BaseLayout title="Duel - Qivana">
  <div class="duel-play">
    <div class="duel-play__container">
      {finalRoomId && (
        salon.game_mode === 'battle_royal' ? (
          <DuelPlayerBattleRoyal
            client:load
            roomId={finalRoomId}
            salonId={salonId || undefined}
            salonName={salon.salon_name}
            currentUserId={user.id}
            currentUserPseudo={profile.pseudo}
            isChef={isChef}
            initialLives={salon.initial_lives || 10}
          />
        ) : (
          <DuelPlayerSocketIO
            client:load
            roomId={finalRoomId}
            salonId={salonId || undefined}
            salonName={salon.salon_name}
            currentUserId={user.id}
            currentUserPseudo={profile.pseudo}
            isChef={isChef}
          />
        )
      )}
    </div>
  </div>
</BaseLayout>

<style>
  @import '../../styles/pages/_duel.scss';

  .duel-play {
    min-height: 100vh;
    padding: var(--space-6) var(--space-4);
    background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-indigo) 100%);
  }

  .duel-play__container {
    max-width: var(--container-lg);
    margin: 0 auto;
  }
</style>
