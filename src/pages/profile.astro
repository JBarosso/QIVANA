---
// ============================================
// PROFILE PAGE (Protected)
// ============================================

import BaseLayout from '@/layouts/BaseLayout.astro';
import { getUser, getProfile } from '@/lib/auth';
import BadgeGrid from '@/components/badges/BadgeGrid';
import type { BadgeData } from '@/components/badges/Badge';

// Type assertion pour supabase
const supabase = (Astro.locals as { supabase?: any }).supabase;

// Require authentication
const user = await getUser(supabase);
if (!user) {
  return Astro.redirect('/auth/login');
}

// Fetch user profile with all fields including duel stats
let profile: any = null;
if (supabase) {
  const { data: profileData, error } = await supabase
    .from('profiles')
    .select('*, total_score, duels_played, duels_won')
    .eq('id', user.id)
    .single();
  
  if (error || !profileData) {
    return Astro.redirect('/auth/login?error=Profil+introuvable');
  }
  
  profile = profileData;
}

// Fetch streak
let streak = null;
if (supabase) {
  const { data: streakData } = await supabase
    .from('streaks')
    .select('*')
    .eq('user_id', user.id)
    .single();
  streak = streakData;
}

  // Fetch all badges
  let allBadges: BadgeData[] = [];
  let unlockedBadgeIds = new Set<string>();
  if (supabase) {
    // R√©cup√©rer tous les badges
    const { data: badgesData } = await supabase
      .from('badges')
      .select('*')
      .order('rarity', { ascending: false });
    
    if (badgesData) {
      allBadges = badgesData.map((b: any) => ({
        id: b.id,
        code: b.code,
        name: b.name,
        description: b.description,
        icon_url: b.icon_url,
        rarity: b.rarity as BadgeData['rarity'],
        category: b.category as BadgeData['category'],
      }));
    }

    // R√©cup√©rer les badges d√©bloqu√©s par l'utilisateur
    const { data: userBadgesData } = await supabase
      .from('user_badges')
      .select('badge_id, unlocked_at')
      .eq('user_id', user.id);
    
    if (userBadgesData) {
      unlockedBadgeIds = new Set(userBadgesData.map((ub: any) => ub.badge_id));
      // Ajouter unlocked_at aux badges d√©bloqu√©s
      allBadges = allBadges.map(badge => {
        const userBadge = userBadgesData.find((ub: any) => ub.badge_id === badge.id);
        return {
          ...badge,
          unlocked_at: userBadge?.unlocked_at || null,
        };
      });
    }
  }

  // Fetch quiz count and solo quiz score
  let quizCount = 0;
  let soloQuizScore = 0;
  if (supabase) {
    const { data: quizData, count } = await supabase
      .from('quiz_sessions')
      .select('score', { count: 'exact' })
      .eq('user_id', user.id)
      .not('completed_at', 'is', null);
    
    quizCount = count || 0;
    
    // Calculer le score solo total
    if (quizData) {
      soloQuizScore = quizData.reduce((acc: number, q: any) => acc + (q.score || 0), 0);
    }
  }

  // Fetch duel stats (from profile or default to 0)
  const profileAny = profile as any;
  let duelsPlayed = profileAny.duels_played || 0;
  let duelsWon = profileAny.duels_won || 0;
  let totalScore = profileAny.total_score || 0;
  
  // V√©rifier si l'utilisateur peut voir les stats de duels (Premium/Premium+ seulement)
  const canAccessDuels = profile.plan === 'premium' || profile.plan === 'premium+';
---

<BaseLayout
  title={`${profile.pseudo} - Profile`}
  description="Votre profil Qivana"
>
  <main class="profile-page">
    <div class="container">
      <div class="profile-card">
        <div class="profile-card__header">
          <div class="profile-avatar">
            {profile.avatar ? (
              <img
                src={profile.avatar}
                alt={`Avatar de ${profile.pseudo}`}
                class="profile-avatar__img"
              />
            ) : (
              <div class="profile-avatar__placeholder">
                {profile.pseudo.charAt(0).toUpperCase()}
              </div>
            )}
          </div>
          <div class="profile-info">
            <h1 class="profile-info__name">{profile.pseudo}</h1>
            <p class="profile-info__email">{user.email}</p>
            <div class="profile-badge">
              <span class="profile-badge__label">
                {profile.plan === 'freemium' && 'üÜì Freemium'}
                {profile.plan === 'premium' && '‚≠ê Premium'}
                {profile.plan === 'premium+' && 'üíé Premium+'}
              </span>
            </div>
          </div>
        </div>

        <div class="profile-card__stats">
          {/* Points Solo (quiz) */}
          <div class="stat-card">
            <div class="stat-card__icon">üìä</div>
            <div class="stat-card__value">{Math.round(soloQuizScore)}</div>
            <div class="stat-card__label">Points Solo</div>
          </div>

          {/* Quiz jou√©s */}
          {quizCount > 0 && (
            <div class="stat-card">
              <div class="stat-card__icon">üéØ</div>
              <div class="stat-card__value">{quizCount}</div>
              <div class="stat-card__label">Quiz jou√©s</div>
            </div>
          )}

          {/* Streak - affich√© seulement si existe */}
          {streak && streak.current_streak > 0 && (
            <div class="stat-card stat-card--streak">
              <div class="stat-card__icon stat-card__icon--fire">üî•</div>
              <div class="stat-card__value">{streak.current_streak}</div>
              <div class="stat-card__label">Streak actuel</div>
              {streak.longest_streak > streak.current_streak && (
                <div class="stat-card__subtext">Record: {streak.longest_streak} jours</div>
              )}
            </div>
          )}

          {/* Duels - affich√© seulement pour Premium/Premium+ et si > 0 */}
          {canAccessDuels && duelsPlayed > 0 && (
            <div class="stat-card">
              <div class="stat-card__icon">‚öîÔ∏è</div>
              <div class="stat-card__value">{duelsPlayed}</div>
              <div class="stat-card__label">Duels jou√©s</div>
            </div>
          )}

          {canAccessDuels && duelsWon > 0 && (
            <div class="stat-card">
              <div class="stat-card__icon">üëë</div>
              <div class="stat-card__value">{duelsWon}</div>
              <div class="stat-card__label">Duels gagn√©s</div>
            </div>
          )}

          {/* Quiz AI ce mois - affich√© seulement si > 0 */}
          {profile.ai_quizzes_used_this_month > 0 && (
            <div class="stat-card">
              <div class="stat-card__icon">‚ú®</div>
              <div class="stat-card__value">{profile.ai_quizzes_used_this_month}</div>
              <div class="stat-card__label">Quiz AI ce mois</div>
            </div>
          )}
        </div>

        <div class="profile-card__actions">
          <a href="/" class="btn btn--secondary">
            <span class="btn__text">Retour √† l'accueil</span>
          </a>
          <a href="/profile/edit" class="btn btn--primary">
            <span class="btn__text">‚úèÔ∏è √âditer le profil</span>
          </a>
          <button 
            class="btn btn--outline" 
            id="share-profile-btn"
            data-url={`${Astro.url.origin}/profile/${profile.slug}`}
          >
            <span class="btn__text">üì§ Partager</span>
          </button>
          <a href="/auth/logout" class="btn btn--outline">
            <span class="btn__text">Se d√©connecter</span>
          </a>
        </div>
      </div>

      <div class="profile-section">
        <h2 class="profile-section__title">Mes badges</h2>
        <BadgeGrid 
          client:load
          badges={JSON.stringify(allBadges)}
          unlockedBadgeIds={JSON.stringify(Array.from(unlockedBadgeIds))}
          showLocked={true}
        />
      </div>

      <div class="profile-section">
        <h2 class="profile-section__title">Informations du compte</h2>
        <div class="info-list">
          <div class="info-item">
            <span class="info-item__label">Inscrit le</span>
            <span class="info-item__value">
              {new Date(profile.created_at).toLocaleDateString('fr-FR', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
              })}
            </span>
          </div>
          <div class="info-item">
            <span class="info-item__label">Plan</span>
            <span class="info-item__value capitalize">{profile.plan}</span>
          </div>
          <div class="info-item">
            <span class="info-item__label">Quota AI</span>
            <span class="info-item__value">
              {profile.plan === 'freemium' && '0 quiz AI/mois'}
              {profile.plan === 'premium' && '10 quiz AI/mois'}
              {profile.plan === 'premium+' && 'Illimit√©'}
            </span>
          </div>
        </div>
      </div>
    </div>
  </main>
</BaseLayout>

<script>
  const shareBtn = document.getElementById('share-profile-btn');
  if (shareBtn) {
    shareBtn.addEventListener('click', async () => {
      const url = shareBtn.getAttribute('data-url');
      
      if (navigator.share) {
        try {
          await navigator.share({
            title: 'Mon profil Qivana',
            url: url || window.location.href,
          });
        } catch (err) {
          // User cancelled
        }
      } else {
        // Fallback: copier dans le presse-papier
        try {
          await navigator.clipboard.writeText(url || window.location.href);
          alert('Lien copi√© dans le presse-papier !');
        } catch (err) {
          alert('Impossible de copier le lien');
        }
      }
    });
  }
</script>

<style lang="scss">
  .profile-page {
    min-height: 100vh;
    padding: var(--space-8) 0;
  }

  .profile-card {
    background: var(--color-surface);
    border-radius: var(--radius-4);
    padding: var(--space-6);
    box-shadow: var(--shadow-md);
    margin-bottom: var(--space-6);
  }

  .profile-card__header {
    display: flex;
    align-items: center;
    gap: var(--space-4);
    margin-bottom: var(--space-6);
    padding-bottom: var(--space-6);
    border-bottom: 1px solid var(--color-border);
  }

  .profile-avatar {
    flex-shrink: 0;
  }

  .profile-avatar__img,
  .profile-avatar__placeholder {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    object-fit: cover;
  }

  .profile-avatar__placeholder {
    display: flex;
    align-items: center;
    justify-content: center;
    background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
    color: var(--color-text-on-primary);
    font-size: var(--fs-8);
    font-weight: var(--font-weight-bold);
  }

  .profile-info__name {
    font-family: var(--font-secondary);
    font-size: var(--fs-7);
    color: var(--color-text);
    margin-bottom: var(--space-2);
  }

  .profile-info__email {
    font-size: var(--fs-2);
    color: var(--color-text-muted);
    margin-bottom: var(--space-3);
  }

  .profile-badge {
    display: inline-flex;
  }

  .profile-badge__label {
    padding: var(--space-2) var(--space-3);
    background: var(--color-accent);
    color: var(--color-text);
    border-radius: var(--radius-2);
    font-size: var(--fs-1);
    font-weight: var(--font-weight-medium);
  }

  .profile-card__stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: var(--space-4);
    margin-bottom: var(--space-6);
  }

  .stat-card {
    background: var(--color-background);
    border-radius: var(--radius-3);
    padding: var(--space-4);
    text-align: center;
  }

  .stat-card__icon {
    font-size: var(--fs-8);
    margin-bottom: var(--space-2);
  }

  .stat-card__value {
    font-size: var(--fs-7);
    font-weight: var(--font-weight-bold);
    color: var(--color-primary);
    margin-bottom: var(--space-1);
  }

  .stat-card__label {
    font-size: var(--fs-2);
    color: var(--color-text-muted);
  }

  .stat-card__subtext {
    font-size: var(--fs-1);
    color: var(--color-text-muted);
    margin-top: var(--space-1);
    font-style: italic;
  }

  .stat-card--streak {
    position: relative;
    background: linear-gradient(135deg, rgba(250, 204, 21, 0.1), rgba(236, 72, 153, 0.1));
    border: 1px solid rgba(250, 204, 21, 0.3);
  }

  .stat-card__icon--fire {
    animation: fire-glow 2s ease-in-out infinite;
  }

  @keyframes fire-glow {
    0%, 100% {
      filter: drop-shadow(0 0 4px rgba(250, 204, 21, 0.6));
      transform: scale(1);
    }
    50% {
      filter: drop-shadow(0 0 8px rgba(250, 204, 21, 0.9));
      transform: scale(1.1);
    }
  }

  .profile-card__actions {
    display: flex;
    gap: var(--space-3);
    flex-wrap: wrap;
  }

  .profile-section {
    background: var(--color-surface);
    border-radius: var(--radius-4);
    padding: var(--space-6);
    box-shadow: var(--shadow-md);
  }

  .profile-section__title {
    font-family: var(--font-secondary);
    font-size: var(--fs-5);
    color: var(--color-text);
    margin-bottom: var(--space-4);
  }

  .info-list {
    display: flex;
    flex-direction: column;
    gap: var(--space-3);
  }

  .info-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-3);
    background: var(--color-background);
    border-radius: var(--radius-2);
  }

  .info-item__label {
    font-size: var(--fs-2);
    color: var(--color-text-muted);
  }

  .info-item__value {
    font-size: var(--fs-2);
    color: var(--color-text);
    font-weight: var(--font-weight-medium);
  }

  .capitalize {
    text-transform: capitalize;
  }
</style>
