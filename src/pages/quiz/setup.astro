---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { requireAuth } from '../../lib/auth';

// Protection de la route
const authResult = await requireAuth(Astro);

// Si c'est une redirection, elle a d√©j√† √©t√© effectu√©e
if (authResult instanceof Response) {
  return authResult;
}

const { user, profile } = authResult;

// D√©finir les univers et difficult√©s disponibles
const universes = [
  { id: 'anime', label: 'üéå Anime', icon: 'üéå' },
  { id: 'manga', label: 'üìö Manga', icon: 'üìö' },
  { id: 'comics', label: 'ü¶∏ Comics', icon: 'ü¶∏' },
  { id: 'games', label: 'üéÆ Jeux Vid√©o', icon: 'üéÆ' },
  { id: 'movies', label: 'üé¨ Films', icon: 'üé¨' },
  { id: 'series', label: 'üì∫ S√©ries', icon: 'üì∫' },
  { id: 'other', label: 'üåü Autre', icon: 'üåü' },
];

const difficulties = [
  { id: 'easy', label: 'Facile', description: 'Pour d√©buter', color: 'success' },
  { id: 'medium', label: 'Moyen', description: 'Un peu de challenge', color: 'warning' },
  { id: 'hard', label: 'Difficile', description: 'Pour les experts', color: 'danger' },
];
---

<BaseLayout title="Nouveau Quiz - Qivana">
  <div class="quiz-setup">
    <div class="quiz-setup__container">
      <header class="quiz-setup__header">
        <h1 class="quiz-setup__title">Nouveau Quiz</h1>
        <p class="quiz-setup__subtitle">Choisis ton univers et ta difficult√©</p>
      </header>

      <!-- Message d'erreur (si stock insuffisant pour Freemium) -->
      <!-- Note: L'alerte est maintenant g√©r√©e par showAlert() dans le script pour coh√©rence -->

      <form method="POST" action="/api/quiz/start" class="quiz-setup__form" id="quizSetupForm">
        <!-- S√©lection Univers -->
        <section class="quiz-setup__section">
          <h2 class="quiz-setup__section-title">
            <span class="quiz-setup__section-icon">üåç</span>
            Univers
          </h2>
          <div class="quiz-setup__grid">
            {universes.map((universe) => (
              <label class="quiz-card">
                <input
                  type="radio"
                  name="universe"
                  value={universe.id}
                  required
                  class="quiz-card__input"
                />
                <div class="quiz-card__content">
                  <span class="quiz-card__icon">{universe.icon}</span>
                  <span class="quiz-card__label">{universe.label}</span>
                </div>
              </label>
            ))}
          </div>
        </section>

        <!-- S√©lection Difficult√© -->
        <section class="quiz-setup__section">
          <h2 class="quiz-setup__section-title">
            <span class="quiz-setup__section-icon">‚ö°</span>
            Difficult√©
          </h2>
          <div class="quiz-setup__difficulty-grid">
            {difficulties.map((difficulty) => (
              <label class={`difficulty-card difficulty-card--${difficulty.color}`}>
                <input
                  type="radio"
                  name="difficulty"
                  value={difficulty.id}
                  required
                  class="difficulty-card__input"
                />
                <div class="difficulty-card__content">
                  <span class="difficulty-card__label">{difficulty.label}</span>
                  <span class="difficulty-card__description">{difficulty.description}</span>
                </div>
              </label>
            ))}
          </div>
        </section>

        <!-- S√©lection Timer (selon plan) -->
        {profile.plan !== 'freemium' && (
          <section class="quiz-setup__section">
            <h2 class="quiz-setup__section-title">
              <span class="quiz-setup__section-icon">‚è±Ô∏è</span>
              Timer
            </h2>
            {profile.plan === 'premium' ? (
              <!-- Premium : Boutons radio 5/10/15s -->
              <div class="quiz-setup__difficulty-grid">
                <label class="difficulty-card difficulty-card--primary">
                  <input
                    type="radio"
                    name="timer"
                    value="5"
                    required
                    class="difficulty-card__input"
                    checked
                  />
                  <div class="difficulty-card__content">
                    <span class="difficulty-card__label">5 secondes</span>
                    <span class="difficulty-card__description">Rapide ‚ö°</span>
                  </div>
                </label>
                <label class="difficulty-card difficulty-card--primary">
                  <input
                    type="radio"
                    name="timer"
                    value="10"
                    required
                    class="difficulty-card__input"
                  />
                  <div class="difficulty-card__content">
                    <span class="difficulty-card__label">10 secondes</span>
                    <span class="difficulty-card__description">Standard üéØ</span>
                  </div>
                </label>
                <label class="difficulty-card difficulty-card--primary">
                  <input
                    type="radio"
                    name="timer"
                    value="15"
                    required
                    class="difficulty-card__input"
                  />
                  <div class="difficulty-card__content">
                    <span class="difficulty-card__label">15 secondes</span>
                    <span class="difficulty-card__description">Confortable üßò</span>
                  </div>
                </label>
              </div>
            ) : (
              <!-- Premium+ : Slider 3-20s -->
              <div class="quiz-setup__timer-slider">
                <input
                  type="range"
                  name="timer"
                  id="timer-slider"
                  min="3"
                  max="20"
                  value="10"
                  required
                  class="quiz-setup__timer-input"
                />
                <div class="quiz-setup__timer-display">
                  <label for="timer-slider" class="quiz-setup__timer-label">
                    <span id="timer-value">10</span> secondes
                  </label>
                </div>
                <script>
                  // Mettre √† jour l'affichage du timer en temps r√©el
                  const slider = document.getElementById('timer-slider');
                  const valueDisplay = document.getElementById('timer-value');
                  if (slider && valueDisplay) {
                    slider.addEventListener('input', (e) => {
                      const target = e.target;
                      if (target && target instanceof HTMLInputElement) {
                        valueDisplay.textContent = target.value;
                      }
                    });
                  }
                </script>
              </div>
            )}
          </section>
        )}

        <!-- Info Plan -->
        <div class="quiz-setup__info">
          <div class="quiz-setup__info-icon">‚ÑπÔ∏è</div>
          <div class="quiz-setup__info-content">
            {profile.plan === 'freemium' ? (
              <>
                <strong>Mode Freemium</strong>
                <p>10 questions ‚Ä¢ Timer 10s ‚Ä¢ Step-by-step</p>
                <p class="quiz-setup__info-note">üí° Passe Premium pour d√©bloquer la g√©n√©ration IA automatique</p>
              </>
            ) : (
              <>
                <strong>Mode {profile.plan === 'premium' ? 'Premium' : 'Premium+'}</strong>
                <p>10 questions ‚Ä¢ Timer {profile.plan === 'premium' ? '5/10/15s' : profile.plan === 'premium+' ? '3-20s' : '10s'} ‚Ä¢ Step-by-step</p>
                <p class="quiz-setup__info-note">‚ú® G√©n√©ration IA automatique si stock insuffisant</p>
              </>
            )}
          </div>
        </div>

        <!-- Actions -->
        <div class="quiz-setup__actions">
          <a href="/" class="btn btn--secondary">Annuler</a>
          <button type="submit" class="btn btn--primary">
            Lancer le Quiz üöÄ
          </button>
        </div>
      </form>

      <!-- Loading overlay (pour g√©n√©ration IA) -->
      <div class="loading-overlay" id="loadingOverlay" style="display: none;">
        <div class="loading-spinner">
          <div class="spinner"></div>
          <p class="loading-text">‚ú® Pr√©paration de ton quiz...</p>
          <p class="loading-subtext" id="loadingSubtext">Chargement des questions</p>
        </div>
      </div>
    </div>
  </div>
</BaseLayout>

<style lang="scss">
@use '../../styles/pages/quiz' as *;

.quiz-setup__error {
  margin-bottom: var(--space-6);
  padding: var(--space-4);
  background: hsl(45, 100%, 95%);
  border: 1px solid hsl(45, 100%, 60%);
  border-radius: var(--radius-3);
  display: flex;
  gap: var(--space-3);
  align-items: flex-start;
}

.quiz-setup__error-icon {
  font-size: var(--fs-5);
  flex-shrink: 0;
}

.quiz-setup__error-content {
  flex: 1;

  strong {
    display: block;
    font-weight: var(--font-weight-bold);
    color: hsl(45, 100%, 20%);
    margin-bottom: var(--space-1);
  }

  p {
    font-size: var(--fs-2);
    color: hsl(45, 100%, 30%);
    margin: 0;
  }
}

.quiz-setup__info-note {
  margin-top: var(--space-2);
  font-size: var(--fs-1);
  color: var(--color-text-muted);
  font-style: italic;
}

// Timer slider (Premium+)
.quiz-setup__timer-slider {
  display: flex;
  flex-direction: column;
  gap: var(--space-3);
  padding: var(--space-4);
  background: var(--color-background);
  border-radius: var(--radius-3);
}

.quiz-setup__timer-input {
  width: 100%;
  height: var(--space-2);
  border-radius: var(--radius-full);
  background: var(--color-neutral-700);
  outline: none;
  -webkit-appearance: none;
  appearance: none;
  
  &::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: var(--space-5);
    height: var(--space-5);
    border-radius: var(--radius-full);
    background: var(--color-primary);
    cursor: pointer;
    box-shadow: var(--shadow-sm);
    transition: all var(--transition-base);
    
    &:hover {
      transform: scale(1.1);
      box-shadow: var(--shadow-md);
    }
  }
  
  &::-moz-range-thumb {
    width: var(--space-5);
    height: var(--space-5);
    border-radius: var(--radius-full);
    background: var(--color-primary);
    cursor: pointer;
    border: none;
    box-shadow: var(--shadow-sm);
    transition: all var(--transition-base);
    
    &:hover {
      transform: scale(1.1);
      box-shadow: var(--shadow-md);
    }
  }
}

.quiz-setup__timer-display {
  text-align: center;
}

.quiz-setup__timer-label {
  font-size: var(--fs-4);
  font-weight: var(--font-weight-bold);
  color: var(--color-text);
  display: block;
}

// Loading overlay styles
.loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.85);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  backdrop-filter: blur(4px);
}

.loading-spinner {
  text-align: center;
  padding: var(--space-6);
}

.spinner {
  width: 64px;
  height: 64px;
  border: 6px solid var(--color-surface);
  border-top-color: var(--color-primary);
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin: 0 auto var(--space-4);
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.loading-text {
  font-size: var(--fs-5);
  color: var(--color-text);
  margin-bottom: var(--space-2);
}

.loading-subtext {
  font-size: var(--fs-2);
  color: var(--color-text-muted);
}
</style>

<script>
  // Gestion des erreurs depuis l'API
  // ‚ö†Ô∏è IMPORTANT : Emp√™cher le comportement par d√©faut pour g√©rer toutes les erreurs
  const form = document.getElementById('quizSetupForm') as HTMLFormElement;
  const loadingOverlay = document.getElementById('loadingOverlay');
  const loadingSubtext = document.getElementById('loadingSubtext');
  
  // Fonction pour afficher/masquer le loader
  function showLoader(show: boolean, message?: string) {
    if (loadingOverlay) {
      loadingOverlay.style.display = show ? 'flex' : 'none';
    }
    if (loadingSubtext && message) {
      loadingSubtext.textContent = message;
    }
  }
  
  if (form) {
    form.addEventListener('submit', async (e) => {
      // ‚ö†Ô∏è BLOQUER le comportement par d√©faut pour g√©rer toutes les r√©ponses
      e.preventDefault();
      
      const formData = new FormData(form);
      const submitButton = form.querySelector('button[type="submit"]') as HTMLButtonElement;
      
      // D√©sactiver le bouton et afficher le loader
      if (submitButton) {
        submitButton.disabled = true;
        submitButton.textContent = 'Chargement...';
      }
      
      // Afficher le loader
      showLoader(true, 'Recherche des questions en base...');
      
      try {
        // Mettre √† jour le message apr√®s 2 secondes (indication de g√©n√©ration IA possible)
        const aiTimeout = setTimeout(() => {
          showLoader(true, '‚ú® G√©n√©ration de questions via IA en cours...');
        }, 2000);
        
        const response = await fetch('/api/quiz/start', {
          method: 'POST',
          body: formData,
          redirect: 'manual', // Ne pas suivre automatiquement
        });
        
        // Annuler le timeout si la r√©ponse arrive avant
        clearTimeout(aiTimeout);

        console.log('üì° Response status:', response.status);
        console.log('üì° Response type:', response.type);
        console.log('üì° Response headers:', [...response.headers.entries()]);

        // Si redirection (status 302/303) ‚Üí Succ√®s, suivre la redirection
        // Avec redirect: 'manual', le status peut √™tre 0, 302, ou autre selon le navigateur
        if (response.status >= 300 && response.status < 400) {
          const location = response.headers.get('Location');
          console.log('üìç Location header:', location);
          if (location) {
            console.log('‚úÖ Redirection vers:', location);
            window.location.href = location;
            return;
          }
        }

        // Si status 0 avec redirect: 'manual', c'est souvent une redirection bloqu√©e
        // On peut essayer de r√©cup√©rer l'URL depuis response.url
        if (response.status === 0 || response.type === 'opaqueredirect') {
          console.log('‚ö†Ô∏è Status 0 ou opaqueredirect d√©tect√©');
          // Essayer de r√©cup√©rer depuis response.url (peut contenir la redirection)
          const responseUrl = response.url;
          if (responseUrl && responseUrl !== window.location.href) {
            console.log('‚úÖ Redirection depuis response.url:', responseUrl);
            window.location.href = responseUrl;
            return;
          }
        }

        // Si erreur (status 4xx/5xx) ‚Üí Afficher l'erreur et NE PAS lancer le quiz
        if (!response.ok) {
          const contentType = response.headers.get('content-type');
          
          // Masquer le loader et r√©activer le bouton
          showLoader(false);
          if (submitButton) {
            submitButton.disabled = false;
            submitButton.textContent = 'Lancer le Quiz üöÄ';
          }
          
          // Charger showAlert dynamiquement
          const { showAlert } = await import('@lib/showAlert');
          
          if (contentType && contentType.includes('application/json')) {
            const data = await response.json().catch(() => ({ error: 'Erreur inconnue' }));
            
            if (data.requiresPremium) {
              // Afficher le modal d'upgrade au lieu d'une alerte
              window.dispatchEvent(new CustomEvent('show-upgrade-modal', {
                detail: {
                  feature: 'les quiz personnalis√©s',
                  requiredPlan: 'premium'
                }
              }));
              
              return; // ‚ö†Ô∏è IMPORTANT : Ne pas continuer, le quiz ne doit PAS se lancer
            }
            
            // Autre erreur JSON
            showAlert({
              type: 'error',
              message: data.message || data.error || 'Erreur lors du d√©marrage du quiz',
              duration: 0,
            });
            return; // ‚ö†Ô∏è IMPORTANT : Ne pas continuer
          }
          
          // Erreur non-JSON
          const text = await response.text();
          showAlert({
            type: 'error',
            message: text || 'Erreur lors du d√©marrage du quiz',
            duration: 0,
          });
          return; // ‚ö†Ô∏è IMPORTANT : Ne pas continuer
        }

        // Succ√®s : v√©rifier si c'est une r√©ponse JSON avec redirectTo
        const contentType = response.headers.get('content-type');
        if (contentType && contentType.includes('application/json')) {
          const data = await response.json().catch(() => null);
          
          if (data && data.success && data.redirectTo) {
            // R√©ponse JSON avec redirection
            console.log('‚úÖ Redirection depuis JSON:', data.redirectTo);
            window.location.href = data.redirectTo;
            return;
          }
        }

        // Fallback : Si redirection HTTP (status 302/303)
        const location = response.headers.get('Location');
        console.log('üìç Location header (succ√®s):', location);
        
        if (location) {
          console.log('‚úÖ Redirection vers:', location);
          window.location.href = location;
        } else if (response.status === 200 || response.status === 0) {
          // Si status 200 ou 0, peut-√™tre que la redirection est dans response.url
          const responseUrl = response.url;
          console.log('üì° Response URL:', responseUrl);
          
          // Si l'URL de r√©ponse est diff√©rente de l'URL actuelle, c'est probablement une redirection
          if (responseUrl && responseUrl !== window.location.href && responseUrl.includes('/quiz/play')) {
            console.log('‚úÖ Redirection depuis response.url:', responseUrl);
            window.location.href = responseUrl;
          } else {
            // Pas de redirect ? Erreur inattendue
            console.error('‚ùå Pas de redirection d√©tect√©e. Status:', response.status, 'URL:', responseUrl);
            const { showAlert } = await import('@lib/showAlert');
            showAlert({
              type: 'error',
              message: 'R√©ponse inattendue du serveur. Veuillez r√©essayer.',
              duration: 0,
            });
            
            showLoader(false);
            if (submitButton) {
              submitButton.disabled = false;
              submitButton.textContent = 'Lancer le Quiz üöÄ';
            }
          }
        } else {
          // Autre status inattendu
          console.error('‚ùå Status inattendu:', response.status);
          const { showAlert } = await import('@lib/showAlert');
          showAlert({
            type: 'error',
            message: `R√©ponse inattendue du serveur (status: ${response.status})`,
            duration: 0,
          });
          
          showLoader(false);
          if (submitButton) {
            submitButton.disabled = false;
            submitButton.textContent = 'Lancer le Quiz üöÄ';
          }
        }
      } catch (error) {
        console.error('Error submitting form:', error);
        
        // Masquer le loader et r√©activer le bouton
        showLoader(false);
        if (submitButton) {
          submitButton.disabled = false;
          submitButton.textContent = 'Lancer le Quiz üöÄ';
        }
        
        // Afficher l'erreur avec showAlert
        const { showAlert } = await import('@lib/showAlert');
        showAlert({
          type: 'error',
          message: 'Erreur lors du d√©marrage du quiz. Veuillez r√©essayer.',
          duration: 0,
        });
      }
    });
  }
</script>
