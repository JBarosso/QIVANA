---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { requireAuth } from '../../lib/auth';

// Protection de la route
const authResult = await requireAuth(Astro);

// Si c'est une redirection, elle a dÃ©jÃ  Ã©tÃ© effectuÃ©e
if (authResult instanceof Response) {
  return authResult;
}

const { user, profile } = authResult;

// DÃ©finir les univers et difficultÃ©s disponibles
const universes = [
  { id: 'anime', label: 'ğŸŒ Anime', icon: 'ğŸŒ' },
  { id: 'manga', label: 'ğŸ“š Manga', icon: 'ğŸ“š' },
  { id: 'comics', label: 'ğŸ¦¸ Comics', icon: 'ğŸ¦¸' },
  { id: 'games', label: 'ğŸ® Jeux VidÃ©o', icon: 'ğŸ®' },
  { id: 'movies', label: 'ğŸ¬ Films', icon: 'ğŸ¬' },
  { id: 'series', label: 'ğŸ“º SÃ©ries', icon: 'ğŸ“º' },
  { id: 'other', label: 'ğŸŒŸ Autre', icon: 'ğŸŒŸ' },
];

const difficulties = [
  { id: 'easy', label: 'Facile', description: 'Pour dÃ©buter', color: 'success' },
  { id: 'medium', label: 'Moyen', description: 'Un peu de challenge', color: 'warning' },
  { id: 'hard', label: 'Difficile', description: 'Pour les experts', color: 'danger' },
];
---

<BaseLayout title="Nouveau Quiz - Qivana">
  <div class="quiz-setup">
    <div class="quiz-setup__container">
      <header class="quiz-setup__header">
        <h1 class="quiz-setup__title">Nouveau Quiz</h1>
        <p class="quiz-setup__subtitle">Choisis ton univers et ta difficultÃ©</p>
      </header>

      <!-- Message d'erreur (si stock insuffisant pour Freemium) -->
      <!-- Note: L'alerte est maintenant gÃ©rÃ©e par showAlert() dans le script pour cohÃ©rence -->

      <form method="POST" action="/api/quiz/start" class="quiz-setup__form" id="quizSetupForm">
        <!-- SÃ©lection Univers -->
        <section class="quiz-setup__section">
          <h2 class="quiz-setup__section-title">
            <span class="quiz-setup__section-icon">ğŸŒ</span>
            Univers
          </h2>
          <div class="quiz-setup__grid">
            {universes.map((universe) => (
              <label class="quiz-card">
                <input
                  type="radio"
                  name="universe"
                  value={universe.id}
                  required
                  class="quiz-card__input"
                />
                <div class="quiz-card__content">
                  <span class="quiz-card__icon">{universe.icon}</span>
                  <span class="quiz-card__label">{universe.label}</span>
                </div>
              </label>
            ))}
          </div>
        </section>

        <!-- SÃ©lection DifficultÃ© -->
        <section class="quiz-setup__section">
          <h2 class="quiz-setup__section-title">
            <span class="quiz-setup__section-icon">âš¡</span>
            DifficultÃ©
          </h2>
          <div class="quiz-setup__difficulty-grid">
            {difficulties.map((difficulty) => (
              <label class={`difficulty-card difficulty-card--${difficulty.color}`}>
                <input
                  type="radio"
                  name="difficulty"
                  value={difficulty.id}
                  required
                  class="difficulty-card__input"
                />
                <div class="difficulty-card__content">
                  <span class="difficulty-card__label">{difficulty.label}</span>
                  <span class="difficulty-card__description">{difficulty.description}</span>
                </div>
              </label>
            ))}
          </div>
        </section>

        <!-- Info Plan -->
        <div class="quiz-setup__info">
          <div class="quiz-setup__info-icon">â„¹ï¸</div>
          <div class="quiz-setup__info-content">
            {profile.plan === 'freemium' ? (
              <>
                <strong>Mode Freemium</strong>
                <p>10 questions â€¢ Timer 10s â€¢ Step-by-step</p>
                <p class="quiz-setup__info-note">ğŸ’¡ Passe Premium pour dÃ©bloquer la gÃ©nÃ©ration IA automatique</p>
              </>
            ) : (
              <>
                <strong>Mode {profile.plan === 'premium' ? 'Premium' : 'Premium+'}</strong>
                <p>10 questions â€¢ Timer {profile.plan === 'premium' ? '5/10/15s' : '3-20s'} â€¢ {profile.plan === 'premium+' ? 'All-in-one disponible' : 'Step-by-step'}</p>
                <p class="quiz-setup__info-note">âœ¨ GÃ©nÃ©ration IA automatique si stock insuffisant</p>
              </>
            )}
          </div>
        </div>

        <!-- Actions -->
        <div class="quiz-setup__actions">
          <a href="/" class="btn btn--secondary">Annuler</a>
          <button type="submit" class="btn btn--primary">
            Lancer le Quiz ğŸš€
          </button>
        </div>
      </form>
    </div>
  </div>
</BaseLayout>

<style lang="scss">
@use '../../styles/pages/quiz' as *;

.quiz-setup__error {
  margin-bottom: var(--space-6);
  padding: var(--space-4);
  background: hsl(45, 100%, 95%);
  border: 1px solid hsl(45, 100%, 60%);
  border-radius: var(--radius-3);
  display: flex;
  gap: var(--space-3);
  align-items: flex-start;
}

.quiz-setup__error-icon {
  font-size: var(--fs-5);
  flex-shrink: 0;
}

.quiz-setup__error-content {
  flex: 1;

  strong {
    display: block;
    font-weight: var(--font-weight-bold);
    color: hsl(45, 100%, 20%);
    margin-bottom: var(--space-1);
  }

  p {
    font-size: var(--fs-2);
    color: hsl(45, 100%, 30%);
    margin: 0;
  }
}

.quiz-setup__info-note {
  margin-top: var(--space-2);
  font-size: var(--fs-1);
  color: var(--color-text-muted);
  font-style: italic;
}
</style>

<script>
  // Gestion des erreurs depuis l'API
  // âš ï¸ IMPORTANT : EmpÃªcher le comportement par dÃ©faut pour gÃ©rer toutes les erreurs
  const form = document.getElementById('quizSetupForm') as HTMLFormElement;
  
  if (form) {
    form.addEventListener('submit', async (e) => {
      // âš ï¸ BLOQUER le comportement par dÃ©faut pour gÃ©rer toutes les rÃ©ponses
      e.preventDefault();
      
      const formData = new FormData(form);
      const submitButton = form.querySelector('button[type="submit"]') as HTMLButtonElement;
      
      // DÃ©sactiver le bouton pendant le traitement
      if (submitButton) {
        submitButton.disabled = true;
        submitButton.textContent = 'Chargement...';
      }
      
      try {
        const response = await fetch('/api/quiz/start', {
          method: 'POST',
          body: formData,
          redirect: 'manual', // Ne pas suivre automatiquement
        });

        console.log('ğŸ“¡ Response status:', response.status);
        console.log('ğŸ“¡ Response type:', response.type);
        console.log('ğŸ“¡ Response headers:', [...response.headers.entries()]);

        // Si redirection (status 302/303) â†’ SuccÃ¨s, suivre la redirection
        // Avec redirect: 'manual', le status peut Ãªtre 0, 302, ou autre selon le navigateur
        if (response.status >= 300 && response.status < 400) {
          const location = response.headers.get('Location');
          console.log('ğŸ“ Location header:', location);
          if (location) {
            console.log('âœ… Redirection vers:', location);
            window.location.href = location;
            return;
          }
        }

        // Si status 0 avec redirect: 'manual', c'est souvent une redirection bloquÃ©e
        // On peut essayer de rÃ©cupÃ©rer l'URL depuis response.url
        if (response.status === 0 || response.type === 'opaqueredirect') {
          console.log('âš ï¸ Status 0 ou opaqueredirect dÃ©tectÃ©');
          // Essayer de rÃ©cupÃ©rer depuis response.url (peut contenir la redirection)
          const responseUrl = response.url;
          if (responseUrl && responseUrl !== window.location.href) {
            console.log('âœ… Redirection depuis response.url:', responseUrl);
            window.location.href = responseUrl;
            return;
          }
        }

        // Si erreur (status 4xx/5xx) â†’ Afficher l'erreur et NE PAS lancer le quiz
        if (!response.ok) {
          const contentType = response.headers.get('content-type');
          
          // RÃ©activer le bouton
          if (submitButton) {
            submitButton.disabled = false;
            submitButton.textContent = 'Lancer le Quiz ğŸš€';
          }
          
          // Charger showAlert dynamiquement
          const { showAlert } = await import('@lib/showAlert');
          
          if (contentType && contentType.includes('application/json')) {
            const data = await response.json().catch(() => ({ error: 'Erreur inconnue' }));
            
            if (data.requiresPremium) {
              // Afficher l'alerte avec showAlert (cohÃ©rent avec le reste de l'app)
              showAlert({
                type: 'warning',
                message: data.message || 'Stock insuffisant. Passe Premium pour dÃ©bloquer la gÃ©nÃ©ration IA.',
                duration: 0, // Pas d'auto-dismiss pour les warnings
              });
              
              // Optionnel : Ajouter le paramÃ¨tre d'erreur dans l'URL pour persistance
              const url = new URL(window.location.href);
              url.searchParams.set('error', 'stock_insufficient');
              window.history.replaceState({}, '', url.toString());
              
              return; // âš ï¸ IMPORTANT : Ne pas continuer, le quiz ne doit PAS se lancer
            }
            
            // Autre erreur JSON
            showAlert({
              type: 'error',
              message: data.message || data.error || 'Erreur lors du dÃ©marrage du quiz',
              duration: 0,
            });
            return; // âš ï¸ IMPORTANT : Ne pas continuer
          }
          
          // Erreur non-JSON
          const text = await response.text();
          showAlert({
            type: 'error',
            message: text || 'Erreur lors du dÃ©marrage du quiz',
            duration: 0,
          });
          return; // âš ï¸ IMPORTANT : Ne pas continuer
        }

        // SuccÃ¨s : vÃ©rifier si c'est une rÃ©ponse JSON avec redirectTo
        const contentType = response.headers.get('content-type');
        if (contentType && contentType.includes('application/json')) {
          const data = await response.json().catch(() => null);
          
          if (data && data.success && data.redirectTo) {
            // RÃ©ponse JSON avec redirection
            console.log('âœ… Redirection depuis JSON:', data.redirectTo);
            window.location.href = data.redirectTo;
            return;
          }
        }

        // Fallback : Si redirection HTTP (status 302/303)
        const location = response.headers.get('Location');
        console.log('ğŸ“ Location header (succÃ¨s):', location);
        
        if (location) {
          console.log('âœ… Redirection vers:', location);
          window.location.href = location;
        } else if (response.status === 200 || response.status === 0) {
          // Si status 200 ou 0, peut-Ãªtre que la redirection est dans response.url
          const responseUrl = response.url;
          console.log('ğŸ“¡ Response URL:', responseUrl);
          
          // Si l'URL de rÃ©ponse est diffÃ©rente de l'URL actuelle, c'est probablement une redirection
          if (responseUrl && responseUrl !== window.location.href && responseUrl.includes('/quiz/play')) {
            console.log('âœ… Redirection depuis response.url:', responseUrl);
            window.location.href = responseUrl;
          } else {
            // Pas de redirect ? Erreur inattendue
            console.error('âŒ Pas de redirection dÃ©tectÃ©e. Status:', response.status, 'URL:', responseUrl);
            const { showAlert } = await import('@lib/showAlert');
            showAlert({
              type: 'error',
              message: 'RÃ©ponse inattendue du serveur. Veuillez rÃ©essayer.',
              duration: 0,
            });
            
            if (submitButton) {
              submitButton.disabled = false;
              submitButton.textContent = 'Lancer le Quiz ğŸš€';
            }
          }
        } else {
          // Autre status inattendu
          console.error('âŒ Status inattendu:', response.status);
          const { showAlert } = await import('@lib/showAlert');
          showAlert({
            type: 'error',
            message: `RÃ©ponse inattendue du serveur (status: ${response.status})`,
            duration: 0,
          });
          
          if (submitButton) {
            submitButton.disabled = false;
            submitButton.textContent = 'Lancer le Quiz ğŸš€';
          }
        }
      } catch (error) {
        console.error('Error submitting form:', error);
        
        // RÃ©activer le bouton
        if (submitButton) {
          submitButton.disabled = false;
          submitButton.textContent = 'Lancer le Quiz ğŸš€';
        }
        
        // Afficher l'erreur avec showAlert
        const { showAlert } = await import('@lib/showAlert');
        showAlert({
          type: 'error',
          message: 'Erreur lors du dÃ©marrage du quiz. Veuillez rÃ©essayer.',
          duration: 0,
        });
      }
    });
  }
</script>
