---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { requireAuth } from '../../lib/auth';

// Protection de la route
const authResult = await requireAuth(Astro);

// Si c'est une redirection, elle a dÃ©jÃ  Ã©tÃ© effectuÃ©e
if (authResult instanceof Response) {
  return authResult;
}

const { user, profile } = authResult;

// DÃ©finir les univers et difficultÃ©s disponibles
const universes = [
  { id: 'anime', label: 'ğŸŒ Anime', icon: 'ğŸŒ' },
  { id: 'manga', label: 'ğŸ“š Manga', icon: 'ğŸ“š' },
  { id: 'comics', label: 'ğŸ¦¸ Comics', icon: 'ğŸ¦¸' },
  { id: 'games', label: 'ğŸ® Jeux VidÃ©o', icon: 'ğŸ®' },
  { id: 'movies', label: 'ğŸ¬ Films', icon: 'ğŸ¬' },
  { id: 'series', label: 'ğŸ“º SÃ©ries', icon: 'ğŸ“º' },
  { id: 'other', label: 'ğŸŒŸ Autre', icon: 'ğŸŒŸ' },
];

const difficulties = [
  { id: 'easy', label: 'Facile', description: 'Pour dÃ©buter', color: 'success' },
  { id: 'medium', label: 'Moyen', description: 'Un peu de challenge', color: 'warning' },
  { id: 'hard', label: 'Difficile', description: 'Pour les experts', color: 'danger' },
];
---

<BaseLayout title="Nouveau Quiz - Qivana">
  <div class="quiz-setup">
    <div class="quiz-setup__container">
      <header class="quiz-setup__header">
        <h1 class="quiz-setup__title">Nouveau Quiz</h1>
        <p class="quiz-setup__subtitle">Choisis ton univers et ta difficultÃ©</p>
      </header>

      <!-- Message d'erreur (si stock insuffisant pour Freemium) -->
      {Astro.url.searchParams.get('error') === 'stock_insufficient' && (
        <div class="quiz-setup__error">
          <div class="quiz-setup__error-icon">âš ï¸</div>
          <div class="quiz-setup__error-content">
            <strong>Stock insuffisant</strong>
            <p>Passe Premium pour dÃ©bloquer la gÃ©nÃ©ration IA automatique</p>
          </div>
        </div>
      )}

      <form method="POST" action="/api/quiz/start" class="quiz-setup__form" id="quizSetupForm">
        <!-- SÃ©lection Univers -->
        <section class="quiz-setup__section">
          <h2 class="quiz-setup__section-title">
            <span class="quiz-setup__section-icon">ğŸŒ</span>
            Univers
          </h2>
          <div class="quiz-setup__grid">
            {universes.map((universe) => (
              <label class="quiz-card">
                <input
                  type="radio"
                  name="universe"
                  value={universe.id}
                  required
                  class="quiz-card__input"
                />
                <div class="quiz-card__content">
                  <span class="quiz-card__icon">{universe.icon}</span>
                  <span class="quiz-card__label">{universe.label}</span>
                </div>
              </label>
            ))}
          </div>
        </section>

        <!-- SÃ©lection DifficultÃ© -->
        <section class="quiz-setup__section">
          <h2 class="quiz-setup__section-title">
            <span class="quiz-setup__section-icon">âš¡</span>
            DifficultÃ©
          </h2>
          <div class="quiz-setup__difficulty-grid">
            {difficulties.map((difficulty) => (
              <label class={`difficulty-card difficulty-card--${difficulty.color}`}>
                <input
                  type="radio"
                  name="difficulty"
                  value={difficulty.id}
                  required
                  class="difficulty-card__input"
                />
                <div class="difficulty-card__content">
                  <span class="difficulty-card__label">{difficulty.label}</span>
                  <span class="difficulty-card__description">{difficulty.description}</span>
                </div>
              </label>
            ))}
          </div>
        </section>

        <!-- Info Plan -->
        <div class="quiz-setup__info">
          <div class="quiz-setup__info-icon">â„¹ï¸</div>
          <div class="quiz-setup__info-content">
            {profile.plan === 'freemium' ? (
              <>
                <strong>Mode Freemium</strong>
                <p>10 questions â€¢ Timer 10s â€¢ Step-by-step</p>
                <p class="quiz-setup__info-note">ğŸ’¡ Passe Premium pour dÃ©bloquer la gÃ©nÃ©ration IA automatique</p>
              </>
            ) : (
              <>
                <strong>Mode {profile.plan === 'premium' ? 'Premium' : 'Premium+'}</strong>
                <p>10 questions â€¢ Timer {profile.plan === 'premium' ? '5/10/15s' : '3-20s'} â€¢ {profile.plan === 'premium+' ? 'All-in-one disponible' : 'Step-by-step'}</p>
                <p class="quiz-setup__info-note">âœ¨ GÃ©nÃ©ration IA automatique si stock insuffisant</p>
              </>
            )}
          </div>
        </div>

        <!-- Actions -->
        <div class="quiz-setup__actions">
          <a href="/" class="btn btn--secondary">Annuler</a>
          <button type="submit" class="btn btn--primary">
            Lancer le Quiz ğŸš€
          </button>
        </div>
      </form>
    </div>
  </div>
</BaseLayout>

<style lang="scss">
@use '../../styles/pages/quiz' as *;

.quiz-setup__error {
  margin-bottom: var(--space-6);
  padding: var(--space-4);
  background: hsl(45, 100%, 95%);
  border: 1px solid hsl(45, 100%, 60%);
  border-radius: var(--radius-3);
  display: flex;
  gap: var(--space-3);
  align-items: flex-start;
}

.quiz-setup__error-icon {
  font-size: var(--fs-5);
  flex-shrink: 0;
}

.quiz-setup__error-content {
  flex: 1;

  strong {
    display: block;
    font-weight: var(--font-weight-bold);
    color: hsl(45, 100%, 20%);
    margin-bottom: var(--space-1);
  }

  p {
    font-size: var(--fs-2);
    color: hsl(45, 100%, 30%);
    margin: 0;
  }
}

.quiz-setup__info-note {
  margin-top: var(--space-2);
  font-size: var(--fs-1);
  color: var(--color-text-muted);
  font-style: italic;
}
</style>

<script>
  // Gestion des erreurs depuis l'API (pour les rÃ©ponses JSON uniquement)
  // Les redirects Astro fonctionnent automatiquement avec les formulaires POST
  const form = document.getElementById('quizSetupForm') as HTMLFormElement;
  
  if (form) {
    form.addEventListener('submit', async (e) => {
      // Intercepter seulement pour gÃ©rer les erreurs JSON
      // Les redirects fonctionnent automatiquement
      const formData = new FormData(form);
      
      try {
        const response = await fetch('/api/quiz/start', {
          method: 'POST',
          body: formData,
          redirect: 'manual', // Ne pas suivre automatiquement pour pouvoir gÃ©rer les erreurs
        });

        // Si redirection (status 302/303), suivre manuellement
        if (response.status >= 300 && response.status < 400) {
          const location = response.headers.get('Location');
          if (location) {
            window.location.href = location;
            return;
          }
        }

        // Si erreur JSON (status 4xx/5xx), afficher le message
        if (!response.ok) {
          const contentType = response.headers.get('content-type');
          if (contentType && contentType.includes('application/json')) {
            const data = await response.json().catch(() => ({ error: 'Erreur inconnue' }));
            
            if (data.requiresPremium) {
              // Rediriger avec paramÃ¨tre d'erreur pour afficher le message
              window.location.href = '/quiz/setup?error=stock_insufficient';
              return;
            }
            
            alert(data.message || data.error || 'Erreur lors du dÃ©marrage du quiz');
            return;
          }
          
          // Erreur non-JSON
          const text = await response.text();
          alert(text || 'Erreur lors du dÃ©marrage du quiz');
          return;
        }

        // SuccÃ¨s : devrait Ãªtre un redirect normalement
        const location = response.headers.get('Location');
        if (location) {
          window.location.href = location;
        }
      } catch (error) {
        console.error('Error submitting form:', error);
        alert('Erreur lors du dÃ©marrage du quiz');
      }
    });
  }
</script>
