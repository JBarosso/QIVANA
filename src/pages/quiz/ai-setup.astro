---
// ============================================
// AI QUIZ SETUP PAGE (Premium/Premium+)
// ============================================

import BaseLayout from '../../layouts/BaseLayout.astro';
import { requireAuth } from '../../lib/auth';

// Protection de la route
const { user, profile } = await requireAuth(Astro);

// V√©rifier que l'utilisateur est Premium ou Premium+
if (profile.plan === 'freemium') {
  return Astro.redirect('/?error=premium_required');
}

// R√©cup√©rer le quota actuel
const quotaLimits = {
  premium: 5,
  'premium+': 200,
};

const currentQuota = profile.ai_quizzes_used_this_month || 0;
const maxQuota = quotaLimits[profile.plan as keyof typeof quotaLimits] || 0;
const remainingQuota = maxQuota - currentQuota;

// Nombre max de questions selon le plan
const maxQuestions = profile.plan === 'premium' ? 10 : 30;
---

<BaseLayout
  title="G√©n√©rer un Quiz IA - Qivana"
  description="Cr√©ez un quiz personnalis√© avec l'intelligence artificielle"
>
  <main class="ai-setup-page">
    <div class="container">
      <div class="ai-setup-header">
        <h1 class="ai-setup-header__title">ü§ñ Quiz IA - Univers Pr√©d√©finis</h1>
        <p class="ai-setup-header__subtitle">
          L'IA va g√©n√©rer un quiz unique pour vous
        </p>
        <div class="ai-setup-header__quota">
          <span class="quota-badge">
            {remainingQuota > 0 ? (
              <>‚ú® {remainingQuota} / {maxQuota} quiz IA restants ce mois</>
            ) : (
              <>‚ö†Ô∏è Quota mensuel √©puis√© ({currentQuota}/{maxQuota})</>
            )}
          </span>
        </div>
      </div>

      <form class="ai-setup-form" id="aiSetupForm">
        <!-- Univers -->
        <div class="form-section">
          <h2 class="form-section__title">1Ô∏è‚É£ Choisis ton univers</h2>
          <div class="universe-grid">
            <label class="universe-card">
              <input type="radio" name="universe" value="anime" required />
              <div class="universe-card__content">
                <div class="universe-card__icon">üéå</div>
                <div class="universe-card__title">Anime</div>
              </div>
            </label>

            <label class="universe-card">
              <input type="radio" name="universe" value="manga" required />
              <div class="universe-card__content">
                <div class="universe-card__icon">üìö</div>
                <div class="universe-card__title">Manga</div>
              </div>
            </label>

            <label class="universe-card">
              <input type="radio" name="universe" value="comics" required />
              <div class="universe-card__content">
                <div class="universe-card__icon">ü¶∏</div>
                <div class="universe-card__title">Comics</div>
              </div>
            </label>

            <label class="universe-card">
              <input type="radio" name="universe" value="games" required />
              <div class="universe-card__content">
                <div class="universe-card__icon">üéÆ</div>
                <div class="universe-card__title">Jeux Vid√©o</div>
              </div>
            </label>

            <label class="universe-card">
              <input type="radio" name="universe" value="movies" required />
              <div class="universe-card__content">
                <div class="universe-card__icon">üé¨</div>
                <div class="universe-card__title">Films</div>
              </div>
            </label>

            <label class="universe-card">
              <input type="radio" name="universe" value="series" required />
              <div class="universe-card__content">
                <div class="universe-card__icon">üì∫</div>
                <div class="universe-card__title">S√©ries</div>
              </div>
            </label>
          </div>
        </div>

        <!-- Difficult√© -->
        <div class="form-section">
          <h2 class="form-section__title">2Ô∏è‚É£ Choisis la difficult√©</h2>
          <div class="difficulty-grid">
            <label class="difficulty-card difficulty-card--easy">
              <input type="radio" name="difficulty" value="easy" required />
              <div class="difficulty-card__content">
                <div class="difficulty-card__icon">üü¢</div>
                <div class="difficulty-card__title">Facile</div>
                <div class="difficulty-card__desc">Culture populaire</div>
              </div>
            </label>

            <label class="difficulty-card difficulty-card--medium">
              <input type="radio" name="difficulty" value="medium" required />
              <div class="difficulty-card__content">
                <div class="difficulty-card__icon">üü°</div>
                <div class="difficulty-card__title">Moyen</div>
                <div class="difficulty-card__desc">Connaisseur</div>
              </div>
            </label>

            <label class="difficulty-card difficulty-card--hard">
              <input type="radio" name="difficulty" value="hard" required />
              <div class="difficulty-card__content">
                <div class="difficulty-card__icon">üî¥</div>
                <div class="difficulty-card__title">Difficile</div>
                <div class="difficulty-card__desc">Expert</div>
              </div>
            </label>
          </div>
        </div>

        <!-- Nombre de questions -->
        <div class="form-section">
          <h2 class="form-section__title">3Ô∏è‚É£ Nombre de questions</h2>
          <div class="slider-container">
            <input 
              type="range" 
              name="numberOfQuestions" 
              min="5" 
              max={maxQuestions} 
              value="10" 
              class="slider"
              id="questionSlider"
            />
            <div class="slider-value">
              <span id="questionCount">10</span> questions
            </div>
          </div>
        </div>

        <!-- Bouton de g√©n√©ration -->
        <button 
          type="submit" 
          class="btn btn--primary btn--block btn--large"
          disabled={remainingQuota <= 0}
        >
          <span class="btn__text">üöÄ G√©n√©rer le Quiz IA</span>
        </button>

        {remainingQuota <= 0 && (
          <p class="quota-warning">
            ‚ö†Ô∏è Tu as atteint ton quota mensuel. Renouvellement automatique le 1er du mois prochain.
          </p>
        )}
      </form>

      <!-- Loading overlay -->
      <div class="loading-overlay" id="loadingOverlay" style="display: none;">
        <div class="loading-spinner">
          <div class="spinner"></div>
          <p class="loading-text">ü§ñ L'IA g√©n√®re ton quiz...</p>
          <p class="loading-subtext">Cela peut prendre 10-20 secondes</p>
        </div>
      </div>
    </div>
  </main>
</BaseLayout>

<style lang="scss">
  @import '../../styles/pages/_quiz.scss';

  .ai-setup-page {
    min-height: 100vh;
    padding: var(--space-8) 0;
  }

  .ai-setup-header {
    text-align: center;
    margin-bottom: var(--space-8);
  }

  .ai-setup-header__title {
    font-family: var(--font-secondary);
    font-size: var(--fs-8);
    color: var(--color-text);
    margin-bottom: var(--space-3);
  }

  .ai-setup-header__subtitle {
    font-size: var(--fs-4);
    color: var(--color-text-muted);
    margin-bottom: var(--space-4);
  }

  .quota-badge {
    display: inline-block;
    padding: var(--space-2) var(--space-4);
    background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
    color: var(--color-text-on-primary);
    border-radius: var(--radius-3);
    font-size: var(--fs-2);
    font-weight: var(--font-weight-medium);
  }

  .ai-setup-form {
    max-width: 800px;
    margin: 0 auto;
    background: var(--color-surface);
    border-radius: var(--radius-4);
    padding: var(--space-6);
    box-shadow: var(--shadow-lg);
  }

  .form-section {
    margin-bottom: var(--space-6);
  }

  .form-section__title {
    font-family: var(--font-secondary);
    font-size: var(--fs-5);
    color: var(--color-text);
    margin-bottom: var(--space-4);
  }

  .universe-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: var(--space-3);
  }

  .universe-card {
    position: relative;
    cursor: pointer;

    input[type="radio"] {
      position: absolute;
      opacity: 0;
      pointer-events: none;
    }

    &:has(input:checked) .universe-card__content {
      background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
      color: var(--color-text-on-primary);
      box-shadow: var(--glow-primary);
      transform: translateY(-4px);
    }
  }

  .universe-card__content {
    padding: var(--space-4);
    background: var(--color-background);
    border-radius: var(--radius-3);
    border: 2px solid var(--color-border);
    text-align: center;
    transition: all var(--transition-base);

    &:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-sm);
    }
  }

  .universe-card__icon {
    font-size: var(--fs-7);
    margin-bottom: var(--space-2);
  }

  .universe-card__title {
    font-size: var(--fs-2);
    font-weight: var(--font-weight-medium);
  }

  .difficulty-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: var(--space-3);
  }

  .difficulty-card {
    position: relative;
    cursor: pointer;

    input[type="radio"] {
      position: absolute;
      opacity: 0;
      pointer-events: none;
    }

    &:has(input:checked) .difficulty-card__content {
      transform: translateY(-4px);
      box-shadow: var(--shadow-md);
    }
  }

  .difficulty-card__content {
    padding: var(--space-4);
    background: var(--color-background);
    border-radius: var(--radius-3);
    border: 2px solid var(--color-border);
    text-align: center;
    transition: all var(--transition-base);

    &:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-sm);
    }
  }

  .difficulty-card--easy:has(input:checked) .difficulty-card__content {
    border-color: var(--color-success);
    background: var(--color-success-lighter);
  }

  .difficulty-card--medium:has(input:checked) .difficulty-card__content {
    border-color: var(--color-warning);
    background: var(--color-warning-lighter);
  }

  .difficulty-card--hard:has(input:checked) .difficulty-card__content {
    border-color: var(--color-danger);
    background: var(--color-danger-lighter);
  }

  .difficulty-card__icon {
    font-size: var(--fs-6);
    margin-bottom: var(--space-2);
  }

  .difficulty-card__title {
    font-size: var(--fs-3);
    font-weight: var(--font-weight-medium);
    margin-bottom: var(--space-1);
  }

  .difficulty-card__desc {
    font-size: var(--fs-1);
    color: var(--color-text-muted);
  }

  .slider-container {
    text-align: center;
  }

  .slider {
    width: 100%;
    height: 8px;
    border-radius: 4px;
    background: var(--color-background);
    outline: none;
    margin-bottom: var(--space-3);
    cursor: pointer;
  }

  .slider::-webkit-slider-thumb {
    appearance: none;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
    cursor: pointer;
    box-shadow: var(--shadow-sm);
  }

  .slider-value {
    font-size: var(--fs-6);
    font-weight: var(--font-weight-bold);
    color: var(--color-primary);
  }

  .btn--large {
    padding: var(--space-4) var(--space-6);
    font-size: var(--fs-4);
  }

  .quota-warning {
    text-align: center;
    color: var(--color-danger);
    margin-top: var(--space-4);
    font-size: var(--fs-2);
  }

  .loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
  }

  .loading-spinner {
    text-align: center;
  }

  .spinner {
    width: 64px;
    height: 64px;
    border: 6px solid var(--color-surface);
    border-top-color: var(--color-primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto var(--space-4);
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .loading-text {
    font-size: var(--fs-5);
    color: var(--color-text);
    margin-bottom: var(--space-2);
  }

  .loading-subtext {
    font-size: var(--fs-2);
    color: var(--color-text-muted);
  }
</style>

<script>
  // Mise √† jour dynamique du slider
  const slider = document.getElementById('questionSlider') as HTMLInputElement;
  const countDisplay = document.getElementById('questionCount');

  if (slider && countDisplay) {
    slider.addEventListener('input', () => {
      countDisplay.textContent = slider.value;
    });
  }

  // Gestion du formulaire
  const form = document.getElementById('aiSetupForm') as HTMLFormElement;
  const loadingOverlay = document.getElementById('loadingOverlay');

  if (form && loadingOverlay) {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const formData = new FormData(form);
      const universe = formData.get('universe');
      const difficulty = formData.get('difficulty');
      const numberOfQuestions = parseInt(formData.get('numberOfQuestions') as string);

      if (!universe || !difficulty || !numberOfQuestions) {
        alert('Veuillez remplir tous les champs');
        return;
      }

      // Afficher le loading
      loadingOverlay.style.display = 'flex';

      try {
        const response = await fetch('/api/quiz/generate', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            universe,
            difficulty,
            numberOfQuestions,
          }),
        });

        const data = await response.json();

        console.log('API Response:', data);
        console.log('DEBUG INFO:', data.debug);
        
        if (data.errors && data.errors.length > 0) {
          console.error('ERRORS FROM SERVER:', data.errors);
        }

        if (!response.ok) {
          throw new Error(data.error || 'Erreur lors de la g√©n√©ration');
        }

        // V√©rifier que questionIds existe et n'est pas vide
        if (!data.questionIds || data.questionIds.length === 0) {
          const errorDetails = data.errors ? `\n\nErreurs:\n${data.errors.join('\n')}` : '';
          throw new Error(`Aucune question g√©n√©r√©e. ${errorDetails || 'V√©rifie les logs du serveur.'}`);
        }

        console.log('Redirecting to:', `/quiz/play?ids=${data.questionIds.join(',')}`);

        // Rediriger vers la page de jeu avec les questions g√©n√©r√©es
        window.location.href = `/quiz/play?ids=${data.questionIds.join(',')}`;
      } catch (error) {
        loadingOverlay.style.display = 'none';
        alert(error instanceof Error ? error.message : 'Erreur lors de la g√©n√©ration du quiz');
      }
    });
  }
</script>
