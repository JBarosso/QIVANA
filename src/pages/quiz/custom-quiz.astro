---
// ============================================
// CUSTOM QUIZ AI PAGE (Premium/Premium+)
// ============================================

import BaseLayout from '../../layouts/BaseLayout.astro';
import { requireAuth } from '../../lib/auth';

// Protection de la route
const authResult = await requireAuth(Astro);

// Si c'est une redirection, elle a d√©j√† √©t√© effectu√©e
if (authResult instanceof Response) {
  return authResult;
}

const { user, profile } = authResult;

// V√©rifier que l'utilisateur est Premium ou Premium+
if (profile.plan === 'freemium') {
  return Astro.redirect('/?error=premium_required');
}

// R√©cup√©rer le quota actuel
const quotaLimits = {
  premium: 5,
  'premium+': 200,
};

const currentQuota = profile.ai_quizzes_used_this_month || 0;
const maxQuota = quotaLimits[profile.plan as keyof typeof quotaLimits] || 0;
const remainingQuota = maxQuota - currentQuota;

// Nombre de questions selon le plan
const maxQuestions = profile.plan === 'premium' ? 10 : 30;
const minQuestions = 5;
---

<BaseLayout
  title="Quiz Custom - Qivana"
  description="Cr√©e un quiz personnalis√© avec ton propre prompt"
>
  <main class="custom-quiz-page">
    <div class="container">
      <div class="custom-quiz-header">
        <h1 class="custom-quiz-header__title">‚ú® Quiz Custom</h1>
        <p class="custom-quiz-header__subtitle">
          Laisse libre cours √† ton imagination et g√©n√®re un quiz unique
        </p>
        <div class="custom-quiz-header__quota">
          <span class="quota-badge">
            {remainingQuota > 0 ? (
              <>‚ú® {remainingQuota} / {maxQuota} quiz IA restants ce mois</>
            ) : (
              <>‚ö†Ô∏è Quota mensuel √©puis√© ({currentQuota}/{maxQuota})</>
            )}
          </span>
        </div>
      </div>

      <form class="custom-quiz-form" id="customQuizForm">
        <!-- Prompt personnalis√© -->
        <div class="form-section">
          <h2 class="form-section__title">üìù Ton prompt cr√©atif</h2>
          <p class="form-section__description">
            D√©cris le quiz que tu veux. Sois pr√©cis et cr√©atif !
          </p>

          <div class="prompt-input-wrapper">
            <textarea
              name="prompt"
              id="promptInput"
              class="prompt-input"
              placeholder="Ex: Cr√©e un quiz sur les r√©pliques cultes de Breaking Bad"
              rows="6"
              maxlength="500"
              required
            ></textarea>
            <button type="button" class="random-prompt-btn" id="randomPromptBtn" title="Prompt al√©atoire">
              üé≤
            </button>
          </div>
          
          <div class="prompt-footer">
            <div class="prompt-counter">
              <span id="charCount">0</span> / 500 caract√®res
            </div>
          </div>

          <!-- Message d'erreur -->
          <div class="prompt-error" id="promptError" hidden>
            ‚ö†Ô∏è Le prompt doit contenir au moins 10 caract√®res
          </div>

          <!-- Zone de clarification (affich√©e si prompt ambigu) -->
          <div class="clarification-zone" id="clarificationZone" hidden>
            <div class="clarification-zone__header">
              <span class="clarification-zone__icon">ü§î</span>
              <h3 class="clarification-zone__title">Ton th√®me est un peu vague</h3>
              <p class="clarification-zone__subtitle">Choisis une interpr√©tation :</p>
            </div>
            <div class="clarification-zone__options" id="clarificationOptions">
              <!-- Options g√©n√©r√©es dynamiquement -->
            </div>
            <button type="button" class="btn btn--secondary btn--block" id="cancelClarification">
              ‚Üê Modifier mon prompt
            </button>
          </div>
        </div>

        <!-- Difficult√© -->
        <div class="form-section">
          <h2 class="form-section__title">2Ô∏è‚É£ Difficult√©</h2>
          <div class="difficulty-grid">
            <label class="difficulty-card difficulty-card--easy">
              <input type="radio" name="difficulty" value="easy" required />
              <div class="difficulty-card__content">
                <div class="difficulty-card__icon">üü¢</div>
                <div class="difficulty-card__title">Facile</div>
                <div class="difficulty-card__desc">Accessible</div>
              </div>
            </label>

            <label class="difficulty-card difficulty-card--medium">
              <input type="radio" name="difficulty" value="medium" checked />
              <div class="difficulty-card__content">
                <div class="difficulty-card__icon">üü°</div>
                <div class="difficulty-card__title">Moyen</div>
                <div class="difficulty-card__desc">√âquilibr√©</div>
              </div>
            </label>

            <label class="difficulty-card difficulty-card--hard">
              <input type="radio" name="difficulty" value="hard" />
              <div class="difficulty-card__content">
                <div class="difficulty-card__icon">üî¥</div>
                <div class="difficulty-card__title">Difficile</div>
                <div class="difficulty-card__desc">Expert</div>
              </div>
            </label>
          </div>
        </div>

        <!-- Nombre de questions -->
        <div class="form-section">
          <h2 class="form-section__title">3Ô∏è‚É£ Nombre de questions</h2>
          <div class="slider-container">
            <input 
              type="range" 
              name="numberOfQuestions" 
              min={minQuestions}
              max={maxQuestions}
              value="10" 
              class="slider"
              id="questionSlider"
            />
            <div class="slider-value">
              <span id="questionCount">10</span> questions
            </div>
          </div>
          {profile.plan === 'premium' && (
            <p class="plan-hint">üí° Passe Premium+ pour g√©n√©rer jusqu'√† 30 questions</p>
          )}
        </div>

        <!-- S√©lection Timer (selon plan) -->
        <div class="form-section">
          <h2 class="form-section__title">4Ô∏è‚É£ Timer</h2>
          {profile.plan === 'premium' ? (
            <!-- Premium : Boutons radio 5/10/15s -->
            <div class="difficulty-grid">
              <label class="difficulty-card difficulty-card--primary">
                <input
                  type="radio"
                  name="timer"
                  value="5"
                  required
                  class="difficulty-card__input"
                  checked
                />
                <div class="difficulty-card__content">
                  <div class="difficulty-card__title">5 secondes</div>
                  <div class="difficulty-card__desc">Rapide ‚ö°</div>
                </div>
              </label>
              <label class="difficulty-card difficulty-card--primary">
                <input
                  type="radio"
                  name="timer"
                  value="10"
                  required
                  class="difficulty-card__input"
                />
                <div class="difficulty-card__content">
                  <div class="difficulty-card__title">10 secondes</div>
                  <div class="difficulty-card__desc">Standard üéØ</div>
                </div>
              </label>
              <label class="difficulty-card difficulty-card--primary">
                <input
                  type="radio"
                  name="timer"
                  value="15"
                  required
                  class="difficulty-card__input"
                />
                <div class="difficulty-card__content">
                  <div class="difficulty-card__title">15 secondes</div>
                  <div class="difficulty-card__desc">Confortable üßò</div>
                </div>
              </label>
            </div>
          ) : (
            <!-- Premium+ : Slider 3-20s -->
            <div class="slider-container">
              <input
                type="range"
                name="timer"
                id="timerSlider"
                min="3"
                max="20"
                value="10"
                required
                class="slider"
              />
              <div class="slider-value">
                <span id="timerValue">10</span> secondes
              </div>
            </div>
          )}
        </div>

        <!-- Avertissement quiz custom -->
        <div class="info-box info-box--warning">
          <div class="info-box__icon">‚ö†Ô∏è</div>
          <div class="info-box__content">
            <strong>Mode Quiz Custom :</strong> Les questions g√©n√©r√©es ne seront pas sauvegard√©es dans la base de donn√©es et ne pourront pas √™tre rejou√©es plus tard.
          </div>
        </div>

        <!-- Bouton de g√©n√©ration -->
        <button 
          type="submit" 
          class="btn btn--primary btn--block btn--large"
          disabled={remainingQuota <= 0}
        >
          <span class="btn__text">üöÄ G√©n√©rer mon Quiz</span>
        </button>

        {remainingQuota <= 0 && (
          <p class="quota-warning">
            ‚ö†Ô∏è Tu as atteint ton quota mensuel. Renouvellement automatique le 1er du mois prochain.
          </p>
        )}
      </form>

      <!-- Loading overlay -->
      <div class="loading-overlay" id="loadingOverlay" style="display: none;">
        <div class="loading-spinner">
          <div class="spinner"></div>
          <p class="loading-text">‚ú® L'IA cr√©e ton quiz personnalis√©...</p>
          <p class="loading-subtext">Cela peut prendre 10-30 secondes</p>
        </div>
      </div>
    </div>
  </main>
</BaseLayout>

<style lang="scss">
  @import '../../styles/pages/_quiz.scss';

  .custom-quiz-page {
    min-height: 100vh;
    padding: var(--space-8) 0;
  }

  .custom-quiz-header {
    text-align: center;
    margin-bottom: var(--space-8);
  }

  .custom-quiz-header__title {
    font-family: var(--font-secondary);
    font-size: var(--fs-8);
    color: var(--color-text);
    margin-bottom: var(--space-3);
  }

  .custom-quiz-header__subtitle {
    font-size: var(--fs-4);
    color: var(--color-text-muted);
    margin-bottom: var(--space-4);
  }

  .quota-badge {
    display: inline-block;
    padding: var(--space-2) var(--space-4);
    background: linear-gradient(135deg, #8b5cf6, #ec4899);
    color: var(--color-text-on-primary);
    border-radius: var(--radius-3);
    font-size: var(--fs-2);
    font-weight: var(--font-weight-medium);
  }

  .custom-quiz-form {
    max-width: 800px;
    margin: 0 auto;
    background: var(--color-surface);
    border-radius: var(--radius-4);
    padding: var(--space-6);
    box-shadow: var(--shadow-lg);
  }

  .form-section {
    margin-bottom: var(--space-6);
  }

  .form-section__title {
    font-family: var(--font-secondary);
    font-size: var(--fs-5);
    color: var(--color-text);
    margin-bottom: var(--space-2);
  }

  .form-section__description {
    font-size: var(--fs-2);
    color: var(--color-text-muted);
    margin-bottom: var(--space-4);
  }

  .prompt-input-wrapper {
    position: relative;
  }

  .prompt-input {
    width: 100%;
    padding: var(--space-4);
    padding-right: var(--space-12);
    font-size: var(--fs-2);
    font-family: var(--font-primary);
    color: var(--color-text);
    background: var(--color-background);
    border: 2px solid var(--color-border);
    border-radius: var(--radius-3);
    resize: vertical;
    transition: all var(--transition-base);

    &:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: 0 0 0 3px hsla(var(--color-primary-h), var(--color-primary-s), var(--color-primary-l), 0.1);
    }

    &::placeholder {
      color: var(--color-text-muted);
      transition: opacity 0.3s ease;
    }

    &.placeholder-animating::placeholder {
      opacity: 0;
    }
  }

  .random-prompt-btn {
    position: absolute;
    top: var(--space-3);
    right: var(--space-3);
    width: 40px;
    height: 40px;
    border: none;
    background: linear-gradient(135deg, #8b5cf6, #ec4899);
    border-radius: var(--radius-2);
    font-size: var(--fs-4);
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;

    &:hover {
      transform: scale(1.1) rotate(15deg);
      box-shadow: var(--shadow-md);
    }

    &:active {
      transform: scale(0.95);
    }

    &.loading {
      animation: spin 1s linear infinite;
    }
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .prompt-footer {
    display: flex;
    justify-content: flex-end;
    align-items: center;
    margin-top: var(--space-2);
  }

  .prompt-counter {
    font-size: var(--fs-1);
    color: var(--color-text-muted);
  }

  .prompt-error {
    margin-top: var(--space-2);
    padding: var(--space-2) var(--space-3);
    background: hsl(0, 100%, 95%);
    border: 1px solid hsl(0, 100%, 60%);
    border-radius: var(--radius-2);
    font-size: var(--fs-1);
    color: hsl(0, 100%, 30%);
  }

  // Zone de clarification
  .clarification-zone {
    margin-top: var(--space-4);
    padding: var(--space-5);
    background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(236, 72, 153, 0.1));
    border: 2px solid var(--color-primary);
    border-radius: var(--radius-3);

    &__header {
      text-align: center;
      margin-bottom: var(--space-4);
    }

    &__icon {
      font-size: var(--fs-7);
      display: block;
      margin-bottom: var(--space-2);
    }

    &__title {
      font-size: var(--fs-4);
      font-weight: var(--font-weight-bold);
      color: var(--color-text);
      margin-bottom: var(--space-1);
    }

    &__subtitle {
      font-size: var(--fs-2);
      color: var(--color-text-muted);
    }

    &__options {
      display: flex;
      flex-direction: column;
      gap: var(--space-3);
      margin-bottom: var(--space-4);
    }
  }

  .clarification-option {
    padding: var(--space-4);
    background: var(--color-surface);
    border: 2px solid var(--color-border);
    border-radius: var(--radius-3);
    cursor: pointer;
    transition: all var(--transition-base);
    text-align: left;

    &:hover {
      border-color: var(--color-primary);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    &__label {
      font-size: var(--fs-3);
      font-weight: var(--font-weight-semibold);
      color: var(--color-text);
      margin-bottom: var(--space-1);
    }

    &__theme {
      font-size: var(--fs-2);
      color: var(--color-text-muted);
    }

    &__confidence {
      display: inline-block;
      margin-top: var(--space-2);
      padding: var(--space-1) var(--space-2);
      background: var(--color-primary);
      color: white;
      border-radius: var(--radius-1);
      font-size: var(--fs-1);
    }
  }

  .difficulty-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: var(--space-3);
  }

  .difficulty-card {
    position: relative;
    cursor: pointer;

    input[type="radio"] {
      position: absolute;
      opacity: 0;
      pointer-events: none;
    }

    &:has(input:checked) .difficulty-card__content {
      transform: translateY(-4px);
      box-shadow: var(--shadow-md);
    }
  }

  .difficulty-card__content {
    padding: var(--space-4);
    background: var(--color-background);
    border-radius: var(--radius-3);
    border: 2px solid var(--color-border);
    text-align: center;
    transition: all var(--transition-base);

    &:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-sm);
    }
  }

  .difficulty-card--easy:has(input:checked) .difficulty-card__content {
    border-color: var(--color-success);
    background: var(--color-success-lighter);
  }

  .difficulty-card--medium:has(input:checked) .difficulty-card__content {
    border-color: var(--color-warning);
    background: var(--color-warning-lighter);
  }

  .difficulty-card--hard:has(input:checked) .difficulty-card__content {
    border-color: var(--color-danger);
    background: var(--color-danger-lighter);
  }

  .difficulty-card__icon {
    font-size: var(--fs-6);
    margin-bottom: var(--space-2);
  }

  .difficulty-card__title {
    font-size: var(--fs-3);
    font-weight: var(--font-weight-medium);
    margin-bottom: var(--space-1);
  }

  .difficulty-card__desc {
    font-size: var(--fs-1);
    color: var(--color-text-muted);
  }

  .slider-container {
    text-align: center;
  }

  .slider {
    width: 100%;
    height: 8px;
    border-radius: 4px;
    background: var(--color-background);
    outline: none;
    margin-bottom: var(--space-3);
    cursor: pointer;
  }

  .slider::-webkit-slider-thumb {
    appearance: none;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    background: linear-gradient(135deg, #8b5cf6, #ec4899);
    cursor: pointer;
    box-shadow: var(--shadow-sm);
  }

  .slider-value {
    font-size: var(--fs-6);
    font-weight: var(--font-weight-bold);
    color: var(--color-primary);
  }

  .plan-hint {
    text-align: center;
    font-size: var(--fs-1);
    color: var(--color-text-muted);
    margin-top: var(--space-3);
  }

  .info-box {
    padding: var(--space-4);
    border-radius: var(--radius-3);
    display: flex;
    gap: var(--space-3);
    margin-bottom: var(--space-4);
  }

  .info-box--warning {
    background: hsl(45, 100%, 95%);
    border: 1px solid hsl(45, 100%, 60%);
  }

  .info-box__icon {
    font-size: var(--fs-5);
    flex-shrink: 0;
  }

  .info-box__content {
    font-size: var(--fs-2);
    color: hsl(45, 100%, 20%);

    strong {
      font-weight: var(--font-weight-bold);
    }
  }

  .btn--large {
    padding: var(--space-4) var(--space-6);
    font-size: var(--fs-4);
  }

  .quota-warning {
    text-align: center;
    color: var(--color-danger);
    margin-top: var(--space-4);
    font-size: var(--fs-2);
  }

  .loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
  }

  .loading-spinner {
    text-align: center;
  }

  .spinner {
    width: 64px;
    height: 64px;
    border: 6px solid var(--color-surface);
    border-top-color: #ec4899;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto var(--space-4);
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .loading-text {
    font-size: var(--fs-5);
    color: var(--color-text);
    margin-bottom: var(--space-2);
  }

  .loading-subtext {
    font-size: var(--fs-2);
    color: var(--color-text-muted);
  }
</style>

<script>
  // √âl√©ments DOM
  const promptInput = document.getElementById('promptInput') as HTMLTextAreaElement;
  const charCount = document.getElementById('charCount');
  const promptError = document.getElementById('promptError');
  const clarificationZone = document.getElementById('clarificationZone');
  const clarificationOptions = document.getElementById('clarificationOptions');
  const cancelClarificationBtn = document.getElementById('cancelClarification');
  const form = document.getElementById('customQuizForm') as HTMLFormElement;
  const loadingOverlay = document.getElementById('loadingOverlay');
  const randomPromptBtn = document.getElementById('randomPromptBtn');

  // √âtat
  let selectedClarification: string | null = null;
  let placeholderPrompts: string[] = [];
  let currentPlaceholderIndex = 0;
  let placeholderInterval: number | null = null;

  // ============================================
  // PLACEHOLDER ROTATIF
  // ============================================
  async function loadPlaceholderPrompts() {
    try {
      const response = await fetch('/api/quiz/random-prompts?count=5');
      const data = await response.json();
      if (data.prompts && data.prompts.length > 0) {
        placeholderPrompts = data.prompts;
        startPlaceholderRotation();
      }
    } catch (error) {
      console.error('Error loading placeholder prompts:', error);
    }
  }

  function startPlaceholderRotation() {
    if (placeholderPrompts.length === 0 || !promptInput) return;

    // Mettre √† jour le placeholder initial
    updatePlaceholder();

    // Rotation toutes les 5 secondes
    placeholderInterval = window.setInterval(() => {
      if (promptInput.value.length === 0) {
        currentPlaceholderIndex = (currentPlaceholderIndex + 1) % placeholderPrompts.length;
        updatePlaceholder();
      }
    }, 5000);
  }

  function updatePlaceholder() {
    if (!promptInput || placeholderPrompts.length === 0) return;
    
    // Animation de transition
    promptInput.classList.add('placeholder-animating');
    setTimeout(() => {
      promptInput.placeholder = placeholderPrompts[currentPlaceholderIndex];
      promptInput.classList.remove('placeholder-animating');
    }, 150);
  }

  function stopPlaceholderRotation() {
    if (placeholderInterval) {
      clearInterval(placeholderInterval);
      placeholderInterval = null;
    }
  }

  // Charger les prompts au chargement de la page
  loadPlaceholderPrompts();

  // ============================================
  // BOUTON AL√âATOIRE
  // ============================================
  if (randomPromptBtn && promptInput) {
    randomPromptBtn.addEventListener('click', async () => {
      randomPromptBtn.classList.add('loading');
      
      try {
        const response = await fetch('/api/quiz/random-prompts', { method: 'POST' });
        const data = await response.json();
        
        if (data.prompt) {
          promptInput.value = data.prompt;
          charCount!.textContent = data.prompt.length.toString();
          promptInput.focus();
          
          // Masquer la zone de clarification
          if (clarificationZone) {
            clarificationZone.hidden = true;
            selectedClarification = null;
          }
        }
      } catch (error) {
        console.error('Error fetching random prompt:', error);
      } finally {
        randomPromptBtn.classList.remove('loading');
      }
    });
  }

  // ============================================
  // COMPTEUR DE CARACT√àRES
  // ============================================
  if (promptInput && charCount) {
    promptInput.addEventListener('input', () => {
      charCount.textContent = promptInput.value.length.toString();
      
      // Masquer l'erreur si elle √©tait visible et que l'utilisateur tape
      if (promptError) {
        promptError.hidden = true;
      }
      // Masquer la zone de clarification si l'utilisateur modifie son prompt
      if (clarificationZone) {
        clarificationZone.hidden = true;
        selectedClarification = null;
      }
      
      // Red√©marrer la rotation du placeholder si le champ est vid√©
      if (promptInput.value.length === 0 && !placeholderInterval) {
        startPlaceholderRotation();
      } else if (promptInput.value.length > 0 && placeholderInterval) {
        // Arr√™ter la rotation si l'utilisateur tape
        stopPlaceholderRotation();
      }
    });

    // Arr√™ter la rotation quand l'utilisateur commence √† taper
    promptInput.addEventListener('focus', () => {
      if (promptInput.value.length > 0) {
        stopPlaceholderRotation();
      }
    });
  }

  // Bouton annuler clarification
  if (cancelClarificationBtn && clarificationZone) {
    cancelClarificationBtn.addEventListener('click', () => {
      clarificationZone.hidden = true;
      selectedClarification = null;
      promptInput.focus();
    });
  }

  // Slider de questions
  const slider = document.getElementById('questionSlider') as HTMLInputElement;
  const countDisplay = document.getElementById('questionCount');

  if (slider && countDisplay) {
    slider.addEventListener('input', () => {
      countDisplay.textContent = slider.value;
    });
  }

  // Slider de timer (Premium+)
  const timerSlider = document.getElementById('timerSlider') as HTMLInputElement;
  const timerValueDisplay = document.getElementById('timerValue');

  if (timerSlider && timerValueDisplay) {
    timerSlider.addEventListener('input', () => {
      timerValueDisplay.textContent = timerSlider.value;
    });
  }

  /**
   * Affiche les options de clarification
   */
  function showClarifications(clarifications: Array<{ label: string; theme: string; confidence: number }>) {
    if (!clarificationZone || !clarificationOptions) return;

    clarificationOptions.innerHTML = clarifications.map((c, index) => `
      <button type="button" class="clarification-option" data-theme="${c.theme.replace(/"/g, '&quot;')}">
        <div class="clarification-option__label">${c.label}</div>
        <div class="clarification-option__theme">${c.theme}</div>
        <span class="clarification-option__confidence">${Math.round(c.confidence * 100)}% confiance</span>
      </button>
    `).join('');

    // Ajouter les √©v√©nements aux options
    clarificationOptions.querySelectorAll('.clarification-option').forEach((option) => {
      option.addEventListener('click', () => {
        const theme = option.getAttribute('data-theme');
        if (theme) {
          selectedClarification = theme;
          // Soumettre automatiquement avec la clarification s√©lectionn√©e
          submitQuizGeneration();
        }
      });
    });

    clarificationZone.hidden = false;
  }

  /**
   * Soumet la g√©n√©ration du quiz
   */
  async function submitQuizGeneration() {
    if (!form || !loadingOverlay) return;

    const formData = new FormData(form);
    const prompt = formData.get('prompt') as string;
    const difficulty = formData.get('difficulty') as string;
    const numberOfQuestions = parseInt(formData.get('numberOfQuestions') as string);
    const timer = formData.get('timer') as string;
    const timerSeconds = timer ? parseInt(timer, 10) : 10;

    // Afficher le loading
    loadingOverlay.style.display = 'flex';
    if (clarificationZone) {
      clarificationZone.hidden = true;
    }

    try {
      const response = await fetch('/api/quiz/generate-custom-quiz', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          prompt,
          difficulty,
          numberOfQuestions,
          timerSeconds,
          selectedClarification, // Envoyer la clarification si s√©lectionn√©e
        }),
      });

      const data = await response.json();

      console.log('‚úÖ API Response:', data);

      // G√©rer le mode clarification
      if (data.mode === 'clarify' && data.clarifications) {
        loadingOverlay.style.display = 'none';
        showClarifications(data.clarifications);
        return;
      }

      // G√©rer les erreurs
      if (!response.ok) {
        throw new Error(data.error || 'Erreur lors de la g√©n√©ration');
      }

      if (!data.sessionId) {
        throw new Error('Aucune session cr√©√©e');
      }

      console.log('‚úÖ Session cr√©√©e:', data.sessionId);

      // Rediriger vers le quiz avec l'ID de session
      window.location.href = `/quiz/play?session=${data.sessionId}`;
    } catch (error) {
      console.error('‚ùå Erreur:', error);
      loadingOverlay.style.display = 'none';
      selectedClarification = null;
      window.dispatchEvent(new CustomEvent('show-toast', { 
        detail: { 
          message: error instanceof Error ? error.message : 'Erreur lors de la g√©n√©ration du quiz', 
          type: 'error' 
        } 
      }));
    }
  }

  // Gestion du formulaire
  if (form && loadingOverlay) {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const formData = new FormData(form);
      const prompt = formData.get('prompt') as string;
      const difficulty = formData.get('difficulty') as string;
      const numberOfQuestions = parseInt(formData.get('numberOfQuestions') as string);

      // Validation basique c√¥t√© client (pr√©-filtre l√©ger)
      if (!prompt || prompt.trim().length < 6) {
        promptError!.hidden = false;
        promptError!.textContent = '‚ö†Ô∏è Le prompt doit contenir au moins 6 caract√®res';
        promptInput.focus();
        return;
      }

      if (!difficulty || !numberOfQuestions) {
        return;
      }

      // Soumettre la g√©n√©ration
      await submitQuizGeneration();
    });
  }
</script>
