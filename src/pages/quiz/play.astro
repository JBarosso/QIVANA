---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { requireAuth } from '../../lib/auth';
import { getQuizSession } from '../../lib/quiz';
import QuizPlayer from '../../components/quiz/QuizPlayer';

// Protection de la route
const { user } = await requireAuth(Astro);

// RÃ©cupÃ©rer les paramÃ¨tres
const sessionId = Astro.url.searchParams.get('session');
const questionIds = Astro.url.searchParams.get('ids');

let session;
let questions;
let orderedQuestions;

if (sessionId) {
  // Mode classique: charger depuis une session existante
  session = await getQuizSession(Astro.locals.supabase, sessionId);

  if (!session) {
    return Astro.redirect('/quiz/setup');
  }

  // VÃ©rifier que la session appartient Ã  l'utilisateur
  if (session.user_id !== user.id) {
    return Astro.redirect('/quiz/setup');
  }

  // Si la session est dÃ©jÃ  terminÃ©e, rediriger vers les rÃ©sultats
  if (session.completed_at) {
    return Astro.redirect(`/quiz/results?session=${sessionId}`);
  }

  // ============================================
  // MODE QUIZ CUSTOM: Questions stockÃ©es dans temp_questions
  // ============================================
  if (session.quiz_type === 'ai-custom-quiz' && session.temp_questions) {
    console.log('ğŸ¨ Loading custom-quiz questions from session.temp_questions');
    
    // CrÃ©er des objets Question Ã  partir de temp_questions
    orderedQuestions = (session.temp_questions as any[]).map((q: any, index: number) => ({
      id: session.questions_ids[index] || `temp-${index}`,
      question: q.question,
      choices: q.choices,
      correct_index: q.correct_index,
      explanation: q.explanation,
      difficulty: session.difficulty || 'medium',
      universe: session.universe || 'other',
      type: 'custom-quiz',
      created_by: 'ia',
      created_at: new Date().toISOString(),
    }));

    console.log('âœ… Loaded', orderedQuestions.length, 'custom-quiz questions');
  } else {
    // ============================================
    // MODE NORMAL: Charger les questions depuis la DB
    // ============================================
    const { data: questionsData, error } = await Astro.locals.supabase
      .from('questions')
      .select('*')
      .in('id', session.questions_ids);

    if (error || !questionsData) {
      console.error('Error loading questions:', error);
      return Astro.redirect('/quiz/setup');
    }

    questions = questionsData;

    // Ordonner les questions selon l'ordre de questions_ids
    orderedQuestions = session.questions_ids
      .map((id) => questions.find((q) => q.id === id))
      .filter(Boolean);
  }
} else if (questionIds) {
  // Mode quiz IA: crÃ©er une session Ã  la volÃ©e avec les IDs fournis
  const ids = questionIds.split(',');

  // Charger les questions
  const { data: questionsData, error } = await Astro.locals.supabase
    .from('questions')
    .select('*')
    .in('id', ids);

  if (error || !questionsData) {
    return Astro.redirect('/quiz/ai-setup?error=questions_not_found');
  }

  questions = questionsData;

  // CrÃ©er une session
  const { data: newSession, error: sessionError } = await Astro.locals.supabase
    .from('quiz_sessions')
    .insert({
      user_id: user.id,
      quiz_type: 'ai-predefined',
      quiz_mode: 'step-by-step',
      universe: questions[0]?.universe || 'other',
      difficulty: questions[0]?.difficulty || 'medium',
      questions_ids: ids,
      answers: [],
      score: 0,
      max_score: ids.length * 10,
      started_at: new Date().toISOString(),
    })
    .select()
    .single();

  if (sessionError || !newSession) {
    console.error('Error creating AI quiz session:', sessionError);
    return Astro.redirect('/quiz/ai-setup?error=session_creation_failed');
  }

  session = newSession;
  
  // Ordonner les questions selon l'ordre des IDs
  orderedQuestions = ids
    .map((id) => questions.find((q) => q.id === id))
    .filter(Boolean);
} else {
  return Astro.redirect('/quiz/setup');
}
---

<BaseLayout title="Quiz en cours - Qivana">
  <div class="quiz-play">
    <QuizPlayer
      client:load
      sessionId={session.id}
      questions={orderedQuestions}
      currentAnswers={session.answers}
    />
  </div>
</BaseLayout>

<style lang="scss">
@use '../../styles/pages/quiz' as *;
</style>
