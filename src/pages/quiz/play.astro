---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { requireAuth } from '../../lib/auth';
import { getQuizSession } from '../../lib/quiz';
import QuizPlayer from '../../components/quiz/QuizPlayer';
import type { TempQuestion, QuizSession, Question } from '../../types';
import type { SupabaseClient } from '@supabase/supabase-js';
import type { Database } from '../../types/supabase';

// Protection de la route
const authResult = await requireAuth(Astro);

// Si c'est une redirection, elle a d√©j√† √©t√© effectu√©e
if (authResult instanceof Response) {
  return authResult;
}

const { user } = authResult;

// R√©cup√©rer les param√®tres
const sessionId = Astro.url.searchParams.get('session');
const questionIds = Astro.url.searchParams.get('ids');

// Cast pour acc√©der √† supabase
const supabase = (Astro.locals as { supabase?: SupabaseClient<Database> }).supabase;
if (!supabase) {
  return Astro.redirect('/quiz/setup');
}

let session: QuizSession | null = null;
let questions: Question[] | null = null;
let orderedQuestions: Question[] = [];

if (sessionId) {
  // Mode classique: charger depuis une session existante
  session = await getQuizSession(supabase, sessionId);

  if (!session) {
    return Astro.redirect('/quiz/setup');
  }

  // V√©rifier que la session appartient √† l'utilisateur
  if (session.user_id !== user.id) {
    return Astro.redirect('/quiz/setup');
  }

  // Si la session est d√©j√† termin√©e, rediriger vers les r√©sultats
  if (session.completed_at) {
    return Astro.redirect(`/quiz/results?session=${sessionId}`);
  }

  // √Ä ce stade, session est garanti non-null
  const currentSession = session;

  // ============================================
  // MODE QUIZ CUSTOM: Questions stock√©es dans temp_questions
  // ============================================
  if (currentSession.quiz_type === 'ai-custom-quiz' && currentSession.temp_questions) {
    console.log('üé® Loading custom-quiz questions from session.temp_questions');
    
    // Cr√©er des objets Question √† partir de temp_questions
    const tempQuestions = currentSession.temp_questions as TempQuestion[];
    orderedQuestions = tempQuestions.map((q, index) => ({
      id: currentSession.questions_ids[index] || `temp-${index}`,
      question: q.question,
      choices: q.choices,
      correct_index: q.correct_index,
      explanation: q.explanation,
      difficulty: currentSession.difficulty || 'medium',
      universe: currentSession.universe || 'other',
      type: 'custom-quiz' as const,
      created_by: 'ia',
      created_at: new Date().toISOString(),
    }));

    console.log('‚úÖ Loaded', orderedQuestions.length, 'custom-quiz questions');
  } else {
    // ============================================
    // MODE NORMAL: Charger les questions depuis la DB
    // ============================================
    const { data: questionsData, error } = await supabase
      .from('questions')
      .select('*')
      .in('id', currentSession.questions_ids);

    if (error || !questionsData) {
      console.error('Error loading questions:', error);
      return Astro.redirect('/quiz/setup');
    }

    // Convertir les donn√©es Supabase (Json) en Question[] (string[])
    questions = questionsData.map((q) => ({
      ...q,
      choices: Array.isArray(q.choices) ? q.choices as string[] : [],
    })) as Question[];

    // Ordonner les questions selon l'ordre de questions_ids
    orderedQuestions = currentSession.questions_ids
      .map((id) => questions?.find((q: Question) => q.id === id))
      .filter((q): q is Question => q !== undefined);
  }
} else if (questionIds) {
  // Mode quiz IA: cr√©er une session √† la vol√©e avec les IDs fournis
  const ids = questionIds.split(',');

  // Charger les questions
  const { data: questionsData, error } = await supabase
    .from('questions')
    .select('*')
    .in('id', ids);

  if (error || !questionsData) {
    return Astro.redirect('/quiz/setup?error=questions_not_found');
  }

  // Convertir les donn√©es Supabase (Json) en Question[] (string[])
  questions = questionsData.map((q) => ({
    ...q,
    choices: Array.isArray(q.choices) ? q.choices as string[] : [],
  })) as Question[];

  // Cr√©er une session
  const { data: newSession, error: sessionError } = await supabase
    .from('quiz_sessions')
    .insert({
      user_id: user.id,
      quiz_type: 'ai-predefined',
      quiz_mode: 'step-by-step',
      universe: questions[0]?.universe || 'other',
      difficulty: questions[0]?.difficulty || 'medium',
      questions_ids: ids,
      answers: [],
      score: 0,
      max_score: ids.length * 20, // 20 points max par question (10 base + 10 bonus)
      timer_seconds: 10, // Par d√©faut pour les anciennes sessions
      started_at: new Date().toISOString(),
    })
    .select()
    .single();

  if (sessionError || !newSession) {
    console.error('Error creating AI quiz session:', sessionError);
    return Astro.redirect('/quiz/setup?error=session_creation_failed');
  }

  // Convertir le type Supabase en QuizSession
  session = {
    id: newSession.id,
    user_id: newSession.user_id,
    quiz_type: newSession.quiz_type,
    quiz_mode: newSession.quiz_mode,
    universe: newSession.universe,
    difficulty: newSession.difficulty,
    questions_ids: newSession.questions_ids,
    answers: newSession.answers,
    score: newSession.score,
    max_score: newSession.max_score,
    started_at: newSession.started_at,
    completed_at: newSession.completed_at,
    timer_seconds: newSession.timer_seconds ?? null,
  } as QuizSession;
  
  // Ordonner les questions selon l'ordre des IDs
  orderedQuestions = ids
    .map((id) => questions?.find((q: Question) => q.id === id))
    .filter((q): q is Question => q !== undefined);
} else {
  return Astro.redirect('/quiz/setup');
}
---

<BaseLayout title="Quiz en cours - Qivana">
  {session && (
    <div class="quiz-play">
      <QuizPlayer
        client:load
        sessionId={session.id}
        questions={orderedQuestions}
        currentAnswers={session.answers}
        timerSeconds={session.timer_seconds ?? 10}
      />
    </div>
  )}
</BaseLayout>

<style lang="scss">
@use '../../styles/pages/quiz' as *;
</style>
