---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { requireAuth } from '../../lib/auth';
import { getQuizSession, completeQuizSession } from '../../lib/quiz';

// Protection de la route
const { user, profile } = await requireAuth(Astro);

// RÃ©cupÃ©rer l'ID de session
const sessionId = Astro.url.searchParams.get('session');

if (!sessionId) {
  return Astro.redirect('/quiz/setup');
}

// Charger la session
const session = await getQuizSession(Astro.locals.supabase, sessionId);

if (!session) {
  return Astro.redirect('/quiz/setup');
}

// VÃ©rifier que la session appartient Ã  l'utilisateur
if (session.user_id !== user.id) {
  return Astro.redirect('/quiz/setup');
}

// Si pas encore terminÃ©e, marquer comme complÃ©tÃ©e
if (!session.completed_at) {
  await completeQuizSession(Astro.locals.supabase, sessionId);
}

// Charger les questions pour afficher les dÃ©tails
// âš ï¸ Pour le mode custom-quiz, les questions n'existent pas en DB (IDs temporaires)
let questions = null;

if (session.quiz_type !== 'ai-custom-quiz') {
  const { data: questionsData } = await Astro.locals.supabase
    .from('questions')
    .select('*')
    .in('id', session.questions_ids);
  questions = questionsData;
}

// Calculer les stats
const totalQuestions = session.questions_ids.length;
const answeredQuestions = Array.isArray(session.answers) ? session.answers.filter((a) => a !== null).length : 0;

// Pour les correctAnswers, on ne peut pas les calculer prÃ©cisÃ©ment pour custom-quiz car les questions ne sont pas en DB
// On utilise le score comme proxy
const correctAnswers = session.quiz_type === 'ai-custom-quiz' 
  ? Math.round(session.score / 10) // Estimation basÃ©e sur score (10 pts/question max)
  : (session.answers as any[]).filter((answer, index) => {
      if (answer === null) return false;
      const question = questions?.find((q) => q.id === session.questions_ids[index]);
      return question && answer === question.correct_index;
    }).length;

const incorrectAnswers = answeredQuestions - correctAnswers;
const accuracy = totalQuestions > 0 ? Math.round((correctAnswers / totalQuestions) * 100) : 0;
const finalScore = Math.round(session.score * 100) / 100;

// DÃ©terminer le rank basÃ© sur le score
let rank = 'ğŸ¥‰ Bronze';
let rankClass = 'bronze';
if (accuracy >= 90) {
  rank = 'ğŸ† LÃ©gende';
  rankClass = 'legend';
} else if (accuracy >= 75) {
  rank = 'ğŸ¥‡ Or';
  rankClass = 'gold';
} else if (accuracy >= 50) {
  rank = 'ğŸ¥ˆ Argent';
  rankClass = 'silver';
}
---

<BaseLayout title="RÃ©sultats du Quiz - Qivana">
  <div class="quiz-results">
    <div class="quiz-results__container">
      {/* Header avec rank */}
      <div class={`quiz-results__header quiz-results__header--${rankClass}`}>
        <div class="quiz-results__rank">{rank}</div>
        <h1 class="quiz-results__title">Quiz TerminÃ© !</h1>
        <p class="quiz-results__subtitle">
          {session.universe.toUpperCase()} â€¢ {session.difficulty === 'easy' ? 'Facile' : session.difficulty === 'medium' ? 'Moyen' : 'Difficile'}
        </p>
      </div>

      {/* Score principal */}
      <div class="quiz-results__score-card">
        <div class="quiz-results__score-value">{finalScore}</div>
        <div class="quiz-results__score-label">Points totaux</div>
      </div>

      {/* Stats grid */}
      <div class="quiz-results__stats">
        <div class="stat-card stat-card--success">
          <div class="stat-card__icon">âœ“</div>
          <div class="stat-card__value">{correctAnswers}</div>
          <div class="stat-card__label">Bonnes rÃ©ponses</div>
        </div>

        <div class="stat-card stat-card--danger">
          <div class="stat-card__icon">âœ—</div>
          <div class="stat-card__value">{incorrectAnswers}</div>
          <div class="stat-card__label">Mauvaises rÃ©ponses</div>
        </div>

        <div class="stat-card stat-card--primary">
          <div class="stat-card__icon">ğŸ¯</div>
          <div class="stat-card__value">{accuracy}%</div>
          <div class="stat-card__label">PrÃ©cision</div>
        </div>
      </div>

      {/* Messages motivants */}
      <div class="quiz-results__message">
        {accuracy >= 90 && (
          <p>ğŸ”¥ Incroyable ! Tu es un vÃ©ritable expert de {session.universe} !</p>
        )}
        {accuracy >= 75 && accuracy < 90 && (
          <p>ğŸ‘ Excellent travail ! Continue comme Ã§a !</p>
        )}
        {accuracy >= 50 && accuracy < 75 && (
          <p>ğŸ’ª Pas mal ! Encore un peu de pratique et ce sera parfait !</p>
        )}
        {accuracy < 50 && (
          <p>ğŸ˜Š Bon dÃ©but ! Recommence pour amÃ©liorer ton score !</p>
        )}
      </div>

      {/* Actions */}
      <div class="quiz-results__actions">
        <a href="/quiz/setup" class="btn btn--primary btn--large">
          Nouveau Quiz ğŸš€
        </a>
        <a href="/profile" class="btn btn--secondary btn--large">
          Mon Profil
        </a>
      </div>

      {/* Share (optionnel pour plus tard) */}
      <div class="quiz-results__share">
        <p class="quiz-results__share-label">Partage ton score !</p>
        <div class="quiz-results__share-buttons">
          <button class="share-btn share-btn--twitter" disabled>
            ğŸ¦ Twitter
          </button>
          <button class="share-btn share-btn--discord" disabled>
            ğŸ’¬ Discord
          </button>
        </div>
        <p class="quiz-results__share-note">(BientÃ´t disponible)</p>
      </div>
    </div>
  </div>
</BaseLayout>

<style lang="scss">
@use '../../styles/pages/quiz' as *;
</style>
