---
// ============================================
// OAUTH CALLBACK
// ============================================
// Handles OAuth redirect after authentication
// Supports PKCE flow (code) - recommended by Supabase

import { createServerClient } from '@supabase/ssr';
import type { Database } from '@/types/supabase';

// Get URL parameters
const requestUrl = new URL(Astro.request.url);
const code = requestUrl.searchParams.get('code');
const error = requestUrl.searchParams.get('error');
const errorDescription = requestUrl.searchParams.get('error_description');
const type = requestUrl.searchParams.get('type'); // 'email-confirmation' ou undefined
// Pour la confirmation d'email, rediriger vers /profile si pas de 'next'
// Pour OAuth, utiliser 'next' ou rediriger vers /profile
const next = requestUrl.searchParams.get('next') || (type === 'email-confirmation' ? '/profile' : '/profile');

// Create Supabase client with cookie handling
const supabase = createServerClient(
  import.meta.env.PUBLIC_SUPABASE_URL,
  import.meta.env.PUBLIC_SUPABASE_ANON_KEY,
  {
    cookies: {
      get(key) {
        return Astro.cookies.get(key)?.value;
      },
      set(key, value, options) {
        Astro.cookies.set(key, value, options);
      },
      remove(key, options) {
        Astro.cookies.delete(key, options);
      },
    },
  }
);

// Handle OAuth errors from provider
if (error) {
  console.error('OAuth error:', error, errorDescription);
  return Astro.redirect(
    `/auth/login?error=${encodeURIComponent(errorDescription || error || 'Erreur d\'authentification')}`
  );
}

// PKCE flow: exchange code for session
if (code) {
  const { error: exchangeError } = await supabase.auth.exchangeCodeForSession(code);

  if (!exchangeError) {
    // Success: redirect to the next page
    return Astro.redirect(next);
  } else {
    console.error('OAuth callback exchange error:', exchangeError);
    return Astro.redirect(
      `/auth/login?error=${encodeURIComponent(exchangeError.message || 'Erreur lors de l\'Ã©change du code')}`
    );
  }
}

// No code: redirect to login with error
console.error('OAuth callback: No code found in URL');
return Astro.redirect('/auth/login?error=Code+OAuth+manquant');
---
