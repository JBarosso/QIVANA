---
// ============================================
// PAGE PRICING - Tarifs publics
// ============================================

import BaseLayout from '@/layouts/BaseLayout.astro';
import { PLANS } from '@/lib/stripe';
import { getCreditsForPack } from '@/lib/ai-credits-config';

// R√©cup√©rer l'utilisateur s'il est connect√©
const supabase = (Astro.locals as any).supabase;
let user = null;
let currentPlan = 'freemium';

if (supabase) {
  const { data: { user: authUser } } = await supabase.auth.getUser();
  user = authUser;
  
  if (user) {
    const { data: profile } = await supabase
      .from('profiles')
      .select('plan')
      .eq('id', user.id)
      .single();
    
    if (profile) {
      currentPlan = profile.plan;
    }
  }
}

const plans = Object.values(PLANS);

// D√©finir les packs de cr√©dits
const creditPacks = [
  {
    name: 'starter',
    displayName: 'Pack Starter',
    credits: getCreditsForPack('starter'),
    price: 1.99,
    description: 'Parfait pour tester',
    popular: false,
  },
  {
    name: 'standard',
    displayName: 'Pack Standard',
    credits: getCreditsForPack('standard'),
    price: 4.99,
    description: 'Le meilleur rapport qualit√©/prix',
    popular: true,
  },
  {
    name: 'pro',
    displayName: 'Pack Pro',
    credits: getCreditsForPack('pro'),
    price: 9.99,
    description: 'Pour les gros g√©n√©rateurs',
    popular: false,
  },
];
---

<BaseLayout title="Tarifs" description="D√©couvrez les offres Qivana : Freemium, Premium et Premium+">
  <main class="pricing-page">
    <section class="pricing-hero">
      <h1 class="pricing-hero__title">
        Choisissez votre <span class="gradient-text">aventure</span>
      </h1>
      <p class="pricing-hero__subtitle">
        Des quiz illimit√©s aux duels √©piques, trouvez le plan qui vous correspond
      </p>
    </section>

    <!-- Toggle mensuel/annuel -->
    <div class="pricing-toggle">
      <button class="pricing-toggle__btn pricing-toggle__btn--active" data-billing="monthly">
        Mensuel
      </button>
      <button class="pricing-toggle__btn" data-billing="yearly">
        Annuel
        <span class="pricing-toggle__badge">-17%</span>
      </button>
    </div>

    <!-- Plans Grid -->
    <div class="pricing-grid">
      {plans.map((plan) => (
        <div class={`pricing-card ${plan.popular ? 'pricing-card--popular' : ''} ${currentPlan === plan.name ? 'pricing-card--current' : ''}`}>
          {plan.popular && (
            <div class="pricing-card__badge">üî• Populaire</div>
          )}
          
          {currentPlan === plan.name && (
            <div class="pricing-card__current-badge">‚úì Votre plan actuel</div>
          )}

          <div class="pricing-card__header">
            <h2 class="pricing-card__name">{plan.displayName}</h2>
            <p class="pricing-card__description">{plan.description}</p>
          </div>

          <div class="pricing-card__pricing">
            <div class="pricing-card__price" data-monthly={plan.monthlyPrice} data-yearly={plan.yearlyPrice}>
              <span class="pricing-card__currency">‚Ç¨</span>
              <span class="pricing-card__amount">{plan.monthlyPrice}</span>
              <span class="pricing-card__period">/mois</span>
            </div>
            {plan.yearlyPrice > 0 && (
              <div class="pricing-card__total-yearly" data-yearly={plan.yearlyPrice}>
                <span class="pricing-card__total-yearly-label">Total :</span>
                <span class="pricing-card__total-yearly-amount">‚Ç¨{plan.yearlyPrice}</span>
                <span class="pricing-card__total-yearly-period">/an</span>
              </div>
            )}
            {plan.yearlyDiscount && (
              <div class="pricing-card__discount" data-discount={plan.yearlyDiscount}>
                {plan.yearlyDiscount}
              </div>
            )}
          </div>

          <ul class="pricing-card__features">
            {plan.features.map((feature) => (
              <li class="pricing-card__feature">
                <span class="pricing-card__feature-icon">‚úì</span>
                {feature}
              </li>
            ))}
          </ul>

          <div class="pricing-card__cta">
            {plan.name === 'freemium' ? (
              user ? (
                <a href="/quiz" class="btn btn--outline btn--full">
                  Jouer gratuitement
                </a>
              ) : (
                <a href="/auth/signup" class="btn btn--outline btn--full">
                  Commencer gratuitement
                </a>
              )
            ) : currentPlan === plan.name ? (
              <button class="btn btn--secondary btn--full" disabled>
                Plan actuel
              </button>
            ) : (
              <button 
                class="btn btn--primary btn--full btn--subscribe"
                data-plan={plan.name}
                data-billing="monthly"
              >
                {currentPlan === 'freemium' ? 'Passer √† ' + plan.displayName : 'Changer pour ' + plan.displayName}
              </button>
            )}
          </div>
        </div>
      ))}
    </div>

    <!-- Section Packs de Cr√©dits IA -->
    <section class="credits-section" id="credits">
      <div class="credits-section__header">
        <h2 class="credits-section__title">
          Besoin de plus de cr√©dits IA ?
        </h2>
        <p class="credits-section__subtitle">
          Achetez des cr√©dits bonus qui ne se p√©riment jamais
        </p>
      </div>

      <div class="credits-grid">
        {creditPacks.map((pack) => (
          <div class={`credit-card ${pack.popular ? 'credit-card--popular' : ''}`}>
            {pack.popular && (
              <div class="credit-card__badge">‚≠ê Meilleur rapport</div>
            )}

            <div class="credit-card__header">
              <h3 class="credit-card__name">{pack.displayName}</h3>
              <p class="credit-card__description">{pack.description}</p>
            </div>

            <div class="credit-card__credits">
              <span class="credit-card__credits-amount">{pack.credits}</span>
              <span class="credit-card__credits-label">cr√©dits IA</span>
            </div>

            <div class="credit-card__price">
              <span class="credit-card__currency">‚Ç¨</span>
              <span class="credit-card__amount">{pack.price}</span>
            </div>

            <ul class="credit-card__features">
              <li>‚úì Ne se p√©riment jamais</li>
              <li>‚úì Utilis√©s en priorit√©</li>
              <li>‚úì Paiement unique</li>
              <li>‚úì Tous les modes de jeu</li>
            </ul>

            <button 
              class="btn btn--primary btn--full btn--buy-credits"
              data-pack={pack.name}
            >
              Acheter
            </button>
          </div>
        ))}
      </div>

      <div class="credits-section__info">
        <p>
          üí° <strong>Comment √ßa marche ?</strong> 
          Les cr√©dits bonus sont utilis√©s en priorit√© avant votre quota mensuel. 
          Parfait pour les mois o√π vous g√©n√©rez plus de quiz que d'habitude !
        </p>
      </div>
    </section>

    <!-- FAQ Section -->
    <section class="pricing-faq">
      <h2 class="pricing-faq__title">Questions fr√©quentes</h2>
      
      <div class="pricing-faq__grid">
        <div class="pricing-faq__item">
          <h3 class="pricing-faq__question">Puis-je changer de plan √† tout moment ?</h3>
          <p class="pricing-faq__answer">
            Oui ! Vous pouvez upgrader ou downgrader votre abonnement √† tout moment. 
            Les changements prennent effet imm√©diatement.
          </p>
        </div>

        <div class="pricing-faq__item">
          <h3 class="pricing-faq__question">Comment fonctionne le paiement ?</h3>
          <p class="pricing-faq__answer">
            Nous utilisons Stripe pour les paiements s√©curis√©s. Vous pouvez payer par carte 
            bancaire et g√©rer votre abonnement √† tout moment.
          </p>
        </div>

        <div class="pricing-faq__item">
          <h3 class="pricing-faq__question">Puis-je annuler mon abonnement ?</h3>
          <p class="pricing-faq__answer">
            Oui, vous pouvez annuler √† tout moment depuis votre profil. Vous conserverez 
            les avantages jusqu'√† la fin de la p√©riode pay√©e.
          </p>
        </div>

        <div class="pricing-faq__item">
          <h3 class="pricing-faq__question">Que signifie "~200 quiz IA/mois" ?</h3>
          <p class="pricing-faq__answer">
            C'est une limite Fair Use pour √©viter les abus. En utilisation normale, 
            vous ne l'atteindrez jamais !
          </p>
        </div>
      </div>
    </section>
  </main>
</BaseLayout>

<script>
  // Toggle mensuel/annuel
  const toggleBtns = document.querySelectorAll('.pricing-toggle__btn');
  const priceElements = document.querySelectorAll('.pricing-card__price');
  const totalYearlyElements = document.querySelectorAll('.pricing-card__total-yearly');
  const discountElements = document.querySelectorAll('.pricing-card__discount');
  const subscribeBtns = document.querySelectorAll('.btn--subscribe');

  toggleBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      const billing = btn.getAttribute('data-billing');
      
      // Update toggle state
      toggleBtns.forEach(b => b.classList.remove('pricing-toggle__btn--active'));
      btn.classList.add('pricing-toggle__btn--active');

      // Update prices
      priceElements.forEach(el => {
        const monthly = parseFloat(el.getAttribute('data-monthly') || '0');
        const yearly = parseFloat(el.getAttribute('data-yearly') || '0');
        
        const amountEl = el.querySelector('.pricing-card__amount');
        const periodEl = el.querySelector('.pricing-card__period');
        
        if (amountEl && periodEl) {
          if (billing === 'yearly' && yearly > 0) {
            amountEl.textContent = (yearly / 12).toFixed(2);
            periodEl.textContent = '/mois (factur√© annuellement)';
          } else {
            amountEl.textContent = monthly.toString();
            periodEl.textContent = '/mois';
          }
        }
      });

      // Show/hide total yearly amount
      totalYearlyElements.forEach(el => {
        const htmlEl = el as HTMLElement;
        const yearly = parseFloat(htmlEl.getAttribute('data-yearly') || '0');
        const amountEl = htmlEl.querySelector('.pricing-card__total-yearly-amount');
        
        if (amountEl && yearly > 0) {
          if (billing === 'yearly') {
            htmlEl.classList.add('pricing-card__total-yearly--visible');
            amountEl.textContent = `‚Ç¨${yearly}`;
          } else {
            htmlEl.classList.remove('pricing-card__total-yearly--visible');
          }
        }
      });

      // Show/hide discount badges
      discountElements.forEach(el => {
        if (billing === 'yearly') {
          el.classList.add('pricing-card__discount--visible');
        } else {
          el.classList.remove('pricing-card__discount--visible');
        }
      });

      // Update subscribe buttons
      subscribeBtns.forEach(btn => {
        btn.setAttribute('data-billing', billing || 'monthly');
      });
    });
  });

  // Subscribe button click
  subscribeBtns.forEach(btn => {
    btn.addEventListener('click', async () => {
      const plan = btn.getAttribute('data-plan');
      const billing = btn.getAttribute('data-billing');

      // Disable button
      btn.setAttribute('disabled', 'true');
      btn.textContent = 'Chargement...';

      try {
        const response = await fetch('/api/stripe/create-checkout', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ plan, billing }),
        });

        const data = await response.json();

        if (data.url) {
          window.location.href = data.url;
        } else if (data.redirect) {
          window.location.href = data.redirect;
        } else {
          throw new Error(data.error || 'Erreur inconnue');
        }
      } catch (error) {
        console.error('Checkout error:', error);
        window.dispatchEvent(new CustomEvent('show-toast', { detail: { message: 'Une erreur est survenue. Veuillez r√©essayer.', type: 'error' } }));
        btn.removeAttribute('disabled');
        btn.textContent = 'R√©essayer';
      }
    });
  });

  // G√©rer l'achat de packs de cr√©dits
  const buyCreditsButtons = document.querySelectorAll('.btn--buy-credits');
  buyCreditsButtons.forEach((btn) => {
    btn.addEventListener('click', async () => {
      const packType = (btn as HTMLButtonElement).dataset.pack;

      if (!packType) return;

      // D√©sactiver le bouton
      btn.setAttribute('disabled', 'true');
      if (btn instanceof HTMLButtonElement) {
        btn.textContent = 'Chargement...';
      }

      try {
        const response = await fetch('/api/stripe/create-checkout', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            type: 'credit_pack',
            packType: packType 
          }),
        });

        const data = await response.json();

        if (data.url) {
          window.location.href = data.url;
        } else if (data.redirect) {
          window.location.href = data.redirect;
        } else {
          throw new Error(data.error || 'Erreur inconnue');
        }
      } catch (error) {
        console.error('Checkout error:', error);
        window.dispatchEvent(new CustomEvent('show-toast', { 
          detail: { 
            message: 'Une erreur est survenue. Veuillez r√©essayer.', 
            type: 'error' 
          } 
        }));
        btn.removeAttribute('disabled');
        if (btn instanceof HTMLButtonElement) {
          btn.textContent = 'R√©essayer';
        }
      }
    });
  });
</script>
