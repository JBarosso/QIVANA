---
// ============================================
// ADMIN - ANALYTICS & ROI
// ============================================

import AdminLayout from '@/layouts/AdminLayout.astro';

const supabase = (Astro.locals as { supabase?: any }).supabase;

// DonnÃ©es pour les graphiques
let aiUsageData: any[] = [];
let monthlyStats: any[] = [];
let userGrowthData: any[] = [];
let quizStats = {
  total: 0,
  thisMonth: 0,
  thisWeek: 0,
};
let usageByPlan: any[] = [];
let usageByMode: any[] = [];
let creditPurchases: any[] = [];

if (supabase) {
  // AI Usage par jour (30 derniers jours)
  const thirtyDaysAgo = new Date();
  thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);

  const { data: aiUsage } = await supabase
    .from('ai_usage')
    .select('created_at, questions_count, estimated_cost_cents, quiz_type, mode, plan_at_time, credits_consumed')
    .gte('created_at', thirtyDaysAgo.toISOString())
    .order('created_at', { ascending: true });

  aiUsageData = aiUsage || [];

  // Stats par plan
  const { data: usageByPlan } = await supabase
    .from('ai_usage')
    .select('plan_at_time, credits_consumed')
    .gte('created_at', thirtyDaysAgo.toISOString());

  // Stats par mode
  const { data: usageByMode } = await supabase
    .from('ai_usage')
    .select('mode, credits_consumed')
    .gte('created_at', thirtyDaysAgo.toISOString());

  // Revenus des packs de crÃ©dits
  const { data: creditPurchases } = await supabase
    .from('ai_credit_purchases')
    .select('amount_cents, credits_purchased, purchased_at')
    .gte('purchased_at', thirtyDaysAgo.toISOString());

  // Stats mensuelles (6 derniers mois)
  for (let i = 5; i >= 0; i--) {
    const monthStart = new Date();
    monthStart.setMonth(monthStart.getMonth() - i);
    monthStart.setDate(1);
    monthStart.setHours(0, 0, 0, 0);

    const monthEnd = new Date(monthStart);
    monthEnd.setMonth(monthEnd.getMonth() + 1);

    const { count: aiCount } = await supabase
      .from('ai_usage')
      .select('*', { count: 'exact', head: true })
      .gte('created_at', monthStart.toISOString())
      .lt('created_at', monthEnd.toISOString());

    const { data: aiCostData } = await supabase
      .from('ai_usage')
      .select('estimated_cost_cents')
      .gte('created_at', monthStart.toISOString())
      .lt('created_at', monthEnd.toISOString());

    const totalCost = aiCostData?.reduce((acc: number, u: any) => acc + (u.estimated_cost_cents || 0), 0) || 0;

    const { count: newUsers } = await supabase
      .from('profiles')
      .select('*', { count: 'exact', head: true })
      .gte('created_at', monthStart.toISOString())
      .lt('created_at', monthEnd.toISOString());

    const { count: quizCount } = await supabase
      .from('quiz_sessions')
      .select('*', { count: 'exact', head: true })
      .gte('started_at', monthStart.toISOString())
      .lt('started_at', monthEnd.toISOString());

    monthlyStats.push({
      month: monthStart.toLocaleDateString('fr-FR', { month: 'short', year: '2-digit' }),
      aiUsage: aiCount || 0,
      aiCost: totalCost / 100, // Convert to euros
      newUsers: newUsers || 0,
      quizzes: quizCount || 0,
    });
  }

  // Quiz stats
  const { count: totalQuizzes } = await supabase
    .from('quiz_sessions')
    .select('*', { count: 'exact', head: true });
  quizStats.total = totalQuizzes || 0;

  const startOfMonth = new Date();
  startOfMonth.setDate(1);
  startOfMonth.setHours(0, 0, 0, 0);

  const { count: monthQuizzes } = await supabase
    .from('quiz_sessions')
    .select('*', { count: 'exact', head: true })
    .gte('started_at', startOfMonth.toISOString());
  quizStats.thisMonth = monthQuizzes || 0;

  const startOfWeek = new Date();
  startOfWeek.setDate(startOfWeek.getDate() - 7);

  const { count: weekQuizzes } = await supabase
    .from('quiz_sessions')
    .select('*', { count: 'exact', head: true })
    .gte('started_at', startOfWeek.toISOString());
  quizStats.thisWeek = weekQuizzes || 0;
}

// PrÃ©parer les donnÃ©es pour les graphiques
const chartLabels = monthlyStats.map(s => s.month);
const aiUsageValues = monthlyStats.map(s => s.aiUsage);
const aiCostValues = monthlyStats.map(s => s.aiCost);
const newUsersValues = monthlyStats.map(s => s.newUsers);
const quizzesValues = monthlyStats.map(s => s.quizzes);

// Total AI cost
const totalAiCost = aiCostValues.reduce((a, b) => a + b, 0);
const avgMonthlyCost = totalAiCost / (aiCostValues.length || 1);

// Stats par plan
const planStats: Record<string, { count: number; credits: number }> = {};
if (usageByPlan) {
  usageByPlan.forEach((u: any) => {
    const plan = u.plan_at_time || 'unknown';
    if (!planStats[plan]) {
      planStats[plan] = { count: 0, credits: 0 };
    }
    planStats[plan].count += 1;
    planStats[plan].credits += u.credits_consumed || 1;
  });
}

// Stats par mode
const modeStats: Record<string, { count: number; credits: number }> = {};
if (usageByMode) {
  usageByMode.forEach((u: any) => {
    const mode = u.mode || 'unknown';
    if (!modeStats[mode]) {
      modeStats[mode] = { count: 0, credits: 0 };
    }
    modeStats[mode].count += 1;
    modeStats[mode].credits += u.credits_consumed || 1;
  });
}

// Revenus des packs de crÃ©dits
const totalCreditRevenue = creditPurchases?.reduce((acc: number, p: any) => acc + (p.amount_cents || 0), 0) || 0;
const totalCreditsSold = creditPurchases?.reduce((acc: number, p: any) => acc + (p.credits_purchased || 0), 0) || 0;
---

<AdminLayout title="Analytics" currentPage="analytics">
  <!-- Chart.js via CDN -->
  <script is:inline src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.js"></script>
  
  <!-- Hidden div pour passer les donnÃ©es au script -->
  <div 
    id="chartData" 
    style="display: none;"
    data-labels={JSON.stringify(chartLabels)}
    data-aiusage={JSON.stringify(aiUsageValues)}
    data-aicost={JSON.stringify(aiCostValues)}
    data-newusers={JSON.stringify(newUsersValues)}
    data-quizzes={JSON.stringify(quizzesValues)}
  ></div>

  <!-- Summary Stats -->
  <div class="admin-stats">
    <div class="admin-stat-card">
      <div class="admin-stat-card__icon">ðŸŽ®</div>
      <div class="admin-stat-card__value">{quizStats.total}</div>
      <div class="admin-stat-card__label">Quiz jouÃ©s (total)</div>
    </div>

    <div class="admin-stat-card">
      <div class="admin-stat-card__icon">ðŸ“…</div>
      <div class="admin-stat-card__value">{quizStats.thisMonth}</div>
      <div class="admin-stat-card__label">Quiz ce mois</div>
    </div>

    <div class="admin-stat-card">
      <div class="admin-stat-card__icon">ðŸ“†</div>
      <div class="admin-stat-card__value">{quizStats.thisWeek}</div>
      <div class="admin-stat-card__label">Quiz cette semaine</div>
    </div>

    <div class="admin-stat-card admin-stat-card--highlight">
      <div class="admin-stat-card__icon">ðŸ’°</div>
      <div class="admin-stat-card__value">{totalAiCost.toFixed(2)}â‚¬</div>
      <div class="admin-stat-card__label">CoÃ»t AI total (6 mois)</div>
    </div>

    <div class="admin-stat-card">
      <div class="admin-stat-card__icon">ðŸ“Š</div>
      <div class="admin-stat-card__value">{avgMonthlyCost.toFixed(2)}â‚¬</div>
      <div class="admin-stat-card__label">CoÃ»t AI mensuel moyen</div>
    </div>

    <div class="admin-stat-card admin-stat-card--revenue">
      <div class="admin-stat-card__icon">ðŸ’µ</div>
      <div class="admin-stat-card__value">{(totalCreditRevenue / 100).toFixed(2)}â‚¬</div>
      <div class="admin-stat-card__label">Revenus packs crÃ©dits (30j)</div>
    </div>

    <div class="admin-stat-card">
      <div class="admin-stat-card__icon">ðŸŽ¯</div>
      <div class="admin-stat-card__value">{totalCreditsSold}</div>
      <div class="admin-stat-card__label">CrÃ©dits vendus (30j)</div>
    </div>
  </div>

  <!-- Charts Grid -->
  <div class="charts-grid">
    <!-- AI Usage Chart -->
    <section class="admin-section chart-section">
      <div class="admin-section__header">
        <h2 class="admin-section__title">ðŸ¤– Utilisation IA (6 mois)</h2>
      </div>
      <div class="chart-container">
        <canvas id="aiUsageChart"></canvas>
      </div>
    </section>

    <!-- AI Cost Chart -->
    <section class="admin-section chart-section">
      <div class="admin-section__header">
        <h2 class="admin-section__title">ðŸ’° CoÃ»t IA (â‚¬)</h2>
      </div>
      <div class="chart-container">
        <canvas id="aiCostChart"></canvas>
      </div>
    </section>

    <!-- User Growth Chart -->
    <section class="admin-section chart-section">
      <div class="admin-section__header">
        <h2 class="admin-section__title">ðŸ‘¥ Nouveaux utilisateurs</h2>
      </div>
      <div class="chart-container">
        <canvas id="userGrowthChart"></canvas>
      </div>
    </section>

    <!-- Quiz Activity Chart -->
    <section class="admin-section chart-section">
      <div class="admin-section__header">
        <h2 class="admin-section__title">ðŸŽ® ActivitÃ© Quiz</h2>
      </div>
      <div class="chart-container">
        <canvas id="quizActivityChart"></canvas>
      </div>
    </section>
  </div>

  <!-- Ventilation par Plan -->
  <section class="admin-section">
    <div class="admin-section__header">
      <h2 class="admin-section__title">ðŸ“Š Utilisation par Plan (30 derniers jours)</h2>
    </div>
    <div class="stats-grid">
      {Object.entries(planStats).map(([plan, stats]) => (
        <div class="stat-breakdown-card">
          <div class="stat-breakdown-card__plan">{plan}</div>
          <div class="stat-breakdown-card__value">{stats.count}</div>
          <div class="stat-breakdown-card__label">GÃ©nÃ©rations</div>
          <div class="stat-breakdown-card__subvalue">{stats.credits} crÃ©dits</div>
        </div>
      ))}
    </div>
  </section>

  <!-- Ventilation par Mode -->
  <section class="admin-section">
    <div class="admin-section__header">
      <h2 class="admin-section__title">ðŸŽ® Utilisation par Mode (30 derniers jours)</h2>
    </div>
    <div class="stats-grid">
      {Object.entries(modeStats).map(([mode, stats]) => (
        <div class="stat-breakdown-card">
          <div class="stat-breakdown-card__plan">{mode || 'unknown'}</div>
          <div class="stat-breakdown-card__value">{stats.count}</div>
          <div class="stat-breakdown-card__label">GÃ©nÃ©rations</div>
          <div class="stat-breakdown-card__subvalue">{stats.credits} crÃ©dits</div>
        </div>
      ))}
    </div>
  </section>

  <!-- ROI Section -->
  <section class="admin-section">
    <div class="admin-section__header">
      <h2 class="admin-section__title">ðŸ“ˆ ROI Analysis</h2>
    </div>
    <div class="roi-grid">
      <div class="roi-card">
        <div class="roi-card__title">CoÃ»t par Quiz AI</div>
        <div class="roi-card__value">
          {aiUsageValues.reduce((a, b) => a + b, 0) > 0 
            ? (totalAiCost / aiUsageValues.reduce((a, b) => a + b, 0)).toFixed(3) 
            : '0.00'}â‚¬
        </div>
        <div class="roi-card__description">
          CoÃ»t moyen par gÃ©nÃ©ration de quiz AI
        </div>
      </div>

      <div class="roi-card">
        <div class="roi-card__title">CoÃ»t par Utilisateur</div>
        <div class="roi-card__value">
          {newUsersValues.reduce((a, b) => a + b, 0) > 0 
            ? (totalAiCost / newUsersValues.reduce((a, b) => a + b, 0)).toFixed(2) 
            : '0.00'}â‚¬
        </div>
        <div class="roi-card__description">
          CoÃ»t AI moyen par nouvel utilisateur
        </div>
      </div>

      <div class="roi-card roi-card--highlight">
        <div class="roi-card__title">Break-even Premium</div>
        <div class="roi-card__value">
          {avgMonthlyCost > 0 ? Math.ceil(avgMonthlyCost / 4.99) : 0}
        </div>
        <div class="roi-card__description">
          Abonnements Premium nÃ©cessaires pour couvrir les coÃ»ts AI
          <br/><small>(Ã  4.99â‚¬/mois)</small>
        </div>
      </div>

      <div class="roi-card roi-card--revenue">
        <div class="roi-card__title">Revenus vs CoÃ»ts (30j)</div>
        <div class="roi-card__value">
          {totalCreditRevenue > 0 && totalAiCost > 0
            ? ((totalCreditRevenue / 100) / totalAiCost).toFixed(2)
            : '0.00'}x
        </div>
        <div class="roi-card__description">
          Ratio revenus packs / coÃ»ts AI
          <br/><small>Revenus: {(totalCreditRevenue / 100).toFixed(2)}â‚¬ | CoÃ»ts: {totalAiCost.toFixed(2)}â‚¬</small>
        </div>
      </div>
    </div>
  </section>
</AdminLayout>

<script is:inline>
  // Attendre que Chart.js soit chargÃ©
  window.addEventListener('load', function() {
    if (typeof Chart === 'undefined') {
      console.error('Chart.js not loaded');
      return;
    }

    // RÃ©cupÃ©rer les donnÃ©es depuis les attributs data
    const chartData = document.getElementById('chartData');
    if (!chartData) return;

    const chartLabels = JSON.parse(chartData.dataset.labels || '[]');
    const aiUsageValues = JSON.parse(chartData.dataset.aiusage || '[]');
    const aiCostValues = JSON.parse(chartData.dataset.aicost || '[]');
    const newUsersValues = JSON.parse(chartData.dataset.newusers || '[]');
    const quizzesValues = JSON.parse(chartData.dataset.quizzes || '[]');

  // Configuration commune
  const commonOptions = {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: {
        display: false,
      },
    },
    scales: {
      y: {
        beginAtZero: true,
        grid: {
          color: 'rgba(255, 255, 255, 0.1)',
        },
        ticks: {
          color: 'rgba(255, 255, 255, 0.7)',
        },
      },
      x: {
        grid: {
          display: false,
        },
        ticks: {
          color: 'rgba(255, 255, 255, 0.7)',
        },
      },
    },
  };

  // AI Usage Chart
  new Chart(document.getElementById('aiUsageChart'), {
    type: 'bar',
    data: {
      labels: chartLabels,
      datasets: [{
        data: aiUsageValues,
        backgroundColor: 'rgba(14, 165, 233, 0.8)',
        borderColor: 'rgb(14, 165, 233)',
        borderWidth: 1,
        borderRadius: 4,
      }],
    },
    options: commonOptions,
  });

  // AI Cost Chart
  new Chart(document.getElementById('aiCostChart'), {
    type: 'line',
    data: {
      labels: chartLabels,
      datasets: [{
        data: aiCostValues,
        borderColor: 'rgb(236, 72, 153)',
        backgroundColor: 'rgba(236, 72, 153, 0.1)',
        tension: 0.3,
        fill: true,
      }],
    },
    options: commonOptions,
  });

  // User Growth Chart
  new Chart(document.getElementById('userGrowthChart'), {
    type: 'bar',
    data: {
      labels: chartLabels,
      datasets: [{
        data: newUsersValues,
        backgroundColor: 'rgba(124, 58, 237, 0.8)',
        borderColor: 'rgb(124, 58, 237)',
        borderWidth: 1,
        borderRadius: 4,
      }],
    },
    options: commonOptions,
  });

  // Quiz Activity Chart
  new Chart(document.getElementById('quizActivityChart'), {
    type: 'line',
    data: {
      labels: chartLabels,
      datasets: [{
        data: quizzesValues,
        borderColor: 'rgb(250, 204, 21)',
        backgroundColor: 'rgba(250, 204, 21, 0.1)',
        tension: 0.3,
        fill: true,
      }],
    },
    options: commonOptions,
  });
  });
</script>

<style lang="scss">
  .charts-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-4);
    margin-bottom: var(--space-6);

    @media (max-width: 1024px) {
      grid-template-columns: 1fr;
    }
  }

  .chart-section {
    min-height: 350px;
  }

  .chart-container {
    height: 250px;
    position: relative;
  }

  .roi-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: var(--space-4);

    @media (max-width: 900px) {
      grid-template-columns: 1fr;
    }
  }

  .roi-card {
    background: var(--color-background);
    border-radius: var(--radius-3);
    padding: var(--space-5);
    text-align: center;
    border: 1px solid var(--color-border);
    transition: all var(--transition-base);

    &:hover {
      border-color: var(--color-primary);
      transform: translateY(-2px);
    }

    &--highlight {
      border-color: var(--color-warning);
      background: linear-gradient(135deg, rgba(250, 204, 21, 0.05), rgba(250, 204, 21, 0.02));
    }
  }

  .roi-card__title {
    font-size: var(--fs-2);
    color: var(--color-text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: var(--space-3);
  }

  .roi-card__value {
    font-size: var(--fs-9);
    font-weight: var(--font-weight-bold);
    color: var(--color-text);
    margin-bottom: var(--space-2);
  }

  .roi-card__description {
    font-size: var(--fs-2);
    color: var(--color-text-muted);
    line-height: 1.5;

    small {
      opacity: 0.7;
    }
  }

  .admin-stat-card--revenue {
    border-color: var(--color-success);
    background: linear-gradient(135deg, rgba(34, 197, 94, 0.05), rgba(34, 197, 94, 0.02));
  }

  .roi-card--revenue {
    border-color: var(--color-success);
    background: linear-gradient(135deg, rgba(34, 197, 94, 0.05), rgba(34, 197, 94, 0.02));
  }

  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--space-4);
    margin-bottom: var(--space-6);
  }

  .stat-breakdown-card {
    background: var(--color-background);
    border-radius: var(--radius-3);
    padding: var(--space-5);
    text-align: center;
    border: 1px solid var(--color-border);
    transition: all var(--transition-base);

    &:hover {
      border-color: var(--color-primary);
      transform: translateY(-2px);
    }
  }

  .stat-breakdown-card__plan {
    font-size: var(--fs-2);
    color: var(--color-text-muted);
    text-transform: capitalize;
    margin-bottom: var(--space-2);
    font-weight: var(--font-weight-medium);
  }

  .stat-breakdown-card__value {
    font-size: var(--fs-8);
    font-weight: var(--font-weight-bold);
    color: var(--color-primary);
    margin-bottom: var(--space-1);
  }

  .stat-breakdown-card__label {
    font-size: var(--fs-2);
    color: var(--color-text-muted);
    margin-bottom: var(--space-2);
  }

  .stat-breakdown-card__subvalue {
    font-size: var(--fs-3);
    color: var(--color-text);
    font-weight: var(--font-weight-medium);
  }
</style>
