---
// ============================================
// ADMIN - GESTION DES QUESTIONS
// ============================================

import AdminLayout from '@/layouts/AdminLayout.astro';

const supabase = (Astro.locals as { supabase?: any }).supabase;

// Param√®tres de filtrage et pagination
const url = Astro.url;
const page = parseInt(url.searchParams.get('page') || '1');
const limit = 20;
const offset = (page - 1) * limit;

const filterUniverse = url.searchParams.get('universe') || '';
const filterDifficulty = url.searchParams.get('difficulty') || '';
const filterApproved = url.searchParams.get('approved') || '';
const searchQuery = url.searchParams.get('q') || '';

// R√©cup√©rer les questions
let questions: any[] = [];
let totalCount = 0;

if (supabase) {
  let query = supabase
    .from('questions')
    .select('*', { count: 'exact' });

  // Filtres
  if (filterUniverse) {
    query = query.eq('universe', filterUniverse);
  }
  if (filterDifficulty) {
    query = query.eq('difficulty', filterDifficulty);
  }
  if (filterApproved === 'true') {
    query = query.eq('is_approved', true);
  } else if (filterApproved === 'false') {
    query = query.eq('is_approved', false);
  }
  if (searchQuery) {
    query = query.ilike('question', `%${searchQuery}%`);
  }

  // Pagination et tri
  query = query
    .order('created_at', { ascending: false })
    .range(offset, offset + limit - 1);

  const { data, count, error } = await query;

  if (!error) {
    questions = data || [];
    totalCount = count || 0;
  }
}

const totalPages = Math.ceil(totalCount / limit);

const universeLabels: Record<string, string> = {
  anime: 'Anime',
  manga: 'Manga',
  comics: 'Comics',
  games: 'Jeux',
  movies: 'Films',
  series: 'S√©ries',
  other: 'Autre',
};

const difficultyLabels: Record<string, string> = {
  easy: 'Facile',
  medium: 'Moyen',
  hard: 'Difficile',
};

// Messages
const successMessage = url.searchParams.get('success');
const errorMessage = url.searchParams.get('error');
---

<AdminLayout title="Gestion des Questions" currentPage="questions">
  {successMessage && (
    <div class="admin-alert admin-alert--success">
      ‚úÖ {decodeURIComponent(successMessage)}
    </div>
  )}

  {errorMessage && (
    <div class="admin-alert admin-alert--error">
      ‚ùå {decodeURIComponent(errorMessage)}
    </div>
  )}

  <section class="admin-section">
    <div class="admin-section__header">
      <h2 class="admin-section__title">
        Questions ({totalCount})
      </h2>
      <a href="/admin/questions/new" class="btn btn--primary">
        <span class="btn__text">+ Nouvelle question</span>
      </a>
    </div>

    <!-- Filtres -->
    <form method="get" class="admin-filters-form">
      <div class="admin-filters">
        <input 
          type="text" 
          name="q" 
          placeholder="Rechercher..." 
          value={searchQuery}
          class="admin-input"
        />

        <select name="universe" class="admin-select">
          <option value="">Tous les univers</option>
          {Object.entries(universeLabels).map(([value, label]) => (
            <option value={value} selected={filterUniverse === value}>{label}</option>
          ))}
        </select>

        <select name="difficulty" class="admin-select">
          <option value="">Toutes difficult√©s</option>
          {Object.entries(difficultyLabels).map(([value, label]) => (
            <option value={value} selected={filterDifficulty === value}>{label}</option>
          ))}
        </select>

        <select name="approved" class="admin-select">
          <option value="">Tous statuts</option>
          <option value="true" selected={filterApproved === 'true'}>Approuv√©es</option>
          <option value="false" selected={filterApproved === 'false'}>En attente</option>
        </select>

        <button type="submit" class="btn btn--secondary">Filtrer</button>
        <a href="/admin/questions" class="btn btn--outline">Reset</a>
      </div>
    </form>

    <!-- Tableau -->
    {questions.length > 0 ? (
      <div class="admin-table-wrapper">
        <table class="admin-table">
          <thead>
            <tr>
              <th class="admin-table__col--wide">Question</th>
              <th>Univers</th>
              <th>Difficult√©</th>
              <th>Source</th>
              <th>Statut</th>
              <th>Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {questions.map((q) => (
              <tr>
                <td>
                  <a href={`/admin/questions/${q.id}`} class="admin-link">
                    {q.question.substring(0, 80)}{q.question.length > 80 ? '...' : ''}
                  </a>
                </td>
                <td>
                  <span class="admin-badge admin-badge--primary">
                    {universeLabels[q.universe] || q.universe}
                  </span>
                </td>
                <td>
                  <span class={`admin-badge admin-badge--${q.difficulty === 'easy' ? 'success' : q.difficulty === 'medium' ? 'warning' : 'error'}`}>
                    {difficultyLabels[q.difficulty] || q.difficulty}
                  </span>
                </td>
                <td>
                  <span class={`admin-badge admin-badge--${q.created_by === 'ia' ? 'info' : 'primary'}`}>
                    {q.created_by === 'ia' ? 'ü§ñ IA' : 'üë§ Admin'}
                  </span>
                </td>
                <td>
                  <span class={`admin-badge admin-badge--${q.is_approved ? 'success' : 'warning'}`}>
                    {q.is_approved ? '‚úÖ Approuv√©e' : '‚è≥ En attente'}
                  </span>
                </td>
                <td>{new Date(q.created_at).toLocaleDateString('fr-FR')}</td>
                <td>
                  <div class="admin-actions">
                    <a href={`/admin/questions/${q.id}`} class="admin-action" title="√âditer">
                      ‚úèÔ∏è
                    </a>
                    <form method="post" action="/api/admin/questions/toggle-approve" class="admin-inline-form">
                      <input type="hidden" name="id" value={q.id} />
                      <input type="hidden" name="approved" value={q.is_approved ? 'false' : 'true'} />
                      <button type="submit" class="admin-action admin-action--success" title={q.is_approved ? 'D√©sapprouver' : 'Approuver'}>
                        {q.is_approved ? '‚ùå' : '‚úÖ'}
                      </button>
                    </form>
                    <form method="post" action="/api/admin/questions/delete" class="admin-inline-form" onsubmit="return confirm('Supprimer cette question ?')">
                      <input type="hidden" name="id" value={q.id} />
                      <button type="submit" class="admin-action admin-action--danger" title="Supprimer">
                        üóëÔ∏è
                      </button>
                    </form>
                  </div>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    ) : (
      <div class="admin-empty">
        <div class="admin-empty__icon">üì≠</div>
        <p class="admin-empty__text">Aucune question trouv√©e</p>
      </div>
    )}

    <!-- Pagination -->
    {totalPages > 1 && (
      <div class="admin-pagination">
        {page > 1 && (
          <a href={`?page=${page - 1}${filterUniverse ? `&universe=${filterUniverse}` : ''}${filterDifficulty ? `&difficulty=${filterDifficulty}` : ''}${filterApproved ? `&approved=${filterApproved}` : ''}${searchQuery ? `&q=${searchQuery}` : ''}`} class="admin-pagination__btn">
            ‚Üê Pr√©c√©dent
          </a>
        )}
        
        <span class="admin-pagination__info">
          Page {page} / {totalPages}
        </span>

        {page < totalPages && (
          <a href={`?page=${page + 1}${filterUniverse ? `&universe=${filterUniverse}` : ''}${filterDifficulty ? `&difficulty=${filterDifficulty}` : ''}${filterApproved ? `&approved=${filterApproved}` : ''}${searchQuery ? `&q=${searchQuery}` : ''}`} class="admin-pagination__btn">
            Suivant ‚Üí
          </a>
        )}
      </div>
    )}
  </section>
</AdminLayout>

<style lang="scss">
  .admin-alert {
    padding: var(--space-4);
    border-radius: var(--radius-2);
    margin-bottom: var(--space-4);
    font-weight: var(--font-weight-medium);

    &--success {
      background: rgba(34, 197, 94, 0.15);
      color: var(--color-success);
      border: 1px solid var(--color-success);
    }

    &--error {
      background: rgba(239, 68, 68, 0.15);
      color: var(--color-error);
      border: 1px solid var(--color-error);
    }
  }

  .admin-filters-form {
    margin-bottom: var(--space-4);
  }

  .admin-input,
  .admin-select {
    padding: var(--space-2) var(--space-3);
    border-radius: var(--radius-2);
    border: 1px solid var(--color-border);
    background: var(--color-background);
    color: var(--color-text);
    font-size: var(--fs-2);

    &:focus {
      outline: none;
      border-color: var(--color-primary);
    }
  }

  .admin-input {
    min-width: 200px;
  }

  .admin-table-wrapper {
    overflow-x: auto;
  }

  .admin-link {
    color: var(--color-text);
    text-decoration: none;

    &:hover {
      color: var(--color-primary);
      text-decoration: underline;
    }
  }

  .admin-pagination__info {
    color: var(--color-text-muted);
    font-size: var(--fs-2);
  }
</style>
